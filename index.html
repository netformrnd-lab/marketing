<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>íŒ€ ì›Œí¬ìŠ¤í˜ì´ìŠ¤ - ë¸Œëœë“œë§ˆì¼€íŒ…íŒ€</title>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>
  <link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css" rel="stylesheet">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, sans-serif; }
    button { font-family: inherit; cursor: pointer; }
    input:focus, textarea:focus { outline: none; border-color: #3182F6 !important; }
    select:focus { outline: none; }
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-thumb { background: #D1D6DB; border-radius: 3px; }
    @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }
    .menu-item { transition: all 0.15s; }
    .menu-item:hover { background: rgba(255,255,255,0.1); }
    .task-row { transition: background 0.15s; }
    .task-row:hover { background: #F7F8FA; }
    .drag-over { background: #EBF4FF !important; }
    .loading-spinner { 
      width: 40px; height: 40px; border: 3px solid #E5E8EB; 
      border-top-color: #3182F6; border-radius: 50%; 
      animation: spin 1s linear infinite; 
    }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body>
  <div id="root"></div>
  
  <script>
    // Firebase ì´ˆê¸°í™”
    const firebaseConfig = {
      apiKey: "AIzaSyBVc-4vKB3KMQo422y4FofSRhnF2hJcPOQ",
      authDomain: "mktt-764a6.firebaseapp.com",
      projectId: "mktt-764a6",
      storageBucket: "mktt-764a6.firebasestorage.app",
      messagingSenderId: "451380847332",
      appId: "1:451380847332:web:903cad94de2785dc00c2f1",
      measurementId: "G-KEW7ZC2GK3"
    };
    
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const storage = firebase.storage();
  </script>
  
  <script type="text/babel">
    const { useState, useMemo, useEffect } = React;

    // ============ ì•„ì´ì½˜ ì»´í¬ë„ŒíŠ¸ ============
    const Icon = ({ name, size = 20, color = "currentColor" }) => {
      const icons = {
        layout: <path d="M3 3h7v9H3V3zm11 0h7v5h-7V3zm0 9h7v9h-7v-9zM3 16h7v5H3v-5z" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>,
        clipboard: <><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2" fill="none" stroke={color} strokeWidth="2"/><rect x="8" y="2" width="8" height="4" rx="1" ry="1" fill="none" stroke={color} strokeWidth="2"/></>,
        folder: <><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z" fill="none" stroke={color} strokeWidth="2"/></>,
        calendar: <><rect x="3" y="4" width="18" height="18" rx="2" ry="2" fill="none" stroke={color} strokeWidth="2"/><line x1="16" y1="2" x2="16" y2="6" stroke={color} strokeWidth="2"/><line x1="8" y1="2" x2="8" y2="6" stroke={color} strokeWidth="2"/><line x1="3" y1="10" x2="21" y2="10" stroke={color} strokeWidth="2"/></>,
        plus: <><line x1="12" y1="5" x2="12" y2="19" stroke={color} strokeWidth="2" strokeLinecap="round"/><line x1="5" y1="12" x2="19" y2="12" stroke={color} strokeWidth="2" strokeLinecap="round"/></>,
        check: <polyline points="20 6 9 17 4 12" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>,
        x: <><line x1="18" y1="6" x2="6" y2="18" stroke={color} strokeWidth="2" strokeLinecap="round"/><line x1="6" y1="6" x2="18" y2="18" stroke={color} strokeWidth="2" strokeLinecap="round"/></>,
        chevronLeft: <polyline points="15 18 9 12 15 6" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>,
        chevronRight: <polyline points="9 18 15 12 9 6" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>,
        chevronDown: <polyline points="6 9 12 15 18 9" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>,
        user: <><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2" fill="none" stroke={color} strokeWidth="2"/><circle cx="12" cy="7" r="4" fill="none" stroke={color} strokeWidth="2"/></>,
        search: <><circle cx="11" cy="11" r="8" fill="none" stroke={color} strokeWidth="2"/><line x1="21" y1="21" x2="16.65" y2="16.65" stroke={color} strokeWidth="2" strokeLinecap="round"/></>,
        trash: <><polyline points="3 6 5 6 21 6" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round"/></>,
        edit: <><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7" fill="none" stroke={color} strokeWidth="2"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z" fill="none" stroke={color} strokeWidth="2"/></>,
        bookmark: <path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>,
        bookmarkFill: <path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z" fill={color} stroke={color} strokeWidth="2"/>,
        message: <><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z" fill="none" stroke={color} strokeWidth="2"/></>,
        send: <><line x1="22" y1="2" x2="11" y2="13" stroke={color} strokeWidth="2"/><polygon points="22 2 15 22 11 13 2 9 22 2" fill="none" stroke={color} strokeWidth="2" strokeLinejoin="round"/></>,
        users: <><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2" fill="none" stroke={color} strokeWidth="2"/><circle cx="9" cy="7" r="4" fill="none" stroke={color} strokeWidth="2"/><path d="M23 21v-2a4 4 0 0 0-3-3.87" fill="none" stroke={color} strokeWidth="2"/><path d="M16 3.13a4 4 0 0 1 0 7.75" fill="none" stroke={color} strokeWidth="2"/></>,
        grip: <><circle cx="9" cy="5" r="1" fill={color}/><circle cx="9" cy="12" r="1" fill={color}/><circle cx="9" cy="19" r="1" fill={color}/><circle cx="15" cy="5" r="1" fill={color}/><circle cx="15" cy="12" r="1" fill={color}/><circle cx="15" cy="19" r="1" fill={color}/></>,
        circle: <circle cx="12" cy="12" r="10" fill="none" stroke={color} strokeWidth="2"/>,
        checkCircle: <><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14" fill="none" stroke={color} strokeWidth="2"/><polyline points="22 4 12 14.01 9 11.01" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/></>,
        pause: <><circle cx="12" cy="12" r="10" fill="none" stroke={color} strokeWidth="2"/><line x1="10" y1="15" x2="10" y2="9" stroke={color} strokeWidth="2" strokeLinecap="round"/><line x1="14" y1="15" x2="14" y2="9" stroke={color} strokeWidth="2" strokeLinecap="round"/></>,
        fileText: <><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" fill="none" stroke={color} strokeWidth="2"/><polyline points="14 2 14 8 20 8" fill="none" stroke={color} strokeWidth="2"/><line x1="16" y1="13" x2="8" y2="13" stroke={color} strokeWidth="2"/><line x1="16" y1="17" x2="8" y2="17" stroke={color} strokeWidth="2"/><line x1="10" y1="9" x2="8" y2="9" stroke={color} strokeWidth="2"/></>,
        pin: <><line x1="12" y1="17" x2="12" y2="22" stroke={color} strokeWidth="2" strokeLinecap="round"/><path d="M5 17h14v-1.76a2 2 0 0 0-1.11-1.79l-1.78-.9A2 2 0 0 1 15 10.76V6h1a2 2 0 0 0 0-4H8a2 2 0 0 0 0 4h1v4.76a2 2 0 0 1-1.11 1.79l-1.78.9A2 2 0 0 0 5 15.24Z" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/></>,
        paperclip: <><path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/></>,
        refresh: <><path d="M23 4v6h-6" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/><path d="M1 20v-6h6" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/></>,
      };
      return <svg width={size} height={size} viewBox="0 0 24 24" style={{display:'block'}}>{icons[name]}</svg>;
    };

    // ============ ê³µí†µ ë°ì´í„° ============
    const TEAM_MEMBERS = [
      { id: 1, name: 'ê¹€í˜œì˜', initial: 'í˜œ', color: '#3182F6', role: 'íŒ€ì¥' },
      { id: 2, name: 'ì´ìˆ˜ì§„', initial: 'ìˆ˜', color: '#00C471', role: 'ëŒ€ë¦¬' },
      { id: 3, name: 'ë°•ì¤€í˜¸', initial: 'ì¤€', color: '#F97316', role: 'ì£¼ì„' },
      { id: 4, name: 'ìµœë¯¼ì„œ', initial: 'ë¯¼', color: '#8B5CF6', role: 'ì‚¬ì›' },
      { id: 5, name: 'ì •ë‹¤ì€', initial: 'ë‹¤', color: '#EC4899', role: 'ì‚¬ì›' },
    ];

    const BRANDS = [
      { id: 1, name: 'Pour ê³µë²•', color: '#3182F6' },
      { id: 2, name: 'Pour ì†”ë£¨ì…˜', color: '#00C471' },
      { id: 3, name: 'ì•„íŒŒíŠ¸ìŠ¤í€˜ì–´', color: '#F97316' },
    ];

    const STATUS_OPTIONS = [
      { id: 'progress', label: 'ì§„í–‰ì¤‘', color: '#3182F6', bg: '#EBF4FF', icon: 'circle' },
      { id: 'complete', label: 'ì™„ë£Œ', color: '#00C471', bg: '#ECFDF5', icon: 'checkCircle' },
      { id: 'hold', label: 'ë³´ë¥˜', color: '#F59E0B', bg: '#FFFBEB', icon: 'pause' },
    ];

    // ============ ìœ í‹¸ë¦¬í‹° ============
    const formatDate = (date) => {
      const d = new Date(date);
      return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
    };

    const formatShortDate = (dateStr) => {
      if (!dateStr) return '';
      const d = new Date(dateStr);
      return `${d.getMonth() + 1}ì›” ${d.getDate()}ì¼`;
    };

    const formatDateTime = (dateStr) => {
      const d = new Date(dateStr);
      const now = new Date();
      const diffMs = now - d;
      const diffMins = Math.floor(diffMs / 60000);
      const diffHours = Math.floor(diffMs / 3600000);
      const diffDays = Math.floor(diffMs / 86400000);
      if (diffMins < 1) return 'ë°©ê¸ˆ ì „';
      if (diffMins < 60) return `${diffMins}ë¶„ ì „`;
      if (diffHours < 24) return `${diffHours}ì‹œê°„ ì „`;
      if (diffDays < 7) return `${diffDays}ì¼ ì „`;
      return `${d.getMonth() + 1}/${d.getDate()}`;
    };

    const getMonthDates = (year, month) => {
      const firstDay = new Date(year, month, 1);
      const lastDay = new Date(year, month + 1, 0);
      const startPadding = (firstDay.getDay() + 6) % 7;
      const dates = [];
      for (let i = startPadding - 1; i >= 0; i--) {
        const d = new Date(year, month, -i);
        dates.push({ date: formatDate(d), isCurrentMonth: false, day: d.getDate() });
      }
      for (let i = 1; i <= lastDay.getDate(); i++) {
        const d = new Date(year, month, i);
        dates.push({ date: formatDate(d), isCurrentMonth: true, day: d.getDate() });
      }
      const remaining = 42 - dates.length;
      for (let i = 1; i <= remaining; i++) {
        const d = new Date(year, month + 1, i);
        dates.push({ date: formatDate(d), isCurrentMonth: false, day: d.getDate() });
      }
      return dates;
    };

    const today = formatDate(new Date());

    // ============ Firebase ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ ============
    const FirebaseService = {
      // ì»¬ë ‰ì…˜ì—ì„œ ëª¨ë“  ë¬¸ì„œ ê°€ì ¸ì˜¤ê¸°
      async getAll(collection) {
        try {
          const snapshot = await db.collection(collection).get();
          return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        } catch (error) {
          console.error(`Error getting ${collection}:`, error);
          return [];
        }
      },
      
      // ë¬¸ì„œ ì €ì¥ (upsert)
      async save(collection, id, data) {
        try {
          await db.collection(collection).doc(String(id)).set(data, { merge: true });
        } catch (error) {
          console.error(`Error saving to ${collection}:`, error);
        }
      },
      
      // ë¬¸ì„œ ì‚­ì œ
      async delete(collection, id) {
        try {
          await db.collection(collection).doc(String(id)).delete();
        } catch (error) {
          console.error(`Error deleting from ${collection}:`, error);
        }
      },
      
      // ì „ì²´ ì»¬ë ‰ì…˜ ë™ê¸°í™” (ë°°ì—´ì„ í•œ ë²ˆì— ì €ì¥)
      async syncCollection(collection, items) {
        try {
          const batch = db.batch();
          items.forEach(item => {
            const ref = db.collection(collection).doc(String(item.id));
            batch.set(ref, item);
          });
          await batch.commit();
        } catch (error) {
          console.error(`Error syncing ${collection}:`, error);
        }
      },
      
      // ë‹¨ì¼ ë¬¸ì„œ ì €ì¥ (settings ë“±)
      async saveDoc(collection, docId, data) {
        try {
          await db.collection(collection).doc(docId).set(data, { merge: true });
        } catch (error) {
          console.error(`Error saving doc:`, error);
        }
      },
      
      // ë‹¨ì¼ ë¬¸ì„œ ê°€ì ¸ì˜¤ê¸°
      async getDoc(collection, docId) {
        try {
          const doc = await db.collection(collection).doc(docId).get();
          return doc.exists ? doc.data() : null;
        } catch (error) {
          console.error(`Error getting doc:`, error);
          return null;
        }
      },
      
      // íŒŒì¼ ì—…ë¡œë“œ
      async uploadFile(file, path, onProgress) {
        try {
          const ref = storage.ref().child(path);
          const uploadTask = ref.put(file);
          
          return new Promise((resolve, reject) => {
            // 30ì´ˆ íƒ€ì„ì•„ì›ƒ
            const timeout = setTimeout(() => {
              uploadTask.cancel();
              reject(new Error('ì—…ë¡œë“œ ì‹œê°„ ì´ˆê³¼'));
            }, 30000);
            
            uploadTask.on('state_changed',
              (snapshot) => {
                const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                if (onProgress) onProgress(progress);
                console.log('Upload progress:', progress.toFixed(1) + '%');
              },
              (error) => {
                clearTimeout(timeout);
                console.error('Upload error:', error);
                reject(error);
              },
              async () => {
                clearTimeout(timeout);
                const url = await uploadTask.snapshot.ref.getDownloadURL();
                resolve({ url, name: file.name, size: file.size, type: file.type });
              }
            );
          });
        } catch (error) {
          console.error('Error uploading file:', error);
          return null;
        }
      },
      
      // íŒŒì¼ ì‚­ì œ
      async deleteFile(path) {
        try {
          await storage.ref().child(path).delete();
        } catch (error) {
          console.error('Error deleting file:', error);
        }
      }
    };

    // ============ ìƒ˜í”Œ ë°ì´í„° (ì´ˆê¸° ë°ì´í„°ê°€ ì—†ì„ ë•Œ ì‚¬ìš©) ============
    const INITIAL_PROJECTS = [
      { id: 101, brandId: 1, title: '2025 ì‹ ë…„ ìº í˜ì¸', description: 'ìƒˆí•´ë§ì´ ë¸Œëœë“œ í”„ë¡œëª¨ì…˜ ìº í˜ì¸ ê¸°íš ë° ì‹¤í–‰', status: 'progress', createdDate: '2024-12-15', creatorId: 1, memberIds: [1, 3], comments: [
        { id: 1, memberId: 1, text: 'í‚¥ì˜¤í”„ ë¯¸íŒ… ì™„ë£Œ! ê°ì ì—…ë¬´ í™•ì¸í•´ì£¼ì„¸ìš”', createdAt: '2024-12-20T09:00:00' },
        { id: 2, memberId: 3, text: 'ë””ìì¸ ì‹œì•ˆ ì‘ì—… ì‹œì‘í•©ë‹ˆë‹¤', createdAt: '2024-12-21T14:00:00' },
      ]},
      { id: 102, brandId: 2, title: 'SNS ì½˜í…ì¸  ë¦¬ë‰´ì–¼', description: 'ì¸ìŠ¤íƒ€ê·¸ë¨, ìœ íŠœë¸Œ ì±„ë„ ì½˜í…ì¸  ì „ëµ ì¬ìˆ˜ë¦½', status: 'progress', createdDate: '2024-12-10', creatorId: 2, memberIds: [1, 2], comments: [] },
      { id: 103, brandId: 1, title: 'ë¸Œëœë“œë¶ ì œì‘', description: 'Pour ê³µë²• ë¸Œëœë“œ ì•„ì´ë´í‹°í‹° ê°€ì´ë“œë¼ì¸ ë¬¸ì„œí™”', status: 'hold', createdDate: '2024-11-20', creatorId: 1, memberIds: [1], comments: [] },
      { id: 104, brandId: 3, title: 'ê³ ê° í›„ê¸° ìº í˜ì¸', description: 'ì…ì£¼ë¯¼ í›„ê¸° ìˆ˜ì§‘ ë° ì½˜í…ì¸ í™”', status: 'complete', createdDate: '2024-11-01', completedDate: '2024-12-20', creatorId: 3, memberIds: [3, 4], comments: [] },
    ];

    const INITIAL_TASKS = [
      { id: 1, projectId: 101, title: 'ìº í˜ì¸ ì»¨ì…‰ ê¸°íšì„œ ì‘ì„±', memberId: 1, date: '2024-12-23', completed: true, order: 0, note: '', bookmark: false },
      { id: 2, projectId: 101, title: 'ë””ìì¸ ì‹œì•ˆ ì œì‘', memberId: 3, date: '2024-12-26', completed: false, order: 1, note: '', bookmark: false },
      { id: 10, projectId: 101, title: 'ë¸Œëœë“œ ê°€ì´ë“œë¼ì¸ ê²€í† ', memberId: 1, date: today, completed: false, order: 0, note: 'ë””ìì¸íŒ€ê³¼ í˜‘ì˜ í•„ìš”\n\n- ë¡œê³  ì‚¬ìš© ê·œì • í™•ì¸\n- ì»¬ëŸ¬ ê°€ì´ë“œ ê²€í† \n- í°íŠ¸ ì‚¬ìš© ë²”ìœ„ ë…¼ì˜', bookmark: true },
      { id: 11, projectId: 102, title: 'SNS ì½˜í…ì¸  ê¸°íšíšŒì˜', memberId: 1, date: today, completed: false, order: 1, note: 'ì¸ìŠ¤íƒ€ê·¸ë¨ ë¦´ìŠ¤ ìœ„ì£¼ë¡œ ë…¼ì˜', bookmark: false },
      { id: 12, projectId: 103, title: 'ê´‘ê³  ì†Œì¬ ë””ìì¸ í”¼ë“œë°±', memberId: 1, date: today, completed: false, order: 2, note: '', bookmark: false },
      { id: 13, projectId: 101, title: 'ì‹ ê·œ ìº í˜ì¸ ì»¨ì…‰ íšŒì˜', memberId: 1, date: today, completed: false, order: 3, note: '', bookmark: false },
      { id: 14, projectId: 101, title: 'ì›”ê°„ ë³´ê³ ì„œ ì‘ì„±', memberId: 1, date: today, completed: false, order: 4, note: 'ì´ë²ˆ ì£¼ ê¸ˆìš”ì¼ê¹Œì§€\n\n[ ] ì§€ë‚œë‹¬ ì„±ê³¼ ì •ë¦¬\n[ ] ì´ë²ˆë‹¬ ê³„íš ì‘ì„±\n[ ] KPI ë¶„ì„', bookmark: true },
      { id: 15, projectId: 102, title: 'í˜‘ë ¥ì‚¬ ë¯¸íŒ… ì¤€ë¹„', memberId: 1, date: today, completed: false, order: 5, note: '', bookmark: false },
      { id: 16, projectId: 103, title: 'ìº í˜ì¸ ì„±ê³¼ ë¶„ì„', memberId: 1, date: today, completed: false, order: 6, note: '', bookmark: false },
    ];

    const INITIAL_FIXED_TASKS = [
      { id: 1, title: 'ì¼ì¼ ë³´ê³ ì„œ ì‘ì„±', projectId: 1, routineType: 'daily', completedDates: [] },
      { id: 2, title: 'ì´ë©”ì¼ í™•ì¸ ë° íšŒì‹ ', projectId: null, routineType: 'daily', completedDates: [] },
      { id: 3, title: 'ì£¼ê°„ íšŒì˜ ì¤€ë¹„', projectId: 1, routineType: 'weekly', completedDates: [] },
      { id: 4, title: 'íŒ€ ë¯¸íŒ… ì°¸ì„', projectId: null, routineType: 'weekly', completedDates: [] },
      { id: 5, title: 'ì›”ê°„ ë³´ê³ ì„œ ì‘ì„±', projectId: 1, routineType: 'monthly', completedDates: [] },
      { id: 6, title: 'ì›”ê°„ KPI ì ê²€', projectId: null, routineType: 'monthly', completedDates: [] },
    ];

    // ============ ë©”ì¸ ì•± ============
    function TeamWorkApp() {
      const [activeTab, setActiveTab] = useState('worklog');
      const [currentUser] = useState(TEAM_MEMBERS[0]);
      const [projects, setProjects] = useState([]);
      const [tasks, setTasks] = useState([]);
      const [fixedTasks, setFixedTasks] = useState([]);
      const [isLoading, setIsLoading] = useState(true);
      const [isSaving, setIsSaving] = useState(false);
      
      // Firebaseì—ì„œ ì´ˆê¸° ë°ì´í„° ë¡œë“œ
      useEffect(() => {
        const loadData = async () => {
          setIsLoading(true);
          try {
            // í”„ë¡œì íŠ¸ ë¡œë“œ
            const loadedProjects = await FirebaseService.getAll('projects');
            if (loadedProjects.length > 0) {
              setProjects(loadedProjects.map(p => ({ ...p, id: Number(p.id) || p.id })));
            } else {
              // ì´ˆê¸° ë°ì´í„° ì €ì¥
              setProjects(INITIAL_PROJECTS);
              await FirebaseService.syncCollection('projects', INITIAL_PROJECTS);
            }
            
            // ì—…ë¬´ ë¡œë“œ
            const loadedTasks = await FirebaseService.getAll('tasks');
            if (loadedTasks.length > 0) {
              setTasks(loadedTasks.map(t => ({ ...t, id: Number(t.id) || t.id })));
            } else {
              setTasks(INITIAL_TASKS);
              await FirebaseService.syncCollection('tasks', INITIAL_TASKS);
            }
            
            // ë£¨í‹´ ì—…ë¬´ ë¡œë“œ
            const loadedFixedTasks = await FirebaseService.getAll('fixedTasks');
            if (loadedFixedTasks.length > 0) {
              setFixedTasks(loadedFixedTasks.map(t => ({ ...t, id: Number(t.id) || t.id })));
            } else {
              setFixedTasks(INITIAL_FIXED_TASKS);
              await FirebaseService.syncCollection('fixedTasks', INITIAL_FIXED_TASKS);
            }
            
            // ê¸°íƒ€ ì„¤ì • ë¡œë“œ (ì˜¤ëŠ˜ì˜ í•œë§ˆë””, ê³ ì • ë©”ëª¨ ë“±)
            const settings = await FirebaseService.getDoc('settings', 'dailyNotes');
            if (settings) {
              // dailyNotes ìƒíƒœê°€ ìˆë‹¤ë©´ ì—¬ê¸°ì„œ ì„¤ì •
            }
            
          } catch (error) {
            console.error('Error loading data:', error);
            // ì—ëŸ¬ ì‹œ ì´ˆê¸° ë°ì´í„° ì‚¬ìš©
            setProjects(INITIAL_PROJECTS);
            setTasks(INITIAL_TASKS);
            setFixedTasks(INITIAL_FIXED_TASKS);
          }
          setIsLoading(false);
        };
        
        loadData();
      }, []);
      
      // í”„ë¡œì íŠ¸ ë³€ê²½ ì‹œ Firebaseì— ì €ì¥
      useEffect(() => {
        if (!isLoading && projects.length > 0) {
          FirebaseService.syncCollection('projects', projects);
        }
      }, [projects, isLoading]);
      
      // ì—…ë¬´ ë³€ê²½ ì‹œ Firebaseì— ì €ì¥
      useEffect(() => {
        if (!isLoading && tasks.length > 0) {
          FirebaseService.syncCollection('tasks', tasks);
        }
      }, [tasks, isLoading]);
      
      // ë£¨í‹´ ì—…ë¬´ ë³€ê²½ ì‹œ Firebaseì— ì €ì¥
      useEffect(() => {
        if (!isLoading && fixedTasks.length > 0) {
          FirebaseService.syncCollection('fixedTasks', fixedTasks);
        }
      }, [fixedTasks, isLoading]);
      const [readComments, setReadComments] = useState(() => {
        const init = {};
        INITIAL_PROJECTS.forEach(p => { init[p.id] = p.comments.filter(c => c.memberId === 1).length; });
        return init;
      });
      const [movedTasksCount, setMovedTasksCount] = useState(0);

      // ë¯¸ì™„ë£Œ ì—…ë¬´ ìë™ ì´ë™ (ë°ì´í„° ë¡œë“œ ì™„ë£Œ í›„ ì‹¤í–‰)
      useEffect(() => {
        if (isLoading || tasks.length === 0) return;
        
        const todayStr = formatDate(new Date());
        let movedCount = 0;
        
        setTasks(prev => prev.map(task => {
          // ì˜¤ëŠ˜ ì´ì „ ë‚ ì§œì´ê³ , ì™„ë£Œë˜ì§€ ì•Šì€ ì—…ë¬´ë§Œ ì´ë™
          if (task.date < todayStr && !task.completed) {
            movedCount++;
            return { ...task, date: todayStr };
          }
          return task;
        }));
        
        if (movedCount > 0) {
          setMovedTasksCount(movedCount);
          // 3ì´ˆ í›„ ì•Œë¦¼ ìˆ¨ê¸°ê¸°
          setTimeout(() => setMovedTasksCount(0), 4000);
        }
      }, [isLoading]);

      const totalUnread = useMemo(() => projects.reduce((sum, p) => sum + Math.max(0, p.comments.length - (readComments[p.id] || 0)), 0), [projects, readComments]);

      const MENU = [
        { id: 'worklog', label: 'ì—…ë¬´ì¼ì§€', icon: 'clipboard' },
        { id: 'project', label: 'í”„ë¡œì íŠ¸', icon: 'folder', badge: totalUnread },
        { id: 'calendar', label: 'ì „ì²´ì—…ë¬´', icon: 'calendar' },
        { id: 'growthboard', label: 'ê·¸ë¡œìŠ¤ë³´ë“œ', icon: 'layout' },
      ];

      // ë¡œë”© í™”ë©´
      if (isLoading) {
        return (
          <div style={{ display: 'flex', flexDirection: 'column', alignItems: 'center', justifyContent: 'center', minHeight: '100vh', background: '#F7F8FA', gap: 20 }}>
            <div className="loading-spinner"></div>
            <div style={{ textAlign: 'center' }}>
              <p style={{ fontSize: 16, fontWeight: 600, color: '#191F28', marginBottom: 4 }}>ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
              <p style={{ fontSize: 13, color: '#8B95A1' }}>ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”</p>
            </div>
          </div>
        );
      }

      return (
        <div style={{ display: 'flex', minHeight: '100vh', background: '#F7F8FA' }}>
          {/* ì €ì¥ ì¤‘ í‘œì‹œ */}
          {isSaving && (
            <div style={{ position: 'fixed', bottom: 20, right: 20, background: '#191F28', color: 'white', padding: '10px 16px', borderRadius: 8, fontSize: 13, display: 'flex', alignItems: 'center', gap: 8, zIndex: 9999 }}>
              <div style={{ width: 14, height: 14, border: '2px solid rgba(255,255,255,0.3)', borderTopColor: 'white', borderRadius: '50%', animation: 'spin 1s linear infinite' }}></div>
              ì €ì¥ ì¤‘...
            </div>
          )}
          
          {/* ë¯¸ì™„ë£Œ ì—…ë¬´ ì´ë™ ì•Œë¦¼ í† ìŠ¤íŠ¸ */}
          {movedTasksCount > 0 && (
            <div style={{ position: 'fixed', top: 20, left: '50%', transform: 'translateX(-50%)', background: '#191F28', color: 'white', padding: '14px 24px', borderRadius: 12, boxShadow: '0 8px 24px rgba(0,0,0,0.2)', zIndex: 9999, display: 'flex', alignItems: 'center', gap: 10, animation: 'slideIn 0.3s ease' }}>
              <span style={{ fontSize: 18 }}>ğŸ“‹</span>
              <span style={{ fontSize: 14, fontWeight: 500 }}>ì–´ì œ ë¯¸ì™„ë£Œëœ ì—…ë¬´ <strong style={{ color: '#3182F6' }}>{movedTasksCount}ê±´</strong>ì´ ì˜¤ëŠ˜ë¡œ ì´ë™ë˜ì—ˆìŠµë‹ˆë‹¤</span>
            </div>
          )}
          
          {/* ì‚¬ì´ë“œë°” */}
          <aside style={{ width: 240, background: 'linear-gradient(180deg, #1B1D21 0%, #2C2F36 100%)', display: 'flex', flexDirection: 'column', flexShrink: 0 }}>
            <div style={{ padding: '24px 20px', borderBottom: '1px solid rgba(255,255,255,0.08)' }}>
              <div style={{ display: 'flex', alignItems: 'center', gap: 12 }}>
                <div style={{ width: 40, height: 40, borderRadius: 12, background: 'linear-gradient(135deg, #3182F6, #006FEE)', display: 'flex', alignItems: 'center', justifyContent: 'center' }}>
                  <Icon name="layout" size={22} color="white" />
                </div>
                <div>
                  <h1 style={{ fontSize: 16, fontWeight: 700, color: 'white' }}>íŒ€ ì›Œí¬ìŠ¤í˜ì´ìŠ¤</h1>
                  <p style={{ fontSize: 12, color: 'rgba(255,255,255,0.5)' }}>ë¸Œëœë“œë§ˆì¼€íŒ…íŒ€</p>
                </div>
              </div>
            </div>

            <nav style={{ flex: 1, padding: '16px 12px' }}>
              {MENU.map(item => {
                const isActive = activeTab === item.id;
                return (
                  <button key={item.id} className="menu-item" onClick={() => setActiveTab(item.id)} style={{ display: 'flex', alignItems: 'center', gap: 12, width: '100%', padding: '14px 16px', marginBottom: 4, borderRadius: 12, border: 'none', background: isActive ? 'rgba(49, 130, 246, 0.2)' : 'transparent', textAlign: 'left' }}>
                    <Icon name={item.icon} size={20} color={isActive ? '#3182F6' : 'rgba(255,255,255,0.6)'} />
                    <span style={{ flex: 1, fontSize: 15, fontWeight: isActive ? 600 : 500, color: isActive ? 'white' : 'rgba(255,255,255,0.7)' }}>{item.label}</span>
                    {item.badge > 0 && <span style={{ minWidth: 20, height: 20, borderRadius: 10, background: '#F04452', color: 'white', fontSize: 11, fontWeight: 700, display: 'flex', alignItems: 'center', justifyContent: 'center', padding: '0 6px' }}>{item.badge}</span>}
                  </button>
                );
              })}
            </nav>

            <div style={{ padding: '16px 20px', borderTop: '1px solid rgba(255,255,255,0.08)', display: 'flex', alignItems: 'center', gap: 12 }}>
              <div style={{ width: 36, height: 36, borderRadius: '50%', background: currentUser.color, color: 'white', display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: 14, fontWeight: 700 }}>{currentUser.initial}</div>
              <div>
                <p style={{ fontSize: 14, fontWeight: 600, color: 'white' }}>{currentUser.name}</p>
                <p style={{ fontSize: 12, color: 'rgba(255,255,255,0.5)' }}>{currentUser.role}</p>
              </div>
            </div>
          </aside>

          {/* ë©”ì¸ */}
          <main style={{ flex: 1, overflow: 'auto', display: 'flex', flexDirection: 'column' }}>
            <div style={{ flex: 1, display: activeTab === 'worklog' ? 'flex' : 'none', flexDirection: 'column' }}>
              <WorkLogTab tasks={tasks} setTasks={setTasks} currentUser={currentUser} fixedTasks={fixedTasks} setFixedTasks={setFixedTasks} projects={projects} />
            </div>
            <div style={{ flex: 1, display: activeTab === 'project' ? 'flex' : 'none', flexDirection: 'column' }}>
              <ProjectTab projects={projects} setProjects={setProjects} tasks={tasks} setTasks={setTasks} currentUser={currentUser} readComments={readComments} setReadComments={setReadComments} />
            </div>
            <div style={{ flex: 1, display: activeTab === 'calendar' ? 'flex' : 'none', flexDirection: 'column' }}>
              <CalendarTab tasks={tasks} setTasks={setTasks} projects={projects} currentUser={currentUser} />
            </div>
            <div style={{ flex: 1, display: activeTab === 'growthboard' ? 'flex' : 'none', flexDirection: 'column' }}>
              <GrowthBoardTab tasks={tasks} projects={projects} currentUser={currentUser} />
            </div>
          </main>
        </div>
      );
    }

    // ============ ì—…ë¬´ì¼ì§€ íƒ­ ============
    function WorkLogTab({ tasks, setTasks, currentUser, fixedTasks, setFixedTasks, projects }) {
      const [selectedDate, setSelectedDate] = useState(today);
      const [currentMonth, setCurrentMonth] = useState({ year: new Date().getFullYear(), month: new Date().getMonth() });
      const [selectedProject, setSelectedProject] = useState(null);
      const [showAddModal, setShowAddModal] = useState(false);
      const [editingTask, setEditingTask] = useState(null);
      const [searchQuery, setSearchQuery] = useState('');
      const [selectedTaskForNote, setSelectedTaskForNote] = useState(null);
      const [draggedTask, setDraggedTask] = useState(null);
      const [dragOverId, setDragOverId] = useState(null);
      
      // ë£¨í‹´ ì—…ë¬´ UI ìƒíƒœ
      const [showAddFixedModal, setShowAddFixedModal] = useState(false);
      const [addRoutineType, setAddRoutineType] = useState('daily');

      const myTasks = useMemo(() => tasks.filter(t => t.memberId === currentUser.id), [tasks, currentUser]);
      const monthDates = useMemo(() => getMonthDates(currentMonth.year, currentMonth.month), [currentMonth]);
      const filteredTasks = useMemo(() => {
        return myTasks
          .filter(t => t.date === selectedDate)
          .filter(t => !searchQuery || t.title.toLowerCase().includes(searchQuery.toLowerCase()))
          .filter(t => selectedProject === null || t.projectId === selectedProject || (selectedProject === 0 && !t.projectId))
          .sort((a, b) => a.order - b.order);
      }, [myTasks, selectedDate, searchQuery, selectedProject]);
      const taskCountByDate = useMemo(() => { const c = {}; myTasks.forEach(t => { c[t.date] = (c[t.date] || 0) + 1; }); return c; }, [myTasks]);
      
      // ì£¼/ì›” ì‹œì‘ì¼ ê³„ì‚° í—¬í¼
      const getWeekStart = (dateStr) => {
        const d = new Date(dateStr);
        const day = d.getDay();
        const diff = d.getDate() - day + (day === 0 ? -6 : 1);
        return formatDate(new Date(d.setDate(diff)));
      };
      const getMonthStart = (dateStr) => dateStr.slice(0, 7) + '-01';
      const getCompletionKey = (routineType, dateStr) => {
        if (routineType === 'weekly') return getWeekStart(dateStr);
        if (routineType === 'monthly') return getMonthStart(dateStr);
        return dateStr;
      };
      
      const stats = useMemo(() => { 
        const dt = myTasks.filter(t => t.date === selectedDate); 
        const comp = dt.filter(t => t.completed).length;
        // ì¼ì¼ ë£¨í‹´ë§Œ ì§„í–‰ë¥ ì— í¬í•¨
        const dailyRoutines = fixedTasks.filter(t => t.routineType === 'daily');
        const dailyComp = dailyRoutines.filter(t => t.completedDates.includes(selectedDate)).length;
        const total = dt.length + dailyRoutines.length;
        const totalComp = comp + dailyComp;
        return { total, completed: totalComp, rate: total > 0 ? Math.round((totalComp / total) * 100) : 0 }; 
      }, [myTasks, selectedDate, fixedTasks]);

      const moveMonth = (dir) => setCurrentMonth(prev => { let m = prev.month + (dir === 'prev' ? -1 : 1), y = prev.year; if (m < 0) { m = 11; y--; } if (m > 11) { m = 0; y++; } return { year: y, month: m }; });
      const toggleComplete = (id) => setTasks(prev => prev.map(t => t.id === id ? { ...t, completed: !t.completed } : t));
      const toggleBookmark = (id) => setTasks(prev => prev.map(t => t.id === id ? { ...t, bookmark: !t.bookmark } : t));
      const deleteTask = (id) => setTasks(prev => prev.filter(t => t.id !== id));
      const addTask = (task) => { const dt = tasks.filter(t => t.date === task.date && t.memberId === currentUser.id); const mx = Math.max(...dt.map(t => t.order), -1); setTasks(prev => [...prev, { ...task, id: Date.now(), memberId: currentUser.id, order: mx + 1, completed: false, bookmark: false, note: task.note || '' }]); };
      const updateTask = (task) => setTasks(prev => prev.map(t => t.id === task.id ? { ...t, ...task } : t));
      const updateTaskFields = (id, fields) => {
        setTasks(prev => prev.map(t => t.id === id ? { ...t, ...fields } : t));
        setSelectedTaskForNote(prev => prev ? { ...prev, ...fields } : null);
      };
      
      // ê³ ì •ì—…ë¬´ í•¸ë“¤ëŸ¬
      const addFixedTask = (task) => {
        setFixedTasks(prev => [...prev, { ...task, id: Date.now(), completedDates: [] }]);
      };
      const toggleFixedComplete = (id, routineType) => {
        const completionKey = getCompletionKey(routineType, selectedDate);
        setFixedTasks(prev => prev.map(t => {
          if (t.id !== id) return t;
          const isCompleted = t.completedDates.includes(completionKey);
          return {
            ...t,
            completedDates: isCompleted 
              ? t.completedDates.filter(d => d !== completionKey)
              : [...t.completedDates, completionKey]
          };
        }));
      };
      const deleteFixedTask = (id) => {
        setFixedTasks(prev => prev.filter(t => t.id !== id));
      };
      
      // ë£¨í‹´ íƒ€ì…ë³„ í•„í„°ë§
      const getFilteredRoutineTasks = (type) => {
        return fixedTasks.filter(t => 
          t.routineType === type &&
          (!searchQuery || t.title.toLowerCase().includes(searchQuery.toLowerCase())) &&
          (selectedProject === null || t.projectId === selectedProject || (selectedProject === 0 && !t.projectId))
        );
      };
      const dailyTasks = useMemo(() => getFilteredRoutineTasks('daily'), [fixedTasks, searchQuery, selectedProject]);
      const weeklyTasks = useMemo(() => getFilteredRoutineTasks('weekly'), [fixedTasks, searchQuery, selectedProject]);
      const monthlyTasks = useMemo(() => getFilteredRoutineTasks('monthly'), [fixedTasks, searchQuery, selectedProject]);
      
      // ë£¨í‹´ íƒ€ì…ë³„ ì™„ë£Œ ì¹´ìš´íŠ¸
      const getRoutineStats = (type) => {
        const tasks = fixedTasks.filter(t => t.routineType === type);
        const completionKey = getCompletionKey(type, selectedDate);
        const comp = tasks.filter(t => t.completedDates.includes(completionKey)).length;
        return { total: tasks.length, completed: comp };
      };
      const isRoutineCompleted = (task) => {
        const completionKey = getCompletionKey(task.routineType, selectedDate);
        return task.completedDates.includes(completionKey);
      };

      // ë“œë˜ê·¸ ì•¤ ë“œë¡­ í•¸ë“¤ëŸ¬
      const handleDragStart = (e, task) => {
        setDraggedTask(task);
        e.dataTransfer.effectAllowed = 'move';
      };
      const handleDragOver = (e, task) => {
        e.preventDefault();
        if (!draggedTask || draggedTask.id === task.id) return;
        setDragOverId(task.id);
      };
      const handleDragLeave = () => setDragOverId(null);
      const handleDrop = (e, targetTask) => {
        e.preventDefault();
        setDragOverId(null);
        if (!draggedTask || draggedTask.id === targetTask.id) return;
        
        const newTasks = [...filteredTasks];
        const dragIdx = newTasks.findIndex(t => t.id === draggedTask.id);
        const targetIdx = newTasks.findIndex(t => t.id === targetTask.id);
        
        newTasks.splice(dragIdx, 1);
        newTasks.splice(targetIdx, 0, draggedTask);
        
        const updates = newTasks.map((t, i) => ({ id: t.id, order: i }));
        setTasks(prev => prev.map(t => {
          const update = updates.find(u => u.id === t.id);
          return update ? { ...t, order: update.order } : t;
        }));
        setDraggedTask(null);
      };
      const handleDragEnd = () => { setDraggedTask(null); setDragOverId(null); };

      const PROJECT_FILTERS = [
        { id: null, name: 'ì „ì²´' },
        ...BRANDS,
        { id: 0, name: 'ê¸°íƒ€ ì—…ë¬´', color: '#8B95A1' },
      ];

      return (
        <div style={{ display: 'flex', height: '100vh' }}>
          {/* ì™¼ìª½ ì‚¬ì´ë“œë°” - ìº˜ë¦°ë” + ì§„í–‰ë¥  */}
          <div style={{ width: 320, background: 'white', borderRight: '1px solid #E5E8EB', padding: 20, overflow: 'auto' }}>
            <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', marginBottom: 16 }}>
              <button onClick={() => moveMonth('prev')} style={{ width: 32, height: 32, borderRadius: 8, border: '1px solid #E5E8EB', background: 'white', display: 'flex', alignItems: 'center', justifyContent: 'center' }}><Icon name="chevronLeft" size={18} color="#6B7684" /></button>
              <h3 style={{ fontSize: 16, fontWeight: 700, color: '#191F28' }}>{currentMonth.year}ë…„ {currentMonth.month + 1}ì›”</h3>
              <button onClick={() => moveMonth('next')} style={{ width: 32, height: 32, borderRadius: 8, border: '1px solid #E5E8EB', background: 'white', display: 'flex', alignItems: 'center', justifyContent: 'center' }}><Icon name="chevronRight" size={18} color="#6B7684" /></button>
            </div>

            <div style={{ marginBottom: 24 }}>
              <div style={{ display: 'grid', gridTemplateColumns: 'repeat(7, 1fr)', gap: 2, marginBottom: 8 }}>
                {['ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† ', 'ì¼'].map((d, i) => <div key={d} style={{ textAlign: 'center', fontSize: 12, fontWeight: 500, color: i >= 5 ? '#F04452' : '#8B95A1', padding: '4px 0' }}>{d}</div>)}
              </div>
              <div style={{ display: 'grid', gridTemplateColumns: 'repeat(7, 1fr)', gap: 2 }}>
                {monthDates.map(({ date, isCurrentMonth, day }, idx) => {
                  const isSelected = date === selectedDate, isToday = date === today, hasTask = taskCountByDate[date] > 0, dow = idx % 7;
                  return (
                    <button key={date} onClick={() => setSelectedDate(date)} style={{ aspectRatio: '1', borderRadius: 8, border: 'none', background: isSelected ? '#3182F6' : isToday ? '#EBF4FF' : 'transparent', color: isSelected ? 'white' : !isCurrentMonth ? '#D1D6DB' : dow >= 5 ? '#F04452' : '#191F28', fontSize: 14, fontWeight: isSelected || isToday ? 600 : 400, position: 'relative', cursor: 'pointer' }}>
                      {day}
                      {hasTask && !isSelected && <div style={{ position: 'absolute', bottom: 4, left: '50%', transform: 'translateX(-50%)', width: 4, height: 4, borderRadius: '50%', background: '#3182F6' }} />}
                    </button>
                  );
                })}
              </div>
            </div>

            <div style={{ background: '#F7F8FA', borderRadius: 12, padding: 16 }}>
              <h4 style={{ fontSize: 13, fontWeight: 600, color: '#6B7684', marginBottom: 12 }}>ì˜¤ëŠ˜ì˜ ì§„í–‰ë¥ </h4>
              <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', marginBottom: 8 }}>
                <span style={{ fontSize: 24, fontWeight: 700, color: '#191F28' }}>{stats.rate}%</span>
                <span style={{ fontSize: 14, color: '#6B7684' }}>{stats.completed}/{stats.total} ì™„ë£Œ</span>
              </div>
              <div style={{ height: 8, background: '#E5E8EB', borderRadius: 4, overflow: 'hidden' }}>
                <div style={{ height: '100%', background: stats.rate === 100 ? '#00C471' : '#3182F6', width: `${stats.rate}%`, transition: 'width 0.3s' }} />
              </div>
            </div>

            {/* ì˜¤ëŠ˜ì˜ í•œë§ˆë”” ë©”ëª¨ */}
            <DailyMemo selectedDate={selectedDate} />

            {/* ê³ ì • ë©”ëª¨ */}
            <FixedMemo />
          </div>

          {/* ì˜¤ë¥¸ìª½ - ì—…ë¬´ ë¦¬ìŠ¤íŠ¸ */}
          <div style={{ flex: 1, overflow: 'auto', background: '#F7F8FA' }}>
            {/* ìƒë‹¨ ë‚ ì§œ + í•„í„° ë°” */}
            <div style={{ background: 'white', borderBottom: '1px solid #E5E8EB', padding: '16px 24px' }}>
              {/* ë‚ ì§œ í‘œì‹œ */}
              <div style={{ marginBottom: 16 }}>
                <h2 style={{ fontSize: 22, fontWeight: 700, color: '#191F28' }}>
                  {(() => {
                    const d = new Date(selectedDate);
                    const days = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
                    const isToday = selectedDate === today;
                    return (
                      <>
                        {d.getMonth() + 1}ì›” {d.getDate()}ì¼ ({days[d.getDay()]})
                        {isToday && <span style={{ marginLeft: 8, padding: '4px 10px', borderRadius: 6, background: '#3182F6', color: 'white', fontSize: 12, fontWeight: 600 }}>ì˜¤ëŠ˜</span>}
                      </>
                    );
                  })()}
                </h2>
              </div>
              
              <div style={{ display: 'flex', alignItems: 'center', gap: 12 }}>
                <div style={{ display: 'flex', alignItems: 'center', gap: 8, background: '#F7F8FA', borderRadius: 10, padding: '0 14px', width: 240 }}>
                  <Icon name="search" size={18} color="#8B95A1" />
                  <input type="text" value={searchQuery} onChange={(e) => setSearchQuery(e.target.value)} placeholder="ì—…ë¬´ ê²€ìƒ‰" style={{ flex: 1, border: 'none', background: 'transparent', padding: '10px 0', fontSize: 14, color: '#191F28' }} />
                </div>

                <div style={{ display: 'flex', alignItems: 'center', gap: 8 }}>
                  <span style={{ fontSize: 14, color: '#6B7684', marginRight: 4 }}>í”„ë¡œì íŠ¸</span>
                  {PROJECT_FILTERS.map(f => (
                    <button key={f.id === null ? 'all' : f.id} onClick={() => setSelectedProject(f.id)} style={{ padding: '6px 14px', borderRadius: 8, border: selectedProject === f.id ? `1.5px solid ${f.color || '#3182F6'}` : '1px solid #E5E8EB', background: selectedProject === f.id ? (f.color ? `${f.color}15` : '#EBF4FF') : 'white', fontSize: 13, fontWeight: 500, color: selectedProject === f.id ? (f.color || '#3182F6') : '#6B7684' }}>{f.name}</button>
                  ))}
                </div>
              </div>
            </div>

            {/* ë£¨í‹´ ì—…ë¬´ ì„¹ì…˜ - ê°€ë¡œ 3ì—´ ë°°ì¹˜ */}
            <div style={{ padding: '24px 24px 0 24px' }}>
              <div style={{ display: 'grid', gridTemplateColumns: 'repeat(3, 1fr)', gap: 16 }}>
                {/* ì¼ì¼ ë£¨í‹´ */}
                <RoutineSection 
                  title="ì¼ì¼ ë£¨í‹´" 
                  type="daily"
                  icon="â˜€ï¸"
                  bgColor="#FEF3C7"
                  borderColor="#FDE68A"
                  textColor="#92400E"
                  buttonColor="#F59E0B"
                  tasks={dailyTasks}
                  stats={getRoutineStats('daily')}
                  isCompleted={isRoutineCompleted}
                  onToggle={(id) => toggleFixedComplete(id, 'daily')}
                  onDelete={deleteFixedTask}
                  onAdd={() => { setAddRoutineType('daily'); setShowAddFixedModal(true); }}
                />
                
                {/* ì£¼ê°„ ë£¨í‹´ */}
                <RoutineSection 
                  title="ì£¼ê°„ ë£¨í‹´" 
                  type="weekly"
                  icon="ğŸ“…"
                  bgColor="#DBEAFE"
                  borderColor="#93C5FD"
                  textColor="#1E40AF"
                  buttonColor="#3B82F6"
                  tasks={weeklyTasks}
                  stats={getRoutineStats('weekly')}
                  isCompleted={isRoutineCompleted}
                  onToggle={(id) => toggleFixedComplete(id, 'weekly')}
                  onDelete={deleteFixedTask}
                  onAdd={() => { setAddRoutineType('weekly'); setShowAddFixedModal(true); }}
                />
                
                {/* ì›”ê°„ ë£¨í‹´ */}
                <RoutineSection 
                  title="ì›”ê°„ ë£¨í‹´" 
                  type="monthly"
                  icon="ğŸ“†"
                  bgColor="#F3E8FF"
                  borderColor="#D8B4FE"
                  textColor="#6B21A8"
                  buttonColor="#9333EA"
                  tasks={monthlyTasks}
                  stats={getRoutineStats('monthly')}
                  isCompleted={isRoutineCompleted}
                  onToggle={(id) => toggleFixedComplete(id, 'monthly')}
                  onDelete={deleteFixedTask}
                  onAdd={() => { setAddRoutineType('monthly'); setShowAddFixedModal(true); }}
                />
              </div>
            </div>

            {/* í…Œì´ë¸” */}
            <div style={{ padding: 24 }}>
              <div style={{ background: 'white', borderRadius: 16, border: '1px solid #E5E8EB', overflow: 'hidden' }}>
                <div style={{ display: 'grid', gridTemplateColumns: '32px 44px 1fr 120px 44px 44px 44px', alignItems: 'center', padding: '12px 20px', borderBottom: '1px solid #E5E8EB', background: '#FAFBFC' }}>
                  <div></div>
                  <div></div>
                  <div style={{ fontSize: 13, fontWeight: 600, color: '#6B7684' }}>ì—…ë¬´</div>
                  <div style={{ fontSize: 13, fontWeight: 600, color: '#6B7684', textAlign: 'center' }}>í”„ë¡œì íŠ¸</div>
                  <div style={{ gridColumn: 'span 3', display: 'flex', justifyContent: 'flex-end' }}>
                    <button onClick={() => { setEditingTask(null); setShowAddModal(true); }} style={{ display: 'flex', alignItems: 'center', gap: 6, padding: '6px 14px', borderRadius: 8, background: '#3182F6', border: 'none', color: 'white', fontSize: 13, fontWeight: 600, cursor: 'pointer' }}>
                      <Icon name="plus" size={14} color="white" /> ì—…ë¬´ ì¶”ê°€
                    </button>
                  </div>
                </div>

                {filteredTasks.length === 0 ? (
                  <div style={{ padding: '60px 20px', textAlign: 'center' }}>
                    <Icon name="clipboard" size={48} color="#D1D6DB" />
                    <p style={{ fontSize: 16, color: '#8B95A1', marginTop: 16 }}>ë“±ë¡ëœ ì—…ë¬´ê°€ ì—†ìŠµë‹ˆë‹¤</p>
                  </div>
                ) : (
                  filteredTasks.map((task, idx) => {
                    const project = projects.find(p => p.id === task.projectId);
                    const proj = project ? BRANDS.find(b => b.id === project.brandId) : BRANDS.find(p => p.id === task.projectId);
                    const isDragging = draggedTask?.id === task.id;
                    const isDragOver = dragOverId === task.id;
                    return (
                      <div
                        key={task.id}
                        className="task-row"
                        draggable
                        onDragStart={(e) => handleDragStart(e, task)}
                        onDragOver={(e) => handleDragOver(e, task)}
                        onDragLeave={handleDragLeave}
                        onDrop={(e) => handleDrop(e, task)}
                        onDragEnd={handleDragEnd}
                        style={{
                          display: 'grid',
                          gridTemplateColumns: '32px 44px 1fr 120px 44px 44px 44px',
                          alignItems: 'center',
                          padding: '14px 20px',
                          borderBottom: idx < filteredTasks.length - 1 ? '1px solid #F2F3F5' : 'none',
                          background: isDragOver ? '#EBF4FF' : isDragging ? '#F7F8FA' : 'white',
                          opacity: isDragging ? 0.6 : 1,
                          borderTop: isDragOver ? '2px solid #3182F6' : 'none',
                        }}
                      >
                        <div style={{ display: 'flex', justifyContent: 'center', cursor: 'grab' }}>
                          <Icon name="grip" size={16} color="#D1D6DB" />
                        </div>

                        <div>
                          <button onClick={(e) => { e.stopPropagation(); toggleComplete(task.id); }} style={{ width: 22, height: 22, borderRadius: 6, border: task.completed ? 'none' : '2px solid #D1D6DB', background: task.completed ? '#3182F6' : 'white', display: 'flex', alignItems: 'center', justifyContent: 'center' }}>
                            {task.completed && <Icon name="check" size={14} color="white" />}
                          </button>
                        </div>

                        <div onClick={() => setSelectedTaskForNote(task)} style={{ cursor: 'pointer', padding: '4px 0' }}>
                          <div style={{ display: 'flex', alignItems: 'center', gap: 8 }}>
                            <span style={{ fontSize: 15, fontWeight: 500, color: task.completed ? '#8B95A1' : '#191F28', textDecoration: task.completed ? 'line-through' : 'none' }}>{task.title}</span>
                            {task.bookmark && <Icon name="bookmarkFill" size={14} color="#F59E0B" />}
                            {task.note && <Icon name="fileText" size={14} color="#3182F6" />}
                          </div>
                          {task.note && <p style={{ fontSize: 13, color: '#8B95A1', marginTop: 4, overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap', maxWidth: 400 }}>{task.note.split('\n')[0]}</p>}
                        </div>

                        <div style={{ display: 'flex', justifyContent: 'center' }}>
                          {proj ? <span style={{ padding: '4px 10px', borderRadius: 6, background: `${proj.color}15`, color: proj.color, fontSize: 12, fontWeight: 600 }}>{proj.name}</span> : <span style={{ padding: '4px 10px', borderRadius: 6, background: '#8B95A115', color: '#8B95A1', fontSize: 12, fontWeight: 600 }}>ê¸°íƒ€ ì—…ë¬´</span>}
                        </div>

                        <div style={{ display: 'flex', justifyContent: 'center' }}>
                          <button onClick={(e) => { e.stopPropagation(); toggleBookmark(task.id); }} style={{ width: 32, height: 32, borderRadius: 6, border: 'none', background: 'transparent', display: 'flex', alignItems: 'center', justifyContent: 'center' }}>
                            <Icon name={task.bookmark ? 'bookmarkFill' : 'bookmark'} size={18} color={task.bookmark ? '#F59E0B' : '#D1D6DB'} />
                          </button>
                        </div>

                        <div style={{ display: 'flex', justifyContent: 'center' }}>
                          <button onClick={(e) => { e.stopPropagation(); setEditingTask(task); setShowAddModal(true); }} style={{ width: 32, height: 32, borderRadius: 6, border: 'none', background: '#F7F8FA', display: 'flex', alignItems: 'center', justifyContent: 'center' }}>
                            <Icon name="edit" size={16} color="#6B7684" />
                          </button>
                        </div>

                        <div style={{ display: 'flex', justifyContent: 'center' }}>
                          <button onClick={(e) => { e.stopPropagation(); deleteTask(task.id); }} style={{ width: 32, height: 32, borderRadius: 6, border: 'none', background: '#FEE4E2', display: 'flex', alignItems: 'center', justifyContent: 'center' }}>
                            <Icon name="trash" size={16} color="#F04452" />
                          </button>
                        </div>
                      </div>
                    );
                  })
                )}
              </div>
            </div>
          </div>

          {/* ë©”ëª¨ íŒ¨ë„ */}
          {selectedTaskForNote && <NotePanel task={selectedTaskForNote} onClose={() => setSelectedTaskForNote(null)} onUpdateTask={(fields) => updateTaskFields(selectedTaskForNote.id, fields)} />}

          {showAddModal && <TaskModal task={editingTask} date={selectedDate} onSave={(t) => { if (editingTask) updateTask(t); else addTask(t); setShowAddModal(false); }} onClose={() => setShowAddModal(false)} />}
          
          {/* ê³ ì •ì—…ë¬´ ì¶”ê°€ ëª¨ë‹¬ */}
          {showAddFixedModal && <FixedTaskModal routineType={addRoutineType} onSave={(t) => { addFixedTask(t); setShowAddFixedModal(false); }} onClose={() => setShowAddFixedModal(false)} />}
        </div>
      );
    }

    // ============ ê³ ì •ì—…ë¬´ ì¶”ê°€ ëª¨ë‹¬ ============
    function FixedTaskModal({ routineType, onSave, onClose }) {
      const [form, setForm] = useState({ title: '', projectId: null, routineType: routineType });
      
      const typeInfo = {
        daily: { label: 'ì¼ì¼ ë£¨í‹´ ì—…ë¬´', icon: 'â˜€ï¸', color: '#F59E0B' },
        weekly: { label: 'ì£¼ê°„ ë£¨í‹´ ì—…ë¬´', icon: 'ğŸ“…', color: '#3B82F6' },
        monthly: { label: 'ì›”ê°„ ë£¨í‹´ ì—…ë¬´', icon: 'ğŸ“†', color: '#9333EA' },
      };
      const info = typeInfo[routineType] || typeInfo.daily;
      
      return (
        <div onClick={onClose} style={{ position: 'fixed', inset: 0, background: 'rgba(0,0,0,0.5)', display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 1100 }}>
          <div onClick={(e) => e.stopPropagation()} style={{ background: 'white', borderRadius: 20, padding: 28, width: '100%', maxWidth: 480, maxHeight: '90vh', overflow: 'auto' }}>
            <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', marginBottom: 24 }}>
              <div style={{ display: 'flex', alignItems: 'center', gap: 10 }}>
                <span style={{ fontSize: 24 }}>{info.icon}</span>
                <h2 style={{ fontSize: 20, fontWeight: 700, color: '#191F28' }}>{info.label} ì¶”ê°€</h2>
              </div>
              <button onClick={onClose} style={{ width: 36, height: 36, borderRadius: 10, border: 'none', background: '#F7F8FA', display: 'flex', alignItems: 'center', justifyContent: 'center' }}>
                <Icon name="x" size={20} color="#8B95A1" />
              </button>
            </div>
            
            <div style={{ marginBottom: 20 }}>
              <label style={{ display: 'block', fontSize: 14, fontWeight: 600, marginBottom: 8 }}>ì—…ë¬´ëª… *</label>
              <input 
                type="text" 
                value={form.title} 
                onChange={(e) => setForm({ ...form, title: e.target.value })} 
                placeholder={routineType === 'daily' ? 'ë§¤ì¼ ìˆ˜í–‰í•  ì—…ë¬´' : routineType === 'weekly' ? 'ë§¤ì£¼ ìˆ˜í–‰í•  ì—…ë¬´' : 'ë§¤ì›” ìˆ˜í–‰í•  ì—…ë¬´'}
                style={{ width: '100%', padding: '14px 16px', borderRadius: 12, border: '1px solid #E5E8EB', fontSize: 15 }}
                autoFocus
              />
            </div>
            
            <div style={{ marginBottom: 24 }}>
              <label style={{ display: 'block', fontSize: 14, fontWeight: 600, marginBottom: 8 }}>í”„ë¡œì íŠ¸</label>
              <div style={{ display: 'flex', gap: 8, flexWrap: 'wrap' }}>
                <button onClick={() => setForm({ ...form, projectId: null })} style={{ padding: '10px 16px', borderRadius: 10, border: form.projectId === null ? '2px solid #3182F6' : '1px solid #E5E8EB', background: form.projectId === null ? '#EBF4FF' : 'white', color: form.projectId === null ? '#3182F6' : '#6B7684', fontSize: 14, fontWeight: 500 }}>ì—†ìŒ</button>
                {BRANDS.map(b => (
                  <button key={b.id} onClick={() => setForm({ ...form, projectId: b.id })} style={{ padding: '10px 16px', borderRadius: 10, border: form.projectId === b.id ? `2px solid ${b.color}` : '1px solid #E5E8EB', background: form.projectId === b.id ? `${b.color}15` : 'white', color: form.projectId === b.id ? b.color : '#6B7684', fontSize: 14, fontWeight: 500 }}>{b.name}</button>
                ))}
              </div>
            </div>
            
            <div style={{ display: 'flex', gap: 12 }}>
              <button onClick={onClose} style={{ flex: 1, padding: 16, borderRadius: 12, border: '1px solid #E5E8EB', background: 'white', fontSize: 15, fontWeight: 600, color: '#6B7684' }}>ì·¨ì†Œ</button>
              <button 
                onClick={() => form.title.trim() && onSave(form)} 
                disabled={!form.title.trim()}
                style={{ flex: 1, padding: 16, borderRadius: 12, border: 'none', background: form.title.trim() ? info.color : '#E5E8EB', fontSize: 15, fontWeight: 600, color: form.title.trim() ? 'white' : '#8B95A1' }}
              >
                ì¶”ê°€í•˜ê¸°
              </button>
            </div>
          </div>
        </div>
      );
    }

    // ============ ë£¨í‹´ ì„¹ì…˜ ì»´í¬ë„ŒíŠ¸ ============
    function RoutineSection({ title, type, icon, bgColor, borderColor, textColor, buttonColor, tasks, stats, isCompleted, onToggle, onDelete, onAdd }) {
      const [isCollapsed, setIsCollapsed] = useState(false);
      
      return (
        <div style={{ background: 'white', borderRadius: 12, border: `1px solid ${borderColor}`, overflow: 'hidden' }}>
          {/* í—¤ë” */}
          <div 
            onClick={() => setIsCollapsed(!isCollapsed)}
            style={{ 
              display: 'flex', alignItems: 'center', justifyContent: 'space-between',
              padding: '14px 16px', background: bgColor, cursor: 'pointer'
            }}
          >
            <div style={{ display: 'flex', alignItems: 'center', gap: 8 }}>
              <span style={{ fontSize: 16 }}>{icon}</span>
              <span style={{ fontSize: 14, fontWeight: 700, color: textColor }}>{title}</span>
              <span style={{ padding: '3px 8px', borderRadius: 8, background: `${buttonColor}20`, color: textColor, fontSize: 13, fontWeight: 600 }}>{stats.completed}/{stats.total}</span>
            </div>
            <div style={{ display: 'flex', alignItems: 'center', gap: 8 }}>
              <button 
                onClick={(e) => { e.stopPropagation(); onAdd(); }}
                style={{ display: 'flex', alignItems: 'center', gap: 4, padding: '6px 12px', borderRadius: 6, background: buttonColor, border: 'none', color: 'white', fontSize: 12, fontWeight: 600, cursor: 'pointer' }}
              >
                <Icon name="plus" size={12} color="white" /> ì¶”ê°€
              </button>
              <div style={{ transform: isCollapsed ? 'rotate(0deg)' : 'rotate(180deg)', transition: 'transform 0.2s' }}>
                <Icon name="chevronDown" size={16} color={textColor} />
              </div>
            </div>
          </div>
          
          {/* ë¦¬ìŠ¤íŠ¸ */}
          {!isCollapsed && (
            tasks.length === 0 ? (
              <div style={{ padding: '20px', textAlign: 'center', background: `${bgColor}50` }}>
                <p style={{ fontSize: 13, color: textColor }}>ë“±ë¡ëœ ì—…ë¬´ê°€ ì—†ìŠµë‹ˆë‹¤</p>
              </div>
            ) : (
              tasks.map((task, idx) => {
                const proj = BRANDS.find(p => p.id === task.projectId);
                const completed = isCompleted(task);
                return (
                  <div 
                    key={task.id}
                    style={{ 
                      display: 'flex', alignItems: 'center', gap: 10,
                      padding: '12px 16px', background: `${bgColor}50`,
                      borderTop: `1px solid ${borderColor}`
                    }}
                  >
                    <button onClick={() => onToggle(task.id)} style={{ width: 24, height: 24, borderRadius: 6, border: 'none', background: completed ? buttonColor : 'white', display: 'flex', alignItems: 'center', justifyContent: 'center', boxShadow: '0 1px 2px rgba(0,0,0,0.1)', cursor: 'pointer', flexShrink: 0 }}>
                      {completed && <Icon name="check" size={14} color="white" />}
                    </button>
                    <span style={{ flex: 1, fontSize: 14, fontWeight: 500, color: completed ? '#8B95A1' : '#191F28', textDecoration: completed ? 'line-through' : 'none', overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap' }}>{task.title}</span>
                    {proj ? <span style={{ padding: '3px 8px', borderRadius: 6, background: `${proj.color}15`, color: proj.color, fontSize: 11, fontWeight: 600, flexShrink: 0 }}>{proj.name}</span> : <span style={{ padding: '3px 8px', borderRadius: 6, background: '#8B95A115', color: '#8B95A1', fontSize: 11, fontWeight: 600, flexShrink: 0 }}>ê¸°íƒ€</span>}
                    <button onClick={() => onDelete(task.id)} style={{ width: 26, height: 26, borderRadius: 6, border: 'none', background: '#FEE4E2', display: 'flex', alignItems: 'center', justifyContent: 'center', cursor: 'pointer', flexShrink: 0 }}>
                      <Icon name="trash" size={14} color="#F04452" />
                    </button>
                  </div>
                );
              })
            )
          )}
        </div>
      );
    }

    // ============ ë°ì¼ë¦¬ ë©”ëª¨ ì»´í¬ë„ŒíŠ¸ ============
    function DailyMemo({ selectedDate }) {
      const [memos, setMemos] = useState({});
      const [memo, setMemo] = useState('');
      const [isEditing, setIsEditing] = useState(false);
      const [isLoaded, setIsLoaded] = useState(false);

      // Firebaseì—ì„œ ë©”ëª¨ ë¡œë“œ
      useEffect(() => {
        const loadMemos = async () => {
          const data = await FirebaseService.getDoc('settings', 'dailyMemos');
          if (data && data.memos) {
            setMemos(data.memos);
          }
          setIsLoaded(true);
        };
        loadMemos();
      }, []);

      useEffect(() => {
        if (isLoaded) {
          setMemo(memos[selectedDate] || '');
        }
      }, [selectedDate, memos, isLoaded]);

      const saveMemo = async () => {
        const newMemos = { ...memos, [selectedDate]: memo };
        setMemos(newMemos);
        setIsEditing(false);
        // Firebaseì— ì €ì¥
        await FirebaseService.saveDoc('settings', 'dailyMemos', { memos: newMemos });
      };

      return (
        <div style={{ marginTop: 16, background: 'white', borderRadius: 12, border: '1px solid #E5E8EB', overflow: 'hidden' }}>
          <div style={{ padding: '12px 16px', borderBottom: '1px solid #F2F3F5', display: 'flex', alignItems: 'center', justifyContent: 'space-between' }}>
            <h4 style={{ fontSize: 13, fontWeight: 600, color: '#191F28', display: 'flex', alignItems: 'center', gap: 6 }}>
              <span>âœï¸</span> ì˜¤ëŠ˜ì˜ í•œë§ˆë””
            </h4>
            {!isEditing && memo && (
              <button onClick={() => setIsEditing(true)} style={{ fontSize: 12, color: '#3182F6', background: 'none', border: 'none', fontWeight: 500 }}>ìˆ˜ì •</button>
            )}
          </div>
          <div style={{ padding: 12 }}>
            {isEditing ? (
              <div>
                <textarea
                  value={memo}
                  onChange={(e) => setMemo(e.target.value)}
                  placeholder="ì˜¤ëŠ˜ì˜ ëª©í‘œ, ë‹¤ì§, ë©”ëª¨ ë“±ì„ ììœ ë¡­ê²Œ ì ì–´ë³´ì„¸ìš”..."
                  style={{ width: '100%', minHeight: 80, padding: 12, borderRadius: 8, border: '1px solid #3182F6', fontSize: 13, lineHeight: 1.6, resize: 'none', outline: 'none' }}
                  autoFocus
                />
                <div style={{ display: 'flex', gap: 8, marginTop: 8 }}>
                  <button onClick={() => { setMemo(memos[selectedDate] || ''); setIsEditing(false); }} style={{ flex: 1, padding: 8, borderRadius: 6, border: '1px solid #E5E8EB', background: 'white', fontSize: 12, fontWeight: 500, color: '#6B7684' }}>ì·¨ì†Œ</button>
                  <button onClick={saveMemo} style={{ flex: 1, padding: 8, borderRadius: 6, border: 'none', background: '#3182F6', fontSize: 12, fontWeight: 500, color: 'white' }}>ì €ì¥</button>
                </div>
              </div>
            ) : (
              <div
                onClick={() => setIsEditing(true)}
                style={{ minHeight: 60, padding: 12, borderRadius: 8, background: '#FAFBFC', fontSize: 13, lineHeight: 1.6, color: memo ? '#191F28' : '#8B95A1', whiteSpace: 'pre-wrap', cursor: 'pointer', border: '1px dashed transparent', transition: 'all 0.2s' }}
                onMouseEnter={(e) => { e.currentTarget.style.borderColor = '#D1D6DB'; e.currentTarget.style.background = '#F7F8FA'; }}
                onMouseLeave={(e) => { e.currentTarget.style.borderColor = 'transparent'; e.currentTarget.style.background = '#FAFBFC'; }}
              >
                {memo || 'í´ë¦­í•˜ì—¬ ì˜¤ëŠ˜ì˜ í•œë§ˆë””ë¥¼ ì‘ì„±í•´ë³´ì„¸ìš”...'}
              </div>
            )}
          </div>
        </div>
      );
    }

    // ============ ê³ ì • ë©”ëª¨ ì»´í¬ë„ŒíŠ¸ ============
    function FixedMemo() {
      const [memo, setMemo] = useState('');
      const [isEditing, setIsEditing] = useState(false);
      const [tempMemo, setTempMemo] = useState('');
      const [isLoaded, setIsLoaded] = useState(false);

      // Firebaseì—ì„œ ê³ ì • ë©”ëª¨ ë¡œë“œ
      useEffect(() => {
        const loadMemo = async () => {
          const data = await FirebaseService.getDoc('settings', 'fixedMemo');
          if (data && data.content) {
            setMemo(data.content);
          }
          setIsLoaded(true);
        };
        loadMemo();
      }, []);

      const startEdit = () => {
        setTempMemo(memo);
        setIsEditing(true);
      };

      const saveMemo = async () => {
        setMemo(tempMemo);
        setIsEditing(false);
        // Firebaseì— ì €ì¥
        await FirebaseService.saveDoc('settings', 'fixedMemo', { content: tempMemo });
      };

      const cancelEdit = () => {
        setTempMemo(memo);
        setIsEditing(false);
      };

      return (
        <div style={{ marginTop: 16, background: 'white', borderRadius: 12, border: '1px solid #E5E8EB', overflow: 'hidden' }}>
          <div style={{ padding: '12px 16px', borderBottom: '1px solid #F2F3F5', display: 'flex', alignItems: 'center', justifyContent: 'space-between' }}>
            <h4 style={{ fontSize: 13, fontWeight: 600, color: '#191F28', display: 'flex', alignItems: 'center', gap: 6 }}>
              <span>ğŸ“Œ</span> ê³ ì • ë©”ëª¨
            </h4>
            {!isEditing && memo && (
              <button onClick={startEdit} style={{ fontSize: 12, color: '#3182F6', background: 'none', border: 'none', fontWeight: 500 }}>ìˆ˜ì •</button>
            )}
          </div>
          <div style={{ padding: 12 }}>
            {isEditing ? (
              <div>
                <textarea
                  value={tempMemo}
                  onChange={(e) => setTempMemo(e.target.value)}
                  placeholder="í•­ìƒ ê¸°ì–µí•´ì•¼ í•  ë‚´ìš©, ì¤‘ìš”í•œ ë©”ëª¨ ë“±ì„ ì ì–´ë‘ì„¸ìš”..."
                  style={{ width: '100%', minHeight: 100, padding: 12, borderRadius: 8, border: '1px solid #3182F6', fontSize: 13, lineHeight: 1.6, resize: 'none', outline: 'none' }}
                  autoFocus
                />
                <div style={{ display: 'flex', gap: 8, marginTop: 8 }}>
                  <button onClick={cancelEdit} style={{ flex: 1, padding: 8, borderRadius: 6, border: '1px solid #E5E8EB', background: 'white', fontSize: 12, fontWeight: 500, color: '#6B7684' }}>ì·¨ì†Œ</button>
                  <button onClick={saveMemo} style={{ flex: 1, padding: 8, borderRadius: 6, border: 'none', background: '#3182F6', fontSize: 12, fontWeight: 500, color: 'white' }}>ì €ì¥</button>
                </div>
              </div>
            ) : (
              <div
                onClick={startEdit}
                style={{ minHeight: 80, padding: 12, borderRadius: 8, background: '#FFF9E6', fontSize: 13, lineHeight: 1.6, color: memo ? '#191F28' : '#8B95A1', whiteSpace: 'pre-wrap', cursor: 'pointer', border: '1px dashed transparent', transition: 'all 0.2s' }}
                onMouseEnter={(e) => { e.currentTarget.style.borderColor = '#F59E0B'; }}
                onMouseLeave={(e) => { e.currentTarget.style.borderColor = 'transparent'; }}
              >
                {memo || 'í´ë¦­í•˜ì—¬ ê³ ì • ë©”ëª¨ë¥¼ ì‘ì„±í•´ë³´ì„¸ìš”...'}
              </div>
            )}
          </div>
        </div>
      );
    }

    // ============ ë©”ëª¨ íŒ¨ë„ ============
    function NotePanel({ task, onClose, onUpdateTask }) {
      const [note, setNote] = useState(task.note || '');
      const [taskDate, setTaskDate] = useState(task.date || today);
      const [isEditing, setIsEditing] = useState(false);
      const [attachments, setAttachments] = useState(task.attachments || []);
      const fileInputRef = React.useRef(null);
      const proj = BRANDS.find(p => p.id === task.projectId);

      const handleSave = () => { 
        onUpdateTask({ note, date: taskDate, attachments }); 
        setIsEditing(false); 
      };
      
      const [isUploading, setIsUploading] = useState(false);
      const [uploadProgress, setUploadProgress] = useState(0);
      
      const handleFileSelect = async (e) => {
        const files = Array.from(e.target.files);
        if (files.length === 0) return;
        
        // íŒŒì¼ í¬ê¸° ì²´í¬ (10MB ì œí•œ)
        const maxSize = 10 * 1024 * 1024;
        for (const file of files) {
          if (file.size > maxSize) {
            alert(`íŒŒì¼ í¬ê¸°ê°€ ë„ˆë¬´ í½ë‹ˆë‹¤ (ìµœëŒ€ 10MB)\n${file.name}: ${(file.size / 1024 / 1024).toFixed(1)}MB`);
            e.target.value = '';
            return;
          }
        }
        
        setIsUploading(true);
        setUploadProgress(0);
        
        for (const file of files) {
          try {
            // Firebase Storageì— ì—…ë¡œë“œ
            const path = `attachments/worklog/${task.id}/${Date.now()}_${file.name}`;
            const result = await FirebaseService.uploadFile(file, path, (progress) => {
              setUploadProgress(progress);
            });
            
            if (result) {
              const newAttachment = {
                id: Date.now() + Math.random(),
                name: result.name,
                size: result.size,
                type: result.type,
                url: result.url,
                path: path
              };
              const updated = [...attachments, newAttachment];
              setAttachments(updated);
              onUpdateTask({ note, date: taskDate, attachments: updated });
            } else {
              alert(`íŒŒì¼ ì—…ë¡œë“œ ì‹¤íŒ¨: ${file.name}`);
            }
          } catch (error) {
            console.error('File upload error:', error);
            alert(`íŒŒì¼ ì—…ë¡œë“œ ì‹¤íŒ¨: ${error.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}`);
          }
        }
        
        setIsUploading(false);
        e.target.value = '';
      };
      
      const removeAttachment = async (id) => {
        const attachment = attachments.find(a => a.id === id);
        // Firebase Storageì—ì„œ íŒŒì¼ ì‚­ì œ
        if (attachment?.path) {
          await FirebaseService.deleteFile(attachment.path);
        }
        const updated = attachments.filter(a => a.id !== id);
        setAttachments(updated);
        onUpdateTask({ note, date: taskDate, attachments: updated });
      };

      // taskê°€ ë³€ê²½ë˜ë©´ ìƒíƒœ ì—…ë°ì´íŠ¸
      React.useEffect(() => { 
        setNote(task.note || ''); 
        setTaskDate(task.date || today);
        setAttachments(task.attachments || []);
      }, [task.id, task.note, task.date, task.attachments]);

      return (
        <>
          {/* ë°”ê¹¥ ì˜ì—­ í´ë¦­ ì‹œ ë‹«ê¸° ìœ„í•œ ì˜¤ë²„ë ˆì´ */}
          <div 
            onClick={onClose} 
            style={{ position: 'fixed', top: 0, left: 0, right: 420, bottom: 0, zIndex: 999 }} 
          />
          
          {/* ë©”ëª¨ íŒ¨ë„ */}
          <div style={{ position: 'fixed', top: 0, right: 0, bottom: 0, width: 420, background: 'white', boxShadow: '-4px 0 20px rgba(0,0,0,0.1)', zIndex: 1000, display: 'flex', flexDirection: 'column', animation: 'slideIn 0.3s ease' }}>
          <div style={{ padding: '20px 24px', borderBottom: '1px solid #E5E8EB' }}>
            <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', marginBottom: 16 }}>
              <h3 style={{ fontSize: 18, fontWeight: 700, color: '#191F28' }}>ğŸ“ ì—…ë¬´ ë©”ëª¨</h3>
              <button onClick={onClose} style={{ width: 32, height: 32, borderRadius: 8, border: 'none', background: '#F7F8FA', display: 'flex', alignItems: 'center', justifyContent: 'center' }}>
                <Icon name="x" size={18} color="#6B7684" />
              </button>
            </div>

            <div style={{ background: '#F7F8FA', borderRadius: 12, padding: 16 }}>
              <div style={{ display: 'flex', alignItems: 'center', gap: 8, marginBottom: 8 }}>
                {task.completed ? (
                  <div style={{ width: 22, height: 22, borderRadius: 6, background: '#3182F6', display: 'flex', alignItems: 'center', justifyContent: 'center' }}>
                    <Icon name="check" size={14} color="white" />
                  </div>
                ) : (
                  <div style={{ width: 22, height: 22, borderRadius: 6, border: '2px solid #D1D6DB' }} />
                )}
                <span style={{ fontSize: 16, fontWeight: 600, color: task.completed ? '#8B95A1' : '#191F28', textDecoration: task.completed ? 'line-through' : 'none', flex: 1 }}>{task.title}</span>
                {task.bookmark && <Icon name="bookmarkFill" size={16} color="#F59E0B" />}
              </div>
              {proj && (
                <div style={{ marginTop: 8 }}>
                  <span style={{ padding: '4px 10px', borderRadius: 6, background: `${proj.color}15`, color: proj.color, fontSize: 12, fontWeight: 600 }}>{proj.name}</span>
                </div>
              )}
            </div>
          </div>

          <div style={{ flex: 1, padding: 24, overflow: 'auto' }}>
            {/* ë‚ ì§œ ìˆ˜ì • ì˜ì—­ */}
            <div style={{ marginBottom: 20 }}>
              <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', marginBottom: 8 }}>
                <span style={{ fontSize: 14, fontWeight: 600, color: '#191F28' }}>ë‚ ì§œ</span>
              </div>
              <input 
                type="date" 
                value={taskDate} 
                onChange={(e) => {
                  setTaskDate(e.target.value);
                  onUpdateTask({ note: task.note, date: e.target.value });
                }}
                onClick={(e) => e.target.showPicker()}
                style={{ width: '100%', padding: '12px 14px', borderRadius: 10, border: '1px solid #E5E8EB', fontSize: 14, background: 'white', cursor: 'pointer' }} 
              />
            </div>

            {/* ë©”ëª¨ ì˜ì—­ */}
            <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', marginBottom: 12 }}>
              <span style={{ fontSize: 14, fontWeight: 600, color: '#191F28' }}>ë©”ëª¨</span>
              {!isEditing && (
                <button onClick={() => setIsEditing(true)} style={{ display: 'flex', alignItems: 'center', gap: 4, padding: '6px 12px', borderRadius: 6, border: 'none', background: '#EBF4FF', color: '#3182F6', fontSize: 13, fontWeight: 500 }}>
                  <Icon name="edit" size={14} color="#3182F6" /> ìˆ˜ì •
                </button>
              )}
            </div>

            {isEditing ? (
              <div>
                <textarea
                  value={note}
                  onChange={(e) => setNote(e.target.value)}
                  placeholder="ë©”ëª¨ë¥¼ ì…ë ¥í•˜ì„¸ìš”..."
                  style={{ width: '100%', minHeight: 200, padding: 16, borderRadius: 12, border: '2px solid #3182F6', fontSize: 14, lineHeight: 1.8, resize: 'none', outline: 'none' }}
                  autoFocus
                />
                <div style={{ display: 'flex', gap: 8, marginTop: 12 }}>
                  <button onClick={() => { setNote(task.note || ''); setIsEditing(false); }} style={{ flex: 1, padding: 12, borderRadius: 8, border: '1px solid #E5E8EB', background: 'white', fontSize: 14, fontWeight: 600, color: '#6B7684' }}>ì·¨ì†Œ</button>
                  <button onClick={handleSave} style={{ flex: 1, padding: 12, borderRadius: 8, border: 'none', background: '#3182F6', fontSize: 14, fontWeight: 600, color: 'white' }}>ì €ì¥</button>
                </div>
              </div>
            ) : (
              <div onClick={() => setIsEditing(true)} style={{ minHeight: 160, padding: 16, borderRadius: 12, background: '#F7F8FA', fontSize: 14, lineHeight: 1.8, color: note ? '#191F28' : '#8B95A1', whiteSpace: 'pre-wrap', cursor: 'pointer', border: '2px dashed transparent', transition: 'border-color 0.2s' }} onMouseEnter={(e) => e.target.style.borderColor = '#D1D6DB'} onMouseLeave={(e) => e.target.style.borderColor = 'transparent'}>
                {note || 'ë©”ëª¨ë¥¼ ì‘ì„±í•˜ë ¤ë©´ í´ë¦­í•˜ì„¸ìš”...'}
              </div>
            )}
            
            {/* ì²¨ë¶€íŒŒì¼ ì˜ì—­ */}
            <div style={{ marginTop: 24 }}>
              <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', marginBottom: 12 }}>
                <span style={{ fontSize: 14, fontWeight: 600, color: '#191F28' }}>ì²¨ë¶€íŒŒì¼</span>
                <button 
                  onClick={() => !isUploading && fileInputRef.current?.click()} 
                  disabled={isUploading}
                  style={{ display: 'flex', alignItems: 'center', gap: 4, padding: '6px 12px', borderRadius: 6, border: 'none', background: isUploading ? '#E5E8EB' : '#EBF4FF', color: isUploading ? '#8B95A1' : '#3182F6', fontSize: 13, fontWeight: 500, cursor: isUploading ? 'not-allowed' : 'pointer' }}
                >
                  <Icon name="paperclip" size={14} color={isUploading ? '#8B95A1' : '#3182F6'} /> {isUploading ? 'ì—…ë¡œë“œ ì¤‘...' : 'ì¶”ê°€'}
                </button>
                <input 
                  ref={fileInputRef}
                  type="file" 
                  multiple
                  onChange={handleFileSelect}
                  style={{ display: 'none' }}
                />
              </div>
              
              {attachments.length === 0 ? (
                <div 
                  onClick={() => fileInputRef.current?.click()}
                  style={{ padding: 20, borderRadius: 12, background: '#F7F8FA', border: '2px dashed #E5E8EB', textAlign: 'center', cursor: 'pointer' }}
                >
                  <Icon name="paperclip" size={24} color="#D1D6DB" />
                  <p style={{ fontSize: 13, color: '#8B95A1', marginTop: 8 }}>íŒŒì¼ì„ ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­í•´ì„œ ì¶”ê°€í•˜ì„¸ìš”</p>
                </div>
              ) : (
                <div style={{ display: 'flex', flexDirection: 'column', gap: 8 }}>
                  {attachments.map(file => (
                    <div key={file.id} style={{ display: 'flex', alignItems: 'center', gap: 10, padding: '10px 12px', borderRadius: 8, background: '#F0F7FF', border: '1px solid #DBEAFE' }}>
                      <Icon name="fileText" size={18} color="#3182F6" />
                      {file.url ? (
                        <a 
                          href={file.url} 
                          download={file.name}
                          target="_blank"
                          rel="noopener noreferrer"
                          style={{ flex: 1, fontSize: 13, color: '#3182F6', overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap', textDecoration: 'none', cursor: 'pointer' }}
                          title="í´ë¦­í•˜ì—¬ ë‹¤ìš´ë¡œë“œ"
                        >{file.name}</a>
                      ) : (
                        <span style={{ flex: 1, fontSize: 13, color: '#8B95A1', overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap' }} title="ë‹¤ì‹œ ì—…ë¡œë“œ í•„ìš”">{file.name} (ì¬ì—…ë¡œë“œ í•„ìš”)</span>
                      )}
                      <span style={{ fontSize: 11, color: '#8B95A1' }}>{(file.size / 1024).toFixed(1)}KB</span>
                      <button onClick={() => removeAttachment(file.id)} style={{ width: 24, height: 24, borderRadius: 6, border: 'none', background: '#FEE4E2', display: 'flex', alignItems: 'center', justifyContent: 'center', cursor: 'pointer' }}>
                        <Icon name="x" size={12} color="#F04452" />
                      </button>
                    </div>
                  ))}
                </div>
              )}
            </div>
          </div>

          <div style={{ padding: '16px 24px', borderTop: '1px solid #E5E8EB', background: '#FAFBFC' }}>
            <p style={{ fontSize: 12, color: '#8B95A1', textAlign: 'center' }}>ğŸ’¡ ë©”ëª¨ ì˜ì—­ì„ í´ë¦­í•˜ë©´ ë°”ë¡œ ìˆ˜ì •í•  ìˆ˜ ìˆì–´ìš”</p>
          </div>
        </div>
        </>
      );
    }

    function TaskModal({ task, date, onSave, onClose }) {
      const [form, setForm] = useState({ title: task?.title || '', projectId: task?.projectId || null, date: task?.date || date, note: task?.note || '', bookmark: task?.bookmark || false });
      return (
        <div onClick={onClose} style={{ position: 'fixed', inset: 0, background: 'rgba(0,0,0,0.5)', display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 1000 }}>
          <div onClick={(e) => e.stopPropagation()} style={{ background: 'white', borderRadius: 20, padding: 24, width: '100%', maxWidth: 420, maxHeight: '90vh', overflow: 'auto' }}>
            <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', marginBottom: 20 }}>
              <h3 style={{ fontSize: 18, fontWeight: 700, color: '#191F28' }}>{task ? 'ì—…ë¬´ ìˆ˜ì •' : 'ì—…ë¬´ ì¶”ê°€'}</h3>
              <button onClick={onClose} style={{ width: 32, height: 32, borderRadius: 8, border: 'none', background: '#F7F8FA', display: 'flex', alignItems: 'center', justifyContent: 'center' }}><Icon name="x" size={18} color="#8B95A1" /></button>
            </div>
            <div style={{ marginBottom: 16 }}>
              <label style={{ display: 'block', fontSize: 13, fontWeight: 600, color: '#191F28', marginBottom: 8 }}>ì—…ë¬´ëª… *</label>
              <input type="text" value={form.title} onChange={(e) => setForm({ ...form, title: e.target.value })} placeholder="ì—…ë¬´ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”" style={{ width: '100%', padding: '12px 14px', borderRadius: 10, border: '1px solid #E5E8EB', fontSize: 14 }} />
            </div>
            <div style={{ marginBottom: 16 }}>
              <label style={{ display: 'block', fontSize: 13, fontWeight: 600, color: '#191F28', marginBottom: 8 }}>í”„ë¡œì íŠ¸</label>
              <select value={form.projectId || ''} onChange={(e) => setForm({ ...form, projectId: e.target.value ? Number(e.target.value) : null })} style={{ width: '100%', padding: '12px 14px', borderRadius: 10, border: '1px solid #E5E8EB', fontSize: 14 }}>
                <option value="">ê°œì¸ ì—…ë¬´</option>
                {BRANDS.map(b => <option key={b.id} value={b.id}>{b.name}</option>)}
              </select>
            </div>
            <div style={{ marginBottom: 16 }}>
              <label style={{ display: 'block', fontSize: 13, fontWeight: 600, color: '#191F28', marginBottom: 8 }}>ë‚ ì§œ</label>
              <input type="date" value={form.date} onChange={(e) => setForm({ ...form, date: e.target.value })} style={{ width: '100%', padding: '12px 14px', borderRadius: 10, border: '1px solid #E5E8EB', fontSize: 14 }} />
            </div>
            <div style={{ marginBottom: 16 }}>
              <label style={{ display: 'block', fontSize: 13, fontWeight: 600, color: '#191F28', marginBottom: 8 }}>ë©”ëª¨</label>
              <textarea value={form.note} onChange={(e) => setForm({ ...form, note: e.target.value })} placeholder="ë©”ëª¨ë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì„ íƒì‚¬í•­)" rows={3} style={{ width: '100%', padding: '12px 14px', borderRadius: 10, border: '1px solid #E5E8EB', fontSize: 14, resize: 'none', lineHeight: 1.5 }} />
            </div>
            <label style={{ display: 'flex', alignItems: 'center', gap: 8, marginBottom: 20, cursor: 'pointer' }}>
              <input type="checkbox" checked={form.bookmark} onChange={(e) => setForm({ ...form, bookmark: e.target.checked })} style={{ width: 18, height: 18 }} />
              <span style={{ fontSize: 14, color: '#191F28' }}>ì¤‘ìš” ì—…ë¬´ë¡œ í‘œì‹œ</span>
            </label>
            <div style={{ display: 'flex', gap: 12 }}>
              <button onClick={onClose} style={{ flex: 1, padding: 14, borderRadius: 10, border: '1px solid #E5E8EB', background: 'white', fontSize: 14, fontWeight: 600, color: '#6B7684' }}>ì·¨ì†Œ</button>
              <button onClick={() => form.title.trim() && onSave({ ...task, ...form })} disabled={!form.title.trim()} style={{ flex: 1, padding: 14, borderRadius: 10, border: 'none', background: form.title.trim() ? '#3182F6' : '#E5E8EB', fontSize: 14, fontWeight: 600, color: form.title.trim() ? 'white' : '#8B95A1' }}>{task ? 'ìˆ˜ì •' : 'ì¶”ê°€'}</button>
            </div>
          </div>
        </div>
      );
    }

    // ============ í”„ë¡œì íŠ¸ íƒ­ ============
    function ProjectTab({ projects, setProjects, tasks, setTasks, currentUser, readComments, setReadComments }) {
      const [selectedBrand, setSelectedBrand] = useState(null);
      const [selectedProject, setSelectedProject] = useState(null);
      const [showAddProject, setShowAddProject] = useState(false);
      const [filterStatus, setFilterStatus] = useState('progress');
      const [searchQuery, setSearchQuery] = useState('');
      const [searchDate, setSearchDate] = useState('');
      const [isTeamExpanded, setIsTeamExpanded] = useState(false);

      const filteredProjects = useMemo(() => { 
        let r = projects; 
        if (selectedBrand) r = r.filter(p => p.brandId === selectedBrand); 
        if (filterStatus) r = r.filter(p => p.status === filterStatus); 
        // í…ìŠ¤íŠ¸ ê²€ìƒ‰ í•„í„°
        if (searchQuery.trim()) {
          const q = searchQuery.toLowerCase();
          r = r.filter(p => 
            p.title.toLowerCase().includes(q) || 
            p.description?.toLowerCase().includes(q)
          );
        }
        // ë‚ ì§œ ê²€ìƒ‰ í•„í„° (ì™„ë£Œ íƒ­ì—ì„œë§Œ ì‚¬ìš©, completedDate ê¸°ì¤€)
        if (searchDate && filterStatus === 'complete') {
          r = r.filter(p => p.completedDate && p.completedDate.startsWith(searchDate.slice(0, 7)));
        }
        return r; 
      }, [projects, selectedBrand, filterStatus, searchQuery, searchDate]);
      const getProjectStats = (pid) => { const pt = tasks.filter(t => t.projectId === pid); return { total: pt.length, completed: pt.filter(t => t.completed).length }; };
      const getUnreadCount = (pid) => { const p = projects.find(x => x.id === pid); return p ? Math.max(0, p.comments.length - (readComments[pid] || 0)) : 0; };
      const openProject = (p) => { setSelectedProject(p); setReadComments(prev => ({ ...prev, [p.id]: p.comments.length })); };
      const addProject = (p) => setProjects(prev => [...prev, { ...p, id: Date.now(), comments: [], creatorId: currentUser.id }]);
      const updateProject = (p) => { setProjects(prev => prev.map(x => x.id === p.id ? { ...x, ...p } : x)); if (selectedProject?.id === p.id) setSelectedProject(prev => ({ ...prev, ...p })); };
      const deleteProject = (pid) => { setProjects(prev => prev.filter(p => p.id !== pid)); setTasks(prev => prev.filter(t => t.projectId !== pid)); };
      const addComment = (pid, text, file = null) => { const nc = { id: Date.now(), memberId: currentUser.id, text, file, createdAt: new Date().toISOString() }; setProjects(prev => prev.map(p => p.id === pid ? { ...p, comments: [...p.comments, nc] } : p)); setReadComments(prev => ({ ...prev, [pid]: (prev[pid] || 0) + 1 })); if (selectedProject?.id === pid) setSelectedProject(prev => ({ ...prev, comments: [...prev.comments, nc] })); };
      const updateComment = (pid, cid, text) => { setProjects(prev => prev.map(p => p.id === pid ? { ...p, comments: p.comments.map(c => c.id === cid ? { ...c, text, editedAt: new Date().toISOString() } : c) } : p)); if (selectedProject?.id === pid) setSelectedProject(prev => ({ ...prev, comments: prev.comments.map(c => c.id === cid ? { ...c, text, editedAt: new Date().toISOString() } : c) })); };
      const deleteComment = (pid, cid) => { setProjects(prev => prev.map(p => p.id === pid ? { ...p, comments: p.comments.filter(c => c.id !== cid) } : p)); setReadComments(prev => ({ ...prev, [pid]: Math.max(0, (prev[pid] || 0) - 1) })); if (selectedProject?.id === pid) setSelectedProject(prev => ({ ...prev, comments: prev.comments.filter(c => c.id !== cid) })); };
      const addTask = (t) => { const pt = tasks.filter(x => x.projectId === t.projectId); const mx = Math.max(...pt.map(x => x.order), -1); setTasks(prev => [...prev, { ...t, id: Date.now(), order: mx + 1, completed: false, note: '', bookmark: false }]); };
      const toggleTaskComplete = (id) => setTasks(prev => prev.map(t => t.id === id ? { ...t, completed: !t.completed } : t));
      const deleteTask = (id) => setTasks(prev => prev.filter(t => t.id !== id));
      const updateTask = (updatedTask) => setTasks(prev => prev.map(t => t.id === updatedTask.id ? { ...t, ...updatedTask } : t));
      const reorderTasks = (updates) => setTasks(prev => prev.map(t => { const u = updates.find(x => x.id === t.id); return u ? { ...t, order: u.order } : t; }));

      // ë‚´ê°€ ì°¸ì—¬í•œ í”„ë¡œì íŠ¸ (ë‚´ê°€ ë§Œë“  í”„ë¡œì íŠ¸ OR ë‚´ê°€ ë‹´ë‹¹ìì¸ ì—…ë¬´ê°€ ìˆëŠ” í”„ë¡œì íŠ¸)
      const myTaskProjectIds = [...new Set(tasks.filter(t => t.memberId === currentUser.id).map(t => t.projectId))];
      const myProjects = filteredProjects.filter(p => p.creatorId === currentUser.id || myTaskProjectIds.includes(p.id));
      const teamProjects = filteredProjects.filter(p => p.creatorId !== currentUser.id && !myTaskProjectIds.includes(p.id));

      // í”„ë¡œì íŠ¸ ì¹´ë“œ ì»´í¬ë„ŒíŠ¸
      const ProjectCard = ({ project }) => {
        const st = getProjectStats(project.id), unread = getUnreadCount(project.id), brand = BRANDS.find(b => b.id === project.brandId), status = STATUS_OPTIONS.find(s => s.id === project.status), prog = st.total > 0 ? Math.round((st.completed / st.total) * 100) : 0;
        const memberIds = [...new Set(tasks.filter(t => t.projectId === project.id).map(t => t.memberId))], members = TEAM_MEMBERS.filter(m => memberIds.includes(m.id));
        const projectMembers = project.memberIds ? TEAM_MEMBERS.filter(m => project.memberIds.includes(m.id)) : [];
        return (
          <div onClick={() => openProject(project)} style={{ background: 'white', borderRadius: 16, padding: 20, cursor: 'pointer', border: '1px solid #E5E8EB', position: 'relative' }}>
            {unread > 0 && <div style={{ position: 'absolute', top: -8, right: -8, minWidth: 22, height: 22, borderRadius: 11, background: '#F04452', color: 'white', display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: 12, fontWeight: 700, padding: '0 6px' }}>{unread}</div>}
            <div style={{ display: 'flex', alignItems: 'center', gap: 8, marginBottom: 12 }}>
              <span style={{ padding: '4px 10px', borderRadius: 6, background: `${brand.color}15`, color: brand.color, fontSize: 11, fontWeight: 700 }}>{brand.name}</span>
              <span style={{ display: 'flex', alignItems: 'center', gap: 4, padding: '4px 8px', borderRadius: 6, background: status.bg, color: status.color, fontSize: 11, fontWeight: 600 }}><Icon name={status.icon} size={12} color={status.color} /> {status.label}</span>
            </div>
            <div style={{ display: 'flex', alignItems: 'center', gap: 10, marginBottom: 6 }}>
              <h3 style={{ fontSize: 17, fontWeight: 700, color: '#191F28' }}>{project.title}</h3>
              {projectMembers.length > 0 && (
                <div style={{ display: 'flex' }}>
                  {projectMembers.slice(0, 3).map((m, i) => <div key={m.id} style={{ width: 22, height: 22, borderRadius: '50%', background: m.color, color: 'white', display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: 9, fontWeight: 700, marginLeft: i > 0 ? -6 : 0, border: '2px solid white' }}>{m.initial}</div>)}
                  {projectMembers.length > 3 && <div style={{ width: 22, height: 22, borderRadius: '50%', background: '#E5E8EB', color: '#6B7684', display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: 9, fontWeight: 600, marginLeft: -6, border: '2px solid white' }}>+{projectMembers.length - 3}</div>}
                </div>
              )}
            </div>
            <p style={{ fontSize: 13, color: '#6B7684', marginBottom: 16, display: '-webkit-box', WebkitLineClamp: 2, WebkitBoxOrient: 'vertical', overflow: 'hidden' }}>{project.description}</p>
            {st.total > 0 && (
              <div style={{ marginBottom: 16 }}>
                <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: 6 }}><span style={{ fontSize: 12, color: '#8B95A1' }}>ì—…ë¬´ ì§„í–‰ë¥ </span><span style={{ fontSize: 12, fontWeight: 600, color: '#191F28' }}>{st.completed}/{st.total}</span></div>
                <div style={{ height: 6, background: '#F2F3F5', borderRadius: 3 }}><div style={{ height: '100%', borderRadius: 3, background: prog === 100 ? '#00C471' : '#3182F6', width: `${prog}%` }} /></div>
              </div>
            )}
            <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between' }}>
              <div style={{ display: 'flex' }}>{members.slice(0, 4).map((m, i) => <div key={m.id} style={{ width: 26, height: 26, borderRadius: '50%', background: m.color, color: 'white', display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: 10, fontWeight: 700, marginLeft: i > 0 ? -6 : 0, border: '2px solid white' }}>{m.initial}</div>)}</div>
              <div style={{ display: 'flex', alignItems: 'center', gap: 10 }}>
                {project.createdDate && <span style={{ display: 'flex', alignItems: 'center', gap: 4, fontSize: 12, color: '#8B95A1' }}><Icon name="calendar" size={13} color="#8B95A1" /> {formatShortDate(project.createdDate)}</span>}
                {project.completedDate && <span style={{ display: 'flex', alignItems: 'center', gap: 4, fontSize: 12, color: '#00C471' }}><Icon name="checkCircle" size={13} color="#00C471" /> {formatShortDate(project.completedDate)}</span>}
                <span style={{ display: 'flex', alignItems: 'center', gap: 4, fontSize: 12, color: unread > 0 ? '#F04452' : '#8B95A1' }}><Icon name="message" size={13} color={unread > 0 ? '#F04452' : '#8B95A1'} /> {project.comments.length}</span>
              </div>
            </div>
          </div>
        );
      };

      return (
        <div style={{ minHeight: '100vh' }}>
          <header style={{ background: 'white', borderBottom: '1px solid #E5E8EB', padding: '20px 32px' }}>
            <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', marginBottom: 20 }}>
              <h1 style={{ fontSize: 24, fontWeight: 700, color: '#191F28' }}>í”„ë¡œì íŠ¸</h1>
              <button onClick={() => setShowAddProject(true)} style={{ display: 'flex', alignItems: 'center', gap: 6, padding: '10px 18px', borderRadius: 10, background: '#3182F6', border: 'none', color: 'white', fontSize: 14, fontWeight: 600 }}><Icon name="plus" size={18} color="white" /> ìƒˆ í”„ë¡œì íŠ¸</button>
            </div>
            <div style={{ display: 'flex', gap: 12, marginBottom: 16 }}>
              <button onClick={() => setSelectedBrand(null)} style={{ padding: '10px 20px', borderRadius: 10, border: selectedBrand === null ? '2px solid #191F28' : '1px solid #E5E8EB', background: selectedBrand === null ? '#191F28' : 'white', fontSize: 14, fontWeight: 600, color: selectedBrand === null ? 'white' : '#6B7684' }}>ì „ì²´ ë¸Œëœë“œ</button>
              {BRANDS.map(b => <button key={b.id} onClick={() => setSelectedBrand(selectedBrand === b.id ? null : b.id)} style={{ padding: '10px 20px', borderRadius: 10, border: selectedBrand === b.id ? `2px solid ${b.color}` : '1px solid #E5E8EB', background: selectedBrand === b.id ? `${b.color}15` : 'white', fontSize: 14, fontWeight: 600, color: selectedBrand === b.id ? b.color : '#6B7684' }}>{b.name}</button>)}
            </div>
            <div style={{ display: 'flex', gap: 8 }}>
              <button onClick={() => setFilterStatus(null)} style={{ padding: '8px 14px', borderRadius: 8, border: filterStatus === null ? '1.5px solid #3182F6' : '1px solid #E5E8EB', background: filterStatus === null ? '#EBF4FF' : 'white', fontSize: 13, fontWeight: 500, color: filterStatus === null ? '#3182F6' : '#6B7684' }}>ì „ì²´</button>
              {STATUS_OPTIONS.map(s => <button key={s.id} onClick={() => setFilterStatus(filterStatus === s.id ? null : s.id)} style={{ padding: '8px 14px', borderRadius: 8, border: filterStatus === s.id ? `1.5px solid ${s.color}` : '1px solid #E5E8EB', background: filterStatus === s.id ? s.bg : 'white', fontSize: 13, fontWeight: 500, color: filterStatus === s.id ? s.color : '#6B7684' }}>{s.label}</button>)}
            </div>
          </header>

          <div style={{ padding: 32 }}>
            {/* ë‚´ í”„ë¡œì íŠ¸ ì„¹ì…˜ */}
            <div style={{ marginBottom: 40 }}>
              <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', marginBottom: 16 }}>
                <div style={{ display: 'flex', alignItems: 'center', gap: 10 }}>
                  <div style={{ width: 32, height: 32, borderRadius: '50%', background: currentUser.color, color: 'white', display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: 13, fontWeight: 700 }}>{currentUser.initial}</div>
                  <h2 style={{ fontSize: 18, fontWeight: 700, color: '#191F28' }}>ë‚´ í”„ë¡œì íŠ¸</h2>
                  <span style={{ padding: '4px 10px', borderRadius: 20, background: '#EBF4FF', color: '#3182F6', fontSize: 13, fontWeight: 600 }}>{myProjects.length}</span>
                </div>
              </div>
              
              {/* ê²€ìƒ‰ ì˜ì—­ - ì™„ë£Œ í•„í„°ì¼ ë•Œë§Œ í‘œì‹œ */}
              {filterStatus === 'complete' && (
                <div style={{ display: 'flex', gap: 12, marginBottom: 16 }}>
                  {/* í…ìŠ¤íŠ¸ ê²€ìƒ‰ */}
                  <div style={{ flex: 1, display: 'flex', alignItems: 'center', gap: 10, padding: '12px 16px', background: '#F7F8FA', borderRadius: 12, border: '1px solid #E5E8EB' }}>
                    <Icon name="search" size={18} color="#8B95A1" />
                    <input 
                      type="text" 
                      value={searchQuery} 
                      onChange={(e) => setSearchQuery(e.target.value)} 
                      placeholder="í”„ë¡œì íŠ¸ëª…ìœ¼ë¡œ ê²€ìƒ‰" 
                      style={{ flex: 1, border: 'none', background: 'transparent', fontSize: 14, outline: 'none' }} 
                    />
                    {searchQuery && (
                      <button onClick={() => setSearchQuery('')} style={{ width: 20, height: 20, borderRadius: '50%', border: 'none', background: '#D1D6DB', display: 'flex', alignItems: 'center', justifyContent: 'center' }}>
                        <Icon name="x" size={12} color="white" />
                      </button>
                    )}
                  </div>
                  {/* ë…„ì›” ì„ íƒ ë“œë¡­ë‹¤ìš´ */}
                  <div style={{ display: 'flex', alignItems: 'center', gap: 8 }}>
                    <select 
                      value={searchDate ? searchDate.slice(0, 4) : ''} 
                      onChange={(e) => {
                        if (e.target.value) {
                          const month = searchDate ? searchDate.slice(5, 7) : '01';
                          setSearchDate(`${e.target.value}-${month}-01`);
                        } else {
                          setSearchDate('');
                        }
                      }}
                      style={{ padding: '12px 14px', borderRadius: 10, border: '1px solid #E5E8EB', background: 'white', fontSize: 14, color: '#191F28' }}
                    >
                      <option value="">ë…„ë„</option>
                      {[2024, 2025, 2026].map(y => <option key={y} value={y}>{y}ë…„</option>)}
                    </select>
                    <select 
                      value={searchDate ? searchDate.slice(5, 7) : ''} 
                      onChange={(e) => {
                        if (e.target.value) {
                          const year = searchDate ? searchDate.slice(0, 4) : '2025';
                          setSearchDate(`${year}-${e.target.value}-01`);
                        } else {
                          setSearchDate('');
                        }
                      }}
                      style={{ padding: '12px 14px', borderRadius: 10, border: '1px solid #E5E8EB', background: 'white', fontSize: 14, color: '#191F28' }}
                    >
                      <option value="">ì›”</option>
                      {[...Array(12)].map((_, i) => <option key={i} value={String(i + 1).padStart(2, '0')}>{i + 1}ì›”</option>)}
                    </select>
                    {searchDate && (
                      <button onClick={() => setSearchDate('')} style={{ width: 32, height: 32, borderRadius: 8, border: '1px solid #E5E8EB', background: 'white', display: 'flex', alignItems: 'center', justifyContent: 'center' }}>
                        <Icon name="x" size={14} color="#8B95A1" />
                      </button>
                    )}
                  </div>
                </div>
              )}

              {myProjects.length === 0 ? (
                <div style={{ background: '#F7F8FA', borderRadius: 16, padding: '40px 20px', textAlign: 'center', border: '1px dashed #D1D6DB' }}>
                  <Icon name="user" size={36} color="#D1D6DB" />
                  <p style={{ fontSize: 14, color: '#8B95A1', marginTop: 12 }}>{(searchQuery || searchDate) ? 'ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤' : 'ì°¸ì—¬ ì¤‘ì¸ í”„ë¡œì íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤'}</p>
                </div>
              ) : filterStatus === 'complete' ? (
                /* ì™„ë£Œ ìƒíƒœ - ë¦¬ìŠ¤íŠ¸ í˜•ì‹ */
                <div style={{ background: 'white', borderRadius: 16, border: '1px solid #E5E8EB', overflow: 'hidden' }}>
                  {myProjects.map((project, idx) => {
                    const st = getProjectStats(project.id), unread = getUnreadCount(project.id), brand = BRANDS.find(b => b.id === project.brandId), status = STATUS_OPTIONS.find(s => s.id === project.status), prog = st.total > 0 ? Math.round((st.completed / st.total) * 100) : 0;
                    return (
                      <div 
                        key={project.id} 
                        onClick={() => openProject(project)} 
                        style={{ 
                          display: 'flex', alignItems: 'center', gap: 16, padding: '16px 20px', 
                          borderBottom: idx < myProjects.length - 1 ? '1px solid #F2F3F5' : 'none',
                          cursor: 'pointer', position: 'relative',
                          background: 'white', transition: 'background 0.2s'
                        }}
                        onMouseEnter={(e) => e.currentTarget.style.background = '#FAFBFC'}
                        onMouseLeave={(e) => e.currentTarget.style.background = 'white'}
                      >
                        {unread > 0 && <div style={{ position: 'absolute', left: 8, top: '50%', transform: 'translateY(-50%)', width: 8, height: 8, borderRadius: '50%', background: '#F04452' }} />}
                        
                        {/* ë¸Œëœë“œ & ìƒíƒœ */}
                        <div style={{ display: 'flex', flexDirection: 'column', gap: 4, minWidth: 100 }}>
                          <span style={{ padding: '3px 8px', borderRadius: 4, background: `${brand.color}15`, color: brand.color, fontSize: 11, fontWeight: 700, alignSelf: 'flex-start' }}>{brand.name}</span>
                          <span style={{ display: 'flex', alignItems: 'center', gap: 3, fontSize: 11, color: status.color }}><Icon name={status.icon} size={10} color={status.color} /> {status.label}</span>
                        </div>
                        
                        {/* í”„ë¡œì íŠ¸ ì •ë³´ */}
                        <div style={{ flex: 1, minWidth: 0 }}>
                          <h3 style={{ fontSize: 15, fontWeight: 600, color: '#191F28', marginBottom: 4, overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap' }}>{project.title}</h3>
                          <p style={{ fontSize: 13, color: '#8B95A1', overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap' }}>{project.description || '-'}</p>
                        </div>
                        
                        {/* ì§„í–‰ë¥  */}
                        {st.total > 0 && (
                          <div style={{ width: 100 }}>
                            <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: 4 }}>
                              <span style={{ fontSize: 11, color: '#8B95A1' }}>ì§„í–‰ë¥ </span>
                              <span style={{ fontSize: 11, fontWeight: 600, color: '#191F28' }}>{prog}%</span>
                            </div>
                            <div style={{ height: 4, background: '#F2F3F5', borderRadius: 2 }}>
                              <div style={{ height: '100%', borderRadius: 2, background: prog === 100 ? '#00C471' : '#3182F6', width: `${prog}%` }} />
                            </div>
                          </div>
                        )}
                        
                        {/* ì™„ë£Œì¼ */}
                        <div style={{ minWidth: 80, textAlign: 'right' }}>
                          {project.completedDate && <span style={{ fontSize: 12, color: '#00C471' }}>{formatShortDate(project.completedDate)}</span>}
                        </div>
                        
                        {/* ëŒ“ê¸€ */}
                        <div style={{ display: 'flex', alignItems: 'center', gap: 4, minWidth: 40 }}>
                          <Icon name="message" size={14} color={unread > 0 ? '#F04452' : '#D1D6DB'} />
                          <span style={{ fontSize: 12, color: unread > 0 ? '#F04452' : '#8B95A1' }}>{project.comments.length}</span>
                        </div>
                        
                        <Icon name="chevronRight" size={16} color="#D1D6DB" />
                      </div>
                    );
                  })}
                </div>
              ) : (
                /* ì§„í–‰ì¤‘/ë³´ë¥˜/ì „ì²´ - ì¹´ë“œ í˜•ì‹ */
                <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(320px, 1fr))', gap: 20 }}>
                  {myProjects.map(project => <ProjectCard key={project.id} project={project} />)}
                </div>
              )}
            </div>

            {/* íŒ€ í”„ë¡œì íŠ¸ ì„¹ì…˜ - ì ‘ê¸°/í¼ì¹˜ê¸° */}
            <div>
              <button 
                onClick={() => setIsTeamExpanded(!isTeamExpanded)}
                style={{ 
                  display: 'flex', alignItems: 'center', gap: 10, width: '100%', padding: '12px 0',
                  background: 'none', border: 'none', cursor: 'pointer', marginBottom: isTeamExpanded ? 16 : 0
                }}
              >
                <div style={{ width: 32, height: 32, borderRadius: 8, background: '#F2F3F5', display: 'flex', alignItems: 'center', justifyContent: 'center' }}>
                  <Icon name="users" size={18} color="#6B7684" />
                </div>
                <h2 style={{ fontSize: 18, fontWeight: 700, color: '#191F28' }}>íŒ€ í”„ë¡œì íŠ¸</h2>
                <span style={{ padding: '4px 10px', borderRadius: 20, background: '#F2F3F5', color: '#6B7684', fontSize: 13, fontWeight: 600 }}>{teamProjects.length}</span>
                <div style={{ marginLeft: 'auto', transform: isTeamExpanded ? 'rotate(180deg)' : 'rotate(0deg)', transition: 'transform 0.2s' }}>
                  <Icon name="chevronDown" size={20} color="#8B95A1" />
                </div>
              </button>
              
              {isTeamExpanded && (
                teamProjects.length === 0 ? (
                  <div style={{ background: '#F7F8FA', borderRadius: 16, padding: '40px 20px', textAlign: 'center', border: '1px dashed #D1D6DB' }}>
                    <Icon name="folder" size={36} color="#D1D6DB" />
                    <p style={{ fontSize: 14, color: '#8B95A1', marginTop: 12 }}>ë‹¤ë¥¸ íŒ€ í”„ë¡œì íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤</p>
                  </div>
                ) : filterStatus === 'complete' ? (
                  /* ì™„ë£Œ ìƒíƒœ - ë¦¬ìŠ¤íŠ¸ í˜•ì‹ */
                  <div style={{ background: 'white', borderRadius: 16, border: '1px solid #E5E8EB', overflow: 'hidden' }}>
                    {teamProjects.map((project, idx) => {
                      const st = getProjectStats(project.id), unread = getUnreadCount(project.id), brand = BRANDS.find(b => b.id === project.brandId), status = STATUS_OPTIONS.find(s => s.id === project.status), prog = st.total > 0 ? Math.round((st.completed / st.total) * 100) : 0;
                      return (
                        <div 
                          key={project.id} 
                          onClick={() => openProject(project)} 
                          style={{ 
                            display: 'flex', alignItems: 'center', gap: 16, padding: '16px 20px', 
                            borderBottom: idx < teamProjects.length - 1 ? '1px solid #F2F3F5' : 'none',
                            cursor: 'pointer', position: 'relative',
                            background: 'white', transition: 'background 0.2s'
                          }}
                          onMouseEnter={(e) => e.currentTarget.style.background = '#FAFBFC'}
                          onMouseLeave={(e) => e.currentTarget.style.background = 'white'}
                        >
                          {unread > 0 && <div style={{ position: 'absolute', left: 8, top: '50%', transform: 'translateY(-50%)', width: 8, height: 8, borderRadius: '50%', background: '#F04452' }} />}
                          <div style={{ display: 'flex', flexDirection: 'column', gap: 4, minWidth: 100 }}>
                            <span style={{ padding: '3px 8px', borderRadius: 4, background: `${brand.color}15`, color: brand.color, fontSize: 11, fontWeight: 700, alignSelf: 'flex-start' }}>{brand.name}</span>
                            <span style={{ display: 'flex', alignItems: 'center', gap: 3, fontSize: 11, color: status.color }}><Icon name={status.icon} size={10} color={status.color} /> {status.label}</span>
                          </div>
                          <div style={{ flex: 1, minWidth: 0 }}>
                            <h3 style={{ fontSize: 15, fontWeight: 600, color: '#191F28', marginBottom: 4, overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap' }}>{project.title}</h3>
                            <p style={{ fontSize: 13, color: '#8B95A1', overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap' }}>{project.description || '-'}</p>
                          </div>
                          {st.total > 0 && (
                            <div style={{ width: 100 }}>
                              <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: 4 }}>
                                <span style={{ fontSize: 11, color: '#8B95A1' }}>ì§„í–‰ë¥ </span>
                                <span style={{ fontSize: 11, fontWeight: 600, color: '#191F28' }}>{prog}%</span>
                              </div>
                              <div style={{ height: 4, background: '#F2F3F5', borderRadius: 2 }}>
                                <div style={{ height: '100%', borderRadius: 2, background: prog === 100 ? '#00C471' : '#3182F6', width: `${prog}%` }} />
                              </div>
                            </div>
                          )}
                          <div style={{ minWidth: 80, textAlign: 'right' }}>
                            {project.completedDate && <span style={{ fontSize: 12, color: '#00C471' }}>{formatShortDate(project.completedDate)}</span>}
                          </div>
                          <div style={{ display: 'flex', alignItems: 'center', gap: 4, minWidth: 40 }}>
                            <Icon name="message" size={14} color={unread > 0 ? '#F04452' : '#D1D6DB'} />
                            <span style={{ fontSize: 12, color: unread > 0 ? '#F04452' : '#8B95A1' }}>{project.comments.length}</span>
                          </div>
                          <Icon name="chevronRight" size={16} color="#D1D6DB" />
                        </div>
                      );
                    })}
                  </div>
                ) : (
                  /* ì§„í–‰ì¤‘/ë³´ë¥˜/ì „ì²´ - ì¹´ë“œ í˜•ì‹ */
                  <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(320px, 1fr))', gap: 20 }}>
                    {teamProjects.map(project => <ProjectCard key={project.id} project={project} />)}
                  </div>
                )
              )}
            </div>
          </div>

          {selectedProject && <ProjectDetailSlide project={selectedProject} tasks={tasks.filter(t => t.projectId === selectedProject.id)} currentUser={currentUser} onClose={() => setSelectedProject(null)} onAddComment={(t, f) => addComment(selectedProject.id, t, f)} onUpdateComment={(cid, t) => updateComment(selectedProject.id, cid, t)} onDeleteComment={(cid) => deleteComment(selectedProject.id, cid)} onAddTask={(t) => addTask({ ...t, projectId: selectedProject.id })} onToggleTask={toggleTaskComplete} onDeleteTask={deleteTask} onUpdateTask={updateTask} onUpdateProject={updateProject} onDeleteProject={deleteProject} onReorderTasks={reorderTasks} />}
          {showAddProject && <ProjectModal project={null} onSave={(p) => { addProject(p); setShowAddProject(false); }} onClose={() => setShowAddProject(false)} />}
        </div>
      );
    }

    function ProjectDetailSlide({ project, tasks, currentUser, onClose, onAddComment, onUpdateComment, onDeleteComment, onAddTask, onToggleTask, onDeleteTask, onUpdateTask, onUpdateProject, onDeleteProject, onReorderTasks }) {
      const [activeTab, setActiveTab] = useState('tasks');
      const [comment, setComment] = useState('');
      const [showAddTask, setShowAddTask] = useState(false);
      const [addingSubtaskParentId, setAddingSubtaskParentId] = useState(null);
      const [editingTaskId, setEditingTaskId] = useState(null);
      const [editingCommentId, setEditingCommentId] = useState(null);
      const [editText, setEditText] = useState('');
      const [showEditProject, setShowEditProject] = useState(false);
      const [showDeleteConfirm, setShowDeleteConfirm] = useState(false);
      const [draggedTask, setDraggedTask] = useState(null);
      const [dragOverId, setDragOverId] = useState(null);
      const [attachedFile, setAttachedFile] = useState(null);
      const [selectedSubTask, setSelectedSubTask] = useState(null);
      const fileInputRef = React.useRef(null);
      
      const brand = BRANDS.find(b => b.id === project.brandId);
      const sorted = [...tasks].sort((a, b) => a.order - b.order);
      const comp = tasks.filter(t => t.completed).length, prog = tasks.length > 0 ? Math.round((comp / tasks.length) * 100) : 0;

      // íŒŒì¼ ì„ íƒ í•¸ë“¤ëŸ¬
      const handleFileSelect = (e) => {
        const file = e.target.files[0];
        if (file) {
          setAttachedFile({ name: file.name, size: file.size, type: file.type });
        }
      };
      
      // ëŒ“ê¸€ ë“±ë¡ í•¸ë“¤ëŸ¬
      const handleSubmitComment = () => {
        if (comment.trim() || attachedFile) {
          onAddComment(comment.trim(), attachedFile);
          setComment('');
          setAttachedFile(null);
        }
      };

      // ìƒíƒœ ë³€ê²½ í•¸ë“¤ëŸ¬
      const handleStatusChange = (newStatus) => {
        const updates = { ...project, status: newStatus };
        if (newStatus === 'complete') {
          updates.completedDate = today;
        } else {
          updates.completedDate = null;
        }
        onUpdateProject(updates);
      };

      // ë“œë˜ê·¸ ì•¤ ë“œë¡­ í•¸ë“¤ëŸ¬
      const handleDragStart = (e, task) => { setDraggedTask(task); e.dataTransfer.effectAllowed = 'move'; };
      const handleDragOver = (e, task) => { e.preventDefault(); if (!draggedTask || draggedTask.id === task.id) return; setDragOverId(task.id); };
      const handleDragLeave = () => setDragOverId(null);
      const handleDrop = (e, targetTask) => {
        e.preventDefault();
        setDragOverId(null);
        if (!draggedTask || draggedTask.id === targetTask.id) return;
        
        const newTasks = [...sorted];
        const dragIdx = newTasks.findIndex(t => t.id === draggedTask.id);
        const targetIdx = newTasks.findIndex(t => t.id === targetTask.id);
        newTasks.splice(dragIdx, 1);
        newTasks.splice(targetIdx, 0, draggedTask);
        
        onReorderTasks(newTasks.map((t, i) => ({ id: t.id, order: i })));
        setDraggedTask(null);
      };
      const handleDragEnd = () => { setDraggedTask(null); setDragOverId(null); };

      return (
        <div onClick={onClose} style={{ position: 'fixed', inset: 0, background: 'rgba(0,0,0,0.4)', display: 'flex', justifyContent: 'flex-end', zIndex: 1000 }}>
          <div onClick={(e) => e.stopPropagation()} style={{ width: '100%', maxWidth: 600, height: '100%', background: 'white', display: 'flex', flexDirection: 'column', animation: 'slideIn 0.3s ease' }}>
            <div style={{ padding: '20px 24px', borderBottom: '1px solid #E5E8EB' }}>
              {/* ìƒë‹¨: ë’¤ë¡œê°€ê¸° + ì œëª© + ìˆ˜ì •/ì‚­ì œ */}
              <div style={{ display: 'flex', alignItems: 'center', gap: 12, marginBottom: 12 }}>
                <button onClick={onClose} style={{ width: 36, height: 36, borderRadius: 10, border: 'none', background: '#F7F8FA', display: 'flex', alignItems: 'center', justifyContent: 'center' }}><Icon name="chevronLeft" size={20} color="#6B7684" /></button>
                <div style={{ flex: 1 }}>
                  <span style={{ padding: '3px 8px', borderRadius: 4, background: `${brand.color}15`, color: brand.color, fontSize: 11, fontWeight: 700 }}>{brand.name}</span>
                  <div style={{ display: 'flex', alignItems: 'center', gap: 10, marginTop: 4 }}>
                    <h2 style={{ fontSize: 18, fontWeight: 700, color: '#191F28' }}>{project.title}</h2>
                    {project.memberIds && project.memberIds.length > 0 && (
                      <div style={{ display: 'flex' }}>
                        {TEAM_MEMBERS.filter(m => project.memberIds.includes(m.id)).slice(0, 4).map((m, i) => (
                          <div key={m.id} style={{ width: 24, height: 24, borderRadius: '50%', background: m.color, color: 'white', display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: 10, fontWeight: 700, marginLeft: i > 0 ? -6 : 0, border: '2px solid white' }}>{m.initial}</div>
                        ))}
                        {project.memberIds.length > 4 && <div style={{ width: 24, height: 24, borderRadius: '50%', background: '#E5E8EB', color: '#6B7684', display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: 9, fontWeight: 600, marginLeft: -6, border: '2px solid white' }}>+{project.memberIds.length - 4}</div>}
                      </div>
                    )}
                  </div>
                </div>
                <button onClick={() => setShowEditProject(true)} style={{ width: 36, height: 36, borderRadius: 10, border: 'none', background: '#F7F8FA', display: 'flex', alignItems: 'center', justifyContent: 'center' }}><Icon name="edit" size={18} color="#6B7684" /></button>
                <button onClick={() => setShowDeleteConfirm(true)} style={{ width: 36, height: 36, borderRadius: 10, border: 'none', background: '#FEE4E2', display: 'flex', alignItems: 'center', justifyContent: 'center' }}><Icon name="trash" size={18} color="#F04452" /></button>
              </div>
              
              {/* ìƒíƒœ ì„ íƒ ë²„íŠ¼ */}
              <div style={{ display: 'flex', gap: 8, marginBottom: 12 }}>
                {STATUS_OPTIONS.map(s => (
                  <button 
                    key={s.id} 
                    onClick={() => handleStatusChange(s.id)}
                    style={{ 
                      display: 'flex', alignItems: 'center', gap: 6, 
                      padding: '8px 14px', borderRadius: 8, 
                      border: project.status === s.id ? `2px solid ${s.color}` : '1px solid #E5E8EB', 
                      background: project.status === s.id ? s.bg : 'white', 
                      color: project.status === s.id ? s.color : '#6B7684', 
                      fontSize: 13, fontWeight: 600 
                    }}
                  >
                    <Icon name={s.icon} size={14} color={project.status === s.id ? s.color : '#8B95A1'} />
                    {s.label}
                  </button>
                ))}
              </div>
              
              {/* í”„ë¡œì íŠ¸ ì„¤ëª… */}
              {project.description && (
                <div style={{ background: '#F7F8FA', borderRadius: 10, padding: 14, marginBottom: 12 }}>
                  <p style={{ fontSize: 13, color: '#4B5563', lineHeight: 1.6 }}>{project.description}</p>
                </div>
              )}
              
              {/* ë‚ ì§œ ì •ë³´ */}
              <div style={{ display: 'flex', gap: 16, marginBottom: 12 }}>
                {project.createdDate && (
                  <span style={{ display: 'flex', alignItems: 'center', gap: 6, fontSize: 13, color: '#6B7684' }}>
                    <Icon name="calendar" size={14} color="#8B95A1" /> ë“±ë¡ì¼: {formatShortDate(project.createdDate)}
                  </span>
                )}
                {project.completedDate && (
                  <span style={{ display: 'flex', alignItems: 'center', gap: 6, fontSize: 13, color: '#00C471' }}>
                    <Icon name="checkCircle" size={14} color="#00C471" /> ì™„ë£Œì¼: {formatShortDate(project.completedDate)}
                  </span>
                )}
              </div>
              
              {tasks.length > 0 && (
                <div>
                  <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: 6 }}><span style={{ fontSize: 13, color: '#6B7684' }}>ì—…ë¬´ ì§„í–‰ë¥ </span><span style={{ fontSize: 13, fontWeight: 600, color: '#191F28' }}>{comp}/{tasks.length} ({prog}%)</span></div>
                  <div style={{ height: 8, background: '#F2F3F5', borderRadius: 4 }}><div style={{ height: '100%', borderRadius: 4, background: prog === 100 ? '#00C471' : '#3182F6', width: `${prog}%` }} /></div>
                </div>
              )}
            </div>

            <div style={{ display: 'flex', borderBottom: '1px solid #E5E8EB' }}>
              <button onClick={() => setActiveTab('tasks')} style={{ flex: 1, padding: 14, border: 'none', background: 'white', fontSize: 14, fontWeight: 600, color: activeTab === 'tasks' ? '#3182F6' : '#8B95A1', borderBottom: activeTab === 'tasks' ? '2px solid #3182F6' : '2px solid transparent' }}>í•˜ìœ„ì—…ë¬´ ({tasks.length})</button>
              <button onClick={() => setActiveTab('comments')} style={{ flex: 1, padding: 14, border: 'none', background: 'white', fontSize: 14, fontWeight: 600, color: activeTab === 'comments' ? '#3182F6' : '#8B95A1', borderBottom: activeTab === 'comments' ? '2px solid #3182F6' : '2px solid transparent' }}>ëŒ“ê¸€ ({project.comments.length})</button>
            </div>

            <div style={{ flex: 1, overflow: 'auto', padding: 20 }}>
              {activeTab === 'tasks' ? (
                <>
                  <button onClick={() => { setShowAddTask(true); setAddingSubtaskParentId(null); }} style={{ display: 'flex', alignItems: 'center', justifyContent: 'center', gap: 8, width: '100%', padding: 14, marginBottom: 16, border: '2px dashed #D1D6DB', borderRadius: 12, background: '#FAFBFC', fontSize: 14, fontWeight: 500, color: '#6B7684' }}><Icon name="plus" size={18} color="#6B7684" /> í•˜ìœ„ì—…ë¬´ ì¶”ê°€</button>
                  {sorted.filter(t => !t.parentTaskId).length === 0 ? <p style={{ textAlign: 'center', color: '#8B95A1', padding: '40px 0' }}>ë“±ë¡ëœ í•˜ìœ„ì—…ë¬´ê°€ ì—†ìŠµë‹ˆë‹¤</p> : (
                    <div style={{ display: 'flex', flexDirection: 'column', gap: 8 }}>
                      {sorted.filter(t => !t.parentTaskId).map(t => {
                        const m = TEAM_MEMBERS.find(x => x.id === t.memberId);
                        const isDragging = draggedTask?.id === t.id;
                        const isDragOver = dragOverId === t.id;
                        const subtasks = sorted.filter(st => st.parentTaskId === t.id);
                        const completedSubtasks = subtasks.filter(st => st.completed).length;
                        return (
                          <div key={t.id}>
                            <div 
                              draggable
                              onDragStart={(e) => handleDragStart(e, t)}
                              onDragOver={(e) => handleDragOver(e, t)}
                              onDragLeave={handleDragLeave}
                              onDrop={(e) => handleDrop(e, t)}
                              onDragEnd={handleDragEnd}
                              style={{ 
                                display: 'flex', alignItems: 'center', gap: 12, padding: '14px 16px', 
                                background: isDragOver ? '#EBF4FF' : 'white', 
                                border: isDragOver ? '2px solid #3182F6' : '1px solid #E5E8EB', 
                                borderRadius: 12,
                                opacity: isDragging ? 0.5 : 1,
                                cursor: 'grab'
                              }}
                            >
                              <Icon name="grip" size={16} color="#D1D6DB" />
                              <button onClick={() => onToggleTask(t.id)} style={{ width: 22, height: 22, borderRadius: 6, border: t.completed ? 'none' : '2px solid #D1D6DB', background: t.completed ? '#3182F6' : 'white', display: 'flex', alignItems: 'center', justifyContent: 'center', flexShrink: 0 }}>{t.completed && <Icon name="check" size={14} color="white" />}</button>
                              <div onClick={() => setSelectedSubTask(t)} style={{ flex: 1, minWidth: 0, cursor: 'pointer' }}>
                                <div style={{ display: 'flex', alignItems: 'center', gap: 6 }}>
                                  <p style={{ fontSize: 14, fontWeight: 500, color: t.completed ? '#8B95A1' : '#191F28', textDecoration: t.completed ? 'line-through' : 'none' }}>{t.title}</p>
                                  {t.note && <Icon name="fileText" size={14} color="#3182F6" />}
                                  {t.attachments && t.attachments.length > 0 && <Icon name="paperclip" size={14} color="#8B95A1" />}
                                  {subtasks.length > 0 && <span style={{ fontSize: 11, padding: '2px 6px', borderRadius: 4, background: '#F0F7FF', color: '#3182F6', fontWeight: 600 }}>{completedSubtasks}/{subtasks.length}</span>}
                                </div>
                                <p style={{ fontSize: 12, color: '#8B95A1', marginTop: 2 }}>{formatShortDate(t.date)}</p>
                              </div>
                              {m && <div style={{ width: 28, height: 28, borderRadius: '50%', background: m.color, color: 'white', display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: 11, fontWeight: 700, flexShrink: 0 }}>{m.initial}</div>}
                              <button onClick={() => { setShowAddTask(true); setAddingSubtaskParentId(t.id); }} title="ì„œë¸ŒíƒœìŠ¤í¬ ì¶”ê°€" style={{ width: 28, height: 28, borderRadius: 6, border: 'none', background: '#F0F7FF', display: 'flex', alignItems: 'center', justifyContent: 'center', flexShrink: 0 }}><Icon name="plus" size={14} color="#3182F6" /></button>
                              <button onClick={() => setEditingTaskId(t.id)} style={{ width: 28, height: 28, borderRadius: 6, border: 'none', background: '#F7F8FA', display: 'flex', alignItems: 'center', justifyContent: 'center', flexShrink: 0 }}><Icon name="edit" size={14} color="#6B7684" /></button>
                              <button onClick={() => onDeleteTask(t.id)} style={{ width: 28, height: 28, borderRadius: 6, border: 'none', background: '#FEE4E2', display: 'flex', alignItems: 'center', justifyContent: 'center', flexShrink: 0 }}><Icon name="trash" size={14} color="#F04452" /></button>
                            </div>
                            {/* ì„œë¸ŒíƒœìŠ¤í¬ ëª©ë¡ */}
                            {subtasks.length > 0 && (
                              <div style={{ marginLeft: 32, marginTop: 4, display: 'flex', flexDirection: 'column', gap: 4 }}>
                                {subtasks.map(st => {
                                  const stm = TEAM_MEMBERS.find(x => x.id === st.memberId);
                                  return (
                                    <div key={st.id} style={{ display: 'flex', alignItems: 'center', gap: 10, padding: '10px 14px', background: '#FAFBFC', border: '1px solid #E5E8EB', borderRadius: 10 }}>
                                      <div style={{ width: 2, height: 20, background: '#D1D6DB', borderRadius: 1 }} />
                                      <button onClick={() => onToggleTask(st.id)} style={{ width: 18, height: 18, borderRadius: 4, border: st.completed ? 'none' : '2px solid #D1D6DB', background: st.completed ? '#00C471' : 'white', display: 'flex', alignItems: 'center', justifyContent: 'center', flexShrink: 0 }}>{st.completed && <Icon name="check" size={12} color="white" />}</button>
                                      <div onClick={() => setSelectedSubTask(st)} style={{ flex: 1, minWidth: 0, cursor: 'pointer' }}>
                                        <p style={{ fontSize: 13, fontWeight: 500, color: st.completed ? '#8B95A1' : '#191F28', textDecoration: st.completed ? 'line-through' : 'none' }}>{st.title}</p>
                                      </div>
                                      {stm && <div style={{ width: 24, height: 24, borderRadius: '50%', background: stm.color, color: 'white', display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: 10, fontWeight: 700, flexShrink: 0 }}>{stm.initial}</div>}
                                      <button onClick={() => setEditingTaskId(st.id)} style={{ width: 24, height: 24, borderRadius: 6, border: 'none', background: '#F7F8FA', display: 'flex', alignItems: 'center', justifyContent: 'center', flexShrink: 0 }}><Icon name="edit" size={12} color="#6B7684" /></button>
                                      <button onClick={() => onDeleteTask(st.id)} style={{ width: 24, height: 24, borderRadius: 6, border: 'none', background: '#FEE4E2', display: 'flex', alignItems: 'center', justifyContent: 'center', flexShrink: 0 }}><Icon name="trash" size={12} color="#F04452" /></button>
                                    </div>
                                  );
                                })}
                              </div>
                            )}
                          </div>
                        );
                      })}
                    </div>
                  )}
                </>
              ) : (
                <>
                  <div style={{ display: 'flex', flexDirection: 'column', gap: 16 }}>
                    {project.comments.length === 0 ? <p style={{ textAlign: 'center', color: '#8B95A1', padding: '40px 0' }}>ì•„ì§ ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤</p> : project.comments.map(c => {
                      const a = TEAM_MEMBERS.find(m => m.id === c.memberId), isMy = c.memberId === currentUser.id, isEdit = editingCommentId === c.id;
                      return (
                        <div key={c.id} style={{ display: 'flex', gap: 12 }}>
                          <div style={{ width: 32, height: 32, borderRadius: '50%', background: a?.color || '#8B95A1', color: 'white', display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: 12, fontWeight: 700, flexShrink: 0 }}>{a?.initial || '?'}</div>
                          <div style={{ flex: 1 }}>
                            <div style={{ display: 'flex', alignItems: 'center', gap: 8, marginBottom: 4 }}>
                              <span style={{ fontSize: 14, fontWeight: 600, color: '#191F28' }}>{a?.name}</span>
                              <span style={{ fontSize: 12, color: '#8B95A1' }}>{formatDateTime(c.createdAt)}</span>
                              {c.editedAt && <span style={{ fontSize: 11, color: '#B0B8C1' }}>(ìˆ˜ì •ë¨)</span>}
                              {isMy && !isEdit && <div style={{ marginLeft: 'auto', display: 'flex', gap: 4 }}><button onClick={() => { setEditingCommentId(c.id); setEditText(c.text); }} style={{ padding: '4px 8px', borderRadius: 6, border: 'none', background: '#F7F8FA', fontSize: 12, color: '#6B7684' }}>ìˆ˜ì •</button><button onClick={() => onDeleteComment(c.id)} style={{ padding: '4px 8px', borderRadius: 6, border: 'none', background: '#FEE4E2', fontSize: 12, color: '#F04452' }}>ì‚­ì œ</button></div>}
                            </div>
                            {isEdit ? (
                              <div><textarea value={editText} onChange={(e) => setEditText(e.target.value)} style={{ width: '100%', padding: '10px 12px', borderRadius: 8, border: '1px solid #3182F6', fontSize: 14, resize: 'none', minHeight: 60 }} autoFocus /><div style={{ display: 'flex', gap: 8, marginTop: 8 }}><button onClick={() => setEditingCommentId(null)} style={{ padding: '8px 14px', borderRadius: 8, border: '1px solid #E5E8EB', background: 'white', fontSize: 13, color: '#6B7684' }}>ì·¨ì†Œ</button><button onClick={() => { if (editText.trim()) { onUpdateComment(c.id, editText.trim()); setEditingCommentId(null); } }} style={{ padding: '8px 14px', borderRadius: 8, border: 'none', background: '#3182F6', fontSize: 13, color: 'white' }}>ì €ì¥</button></div></div>
                            ) : (
                              <>
                                {c.text && <p style={{ fontSize: 14, color: '#4B5563', lineHeight: 1.5 }}>{c.text}</p>}
                                {c.file && (
                                  <div style={{ display: 'inline-flex', alignItems: 'center', gap: 6, marginTop: c.text ? 8 : 0, padding: '8px 12px', background: '#F0F7FF', borderRadius: 8, cursor: 'pointer' }}>
                                    <Icon name="fileText" size={16} color="#3182F6" />
                                    <span style={{ fontSize: 13, color: '#3182F6', fontWeight: 500 }}>{c.file.name}</span>
                                  </div>
                                )}
                              </>
                            )}
                          </div>
                        </div>
                      );
                    })}
                  </div>
                </>
              )}
            </div>

            {activeTab === 'comments' && (
              <div style={{ padding: 16, borderTop: '1px solid #E5E8EB' }}>
                {/* ì²¨ë¶€ íŒŒì¼ ë¯¸ë¦¬ë³´ê¸° */}
                {attachedFile && (
                  <div style={{ display: 'flex', alignItems: 'center', gap: 8, marginBottom: 12, padding: '8px 12px', background: '#F0F7FF', borderRadius: 8 }}>
                    <Icon name="fileText" size={16} color="#3182F6" />
                    <span style={{ flex: 1, fontSize: 13, color: '#3182F6', overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap' }}>{attachedFile.name}</span>
                    <button onClick={() => setAttachedFile(null)} style={{ width: 20, height: 20, borderRadius: 4, border: 'none', background: '#E5E8EB', display: 'flex', alignItems: 'center', justifyContent: 'center', cursor: 'pointer' }}><Icon name="x" size={12} color="#6B7684" /></button>
                  </div>
                )}
                <div style={{ display: 'flex', alignItems: 'center', gap: 12 }}>
                  <div style={{ width: 36, height: 36, borderRadius: '50%', background: currentUser.color, color: 'white', display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: 13, fontWeight: 700 }}>{currentUser.initial}</div>
                  <div style={{ flex: 1, display: 'flex', alignItems: 'center', background: '#F7F8FA', borderRadius: 12, padding: '4px 4px 4px 16px' }}>
                    <input type="text" value={comment} onChange={(e) => setComment(e.target.value)} onKeyDown={(e) => { if (e.key === 'Enter' && (comment.trim() || attachedFile)) { handleSubmitComment(); } }} placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”..." style={{ flex: 1, border: 'none', background: 'transparent', fontSize: 14, padding: '10px 0' }} />
                    <input type="file" ref={fileInputRef} onChange={handleFileSelect} style={{ display: 'none' }} />
                    <button onClick={() => fileInputRef.current?.click()} style={{ width: 36, height: 36, borderRadius: 8, border: 'none', background: 'transparent', display: 'flex', alignItems: 'center', justifyContent: 'center', cursor: 'pointer' }}><Icon name="paperclip" size={18} color="#8B95A1" /></button>
                    <button onClick={handleSubmitComment} disabled={!comment.trim() && !attachedFile} style={{ width: 36, height: 36, borderRadius: 8, border: 'none', background: (comment.trim() || attachedFile) ? '#3182F6' : '#E5E8EB', display: 'flex', alignItems: 'center', justifyContent: 'center' }}><Icon name="send" size={16} color={(comment.trim() || attachedFile) ? 'white' : '#8B95A1'} /></button>
                  </div>
                </div>
              </div>
            )}

            {/* í•˜ìœ„ì—…ë¬´ ìƒì„¸ ë³´ê¸° ëª¨ë‹¬ - ì¸ë¼ì¸ í¸ì§‘ ê°€ëŠ¥ */}
            {selectedSubTask && (
              <SubTaskDetailModal 
                task={selectedSubTask}
                brand={brand}
                project={project}
                onClose={() => setSelectedSubTask(null)}
                onToggle={() => { onToggleTask(selectedSubTask.id); setSelectedSubTask(prev => ({ ...prev, completed: !prev.completed })); }}
                onSave={(updated) => { onUpdateTask(updated); setSelectedSubTask(updated); }}
                onDelete={() => { if(confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) { onDeleteTask(selectedSubTask.id); setSelectedSubTask(null); } }}
                onEdit={() => { setEditingTaskId(selectedSubTask.id); setSelectedSubTask(null); }}
              />
            )}

            {showAddTask && <SubTaskModal parentTaskId={addingSubtaskParentId} onSave={(t) => { onAddTask({ ...t, parentTaskId: addingSubtaskParentId }); setShowAddTask(false); setAddingSubtaskParentId(null); }} onClose={() => { setShowAddTask(false); setAddingSubtaskParentId(null); }} />}
            
            {/* í•˜ìœ„ì—…ë¬´ ìˆ˜ì • ëª¨ë‹¬ */}
            {editingTaskId && <SubTaskModal task={sorted.find(t => t.id === editingTaskId)} onSave={(t) => { onUpdateTask(t); setEditingTaskId(null); }} onClose={() => setEditingTaskId(null)} />}
            
            {/* í”„ë¡œì íŠ¸ ìˆ˜ì • ëª¨ë‹¬ */}
            {showEditProject && <ProjectModal project={project} onSave={(p) => { onUpdateProject(p); setShowEditProject(false); }} onClose={() => setShowEditProject(false)} />}
            
            {/* ì‚­ì œ í™•ì¸ ëª¨ë‹¬ */}
            {showDeleteConfirm && (
              <div onClick={() => setShowDeleteConfirm(false)} style={{ position: 'fixed', inset: 0, background: 'rgba(0,0,0,0.5)', display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 1100 }}>
                <div onClick={(e) => e.stopPropagation()} style={{ background: 'white', borderRadius: 20, padding: 24, width: '100%', maxWidth: 360 }}>
                  <h3 style={{ fontSize: 18, fontWeight: 700, color: '#191F28', marginBottom: 12 }}>í”„ë¡œì íŠ¸ ì‚­ì œ</h3>
                  <p style={{ fontSize: 14, color: '#6B7684', marginBottom: 24, lineHeight: 1.6 }}>
                    <strong>"{project.title}"</strong> í”„ë¡œì íŠ¸ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?<br/>
                    <span style={{ color: '#F04452' }}>í•˜ìœ„ ì—…ë¬´ë„ í•¨ê»˜ ì‚­ì œë©ë‹ˆë‹¤.</span>
                  </p>
                  <div style={{ display: 'flex', gap: 12 }}>
                    <button onClick={() => setShowDeleteConfirm(false)} style={{ flex: 1, padding: 14, borderRadius: 10, border: '1px solid #E5E8EB', background: 'white', fontSize: 14, fontWeight: 600, color: '#6B7684' }}>ì·¨ì†Œ</button>
                    <button onClick={() => { onDeleteProject(project.id); onClose(); }} style={{ flex: 1, padding: 14, borderRadius: 10, border: 'none', background: '#F04452', fontSize: 14, fontWeight: 600, color: 'white' }}>ì‚­ì œ</button>
                  </div>
                </div>
              </div>
            )}
          </div>
        </div>
      );
    }

    // í•˜ìœ„ì—…ë¬´ ìƒì„¸ ëª¨ë‹¬ (ì¸ë¼ì¸ í¸ì§‘ ê°€ëŠ¥)
    function SubTaskDetailModal({ task, brand, project, onClose, onToggle, onSave, onDelete, onEdit }) {
      const [note, setNote] = useState(task.note || '');
      const [attachments, setAttachments] = useState(task.attachments || []);
      const [hasChanges, setHasChanges] = useState(false);
      const [isUploading, setIsUploading] = useState(false);
      const fileInputRef = React.useRef(null);
      const m = TEAM_MEMBERS.find(x => x.id === task.memberId);
      
      const handleNoteChange = (e) => {
        setNote(e.target.value);
        setHasChanges(true);
      };
      
      const handleFileSelect = async (e) => {
        const files = Array.from(e.target.files);
        if (files.length === 0) return;
        
        setIsUploading(true);
        
        for (const file of files) {
          try {
            // Firebase Storageì— ì—…ë¡œë“œ
            const path = `attachments/tasks/${task.id}/${Date.now()}_${file.name}`;
            const result = await FirebaseService.uploadFile(file, path);
            
            if (result) {
              setAttachments(prev => [...prev, {
                id: Date.now() + Math.random(),
                name: result.name,
                size: result.size,
                type: result.type,
                url: result.url,
                path: path
              }]);
              setHasChanges(true);
            }
          } catch (error) {
            console.error('File upload error:', error);
            alert('íŒŒì¼ ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
          }
        }
        
        setIsUploading(false);
        e.target.value = '';
      };
      
      const removeAttachment = async (attachment) => {
        // Firebase Storageì—ì„œ íŒŒì¼ ì‚­ì œ
        if (attachment.path) {
          await FirebaseService.deleteFile(attachment.path);
        }
        setAttachments(prev => prev.filter(a => a.id !== attachment.id));
        setHasChanges(true);
      };
      
      const handleSave = () => {
        onSave({ ...task, note, attachments });
        setHasChanges(false);
      };
      
      return (
        <div onClick={onClose} style={{ position: 'fixed', inset: 0, background: 'rgba(0,0,0,0.4)', display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 1100 }}>
          <div onClick={(e) => e.stopPropagation()} style={{ background: 'white', borderRadius: 20, padding: 24, width: '100%', maxWidth: 480, maxHeight: '85vh', overflow: 'auto' }}>
            <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', marginBottom: 20 }}>
              <h2 style={{ fontSize: 18, fontWeight: 700, color: '#191F28' }}>ğŸ“‹ í•˜ìœ„ì—…ë¬´ ìƒì„¸</h2>
              <button onClick={onClose} style={{ width: 32, height: 32, borderRadius: 8, border: 'none', background: '#F7F8FA', display: 'flex', alignItems: 'center', justifyContent: 'center', cursor: 'pointer' }}><Icon name="x" size={18} color="#8B95A1" /></button>
            </div>
            
            {/* ì—…ë¡œë“œ ì¤‘ í‘œì‹œ */}
            {isUploading && (
              <div style={{ position: 'absolute', inset: 0, background: 'rgba(255,255,255,0.8)', display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 10, borderRadius: 20 }}>
                <div style={{ textAlign: 'center' }}>
                  <div className="loading-spinner" style={{ margin: '0 auto 12px' }}></div>
                  <p style={{ fontSize: 14, color: '#6B7684' }}>íŒŒì¼ ì—…ë¡œë“œ ì¤‘...</p>
                </div>
              </div>
            )}
            
            {/* ì—…ë¬´ ì •ë³´ */}
            <div style={{ background: '#F7F8FA', borderRadius: 12, padding: 16, marginBottom: 16 }}>
              <div style={{ display: 'flex', alignItems: 'center', gap: 8, marginBottom: 12 }}>
                <span style={{ padding: '4px 10px', borderRadius: 6, background: `${brand.color}15`, color: brand.color, fontSize: 12, fontWeight: 600 }}>{brand.name}</span>
                <span style={{ padding: '4px 10px', borderRadius: 6, background: '#E5E8EB', color: '#6B7684', fontSize: 11, fontWeight: 600 }}>{project.title}</span>
              </div>
              <h3 style={{ fontSize: 18, fontWeight: 700, color: '#191F28', marginBottom: 8, textDecoration: task.completed ? 'line-through' : 'none' }}>{task.title}</h3>
              <div style={{ display: 'flex', alignItems: 'center', gap: 12 }}>
                <p style={{ fontSize: 14, color: '#6B7684' }}>ğŸ“… {formatShortDate(task.date)}</p>
                {m && <div style={{ display: 'flex', alignItems: 'center', gap: 6 }}><div style={{ width: 20, height: 20, borderRadius: '50%', background: m.color, color: 'white', display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: 9, fontWeight: 700 }}>{m.initial}</div><span style={{ fontSize: 12, color: '#6B7684' }}>{m.name}</span></div>}
              </div>
            </div>
            
            {/* ë©”ëª¨ ì˜ì—­ - í¸ì§‘ ê°€ëŠ¥ */}
            <div style={{ marginBottom: 16 }}>
              <div style={{ display: 'flex', alignItems: 'center', gap: 6, marginBottom: 8 }}>
                <Icon name="fileText" size={16} color="#F59E0B" />
                <span style={{ fontSize: 13, fontWeight: 600, color: '#92400E' }}>ë©”ëª¨</span>
              </div>
              <textarea 
                value={note} 
                onChange={handleNoteChange}
                placeholder="ë©”ëª¨ë¥¼ ì…ë ¥í•˜ì„¸ìš”..."
                rows={4}
                style={{ width: '100%', padding: '14px 16px', borderRadius: 12, border: '1px solid #E5E8EB', fontSize: 14, resize: 'none', lineHeight: 1.6, background: '#FFFBEB' }}
              />
            </div>
            
            {/* ì²¨ë¶€íŒŒì¼ ì˜ì—­ - ì¶”ê°€/ì‚­ì œ ê°€ëŠ¥ */}
            <div style={{ marginBottom: 16 }}>
              <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', marginBottom: 8 }}>
                <div style={{ display: 'flex', alignItems: 'center', gap: 6 }}>
                  <Icon name="paperclip" size={16} color="#3182F6" />
                  <span style={{ fontSize: 13, fontWeight: 600, color: '#1E40AF' }}>ì²¨ë¶€íŒŒì¼ {attachments.length > 0 && `(${attachments.length})`}</span>
                </div>
                <button onClick={() => fileInputRef.current?.click()} style={{ display: 'flex', alignItems: 'center', gap: 4, padding: '6px 12px', borderRadius: 6, border: 'none', background: '#EBF4FF', color: '#3182F6', fontSize: 12, fontWeight: 500, cursor: 'pointer' }}>
                  <Icon name="plus" size={14} color="#3182F6" /> íŒŒì¼ ì¶”ê°€
                </button>
                <input ref={fileInputRef} type="file" multiple onChange={handleFileSelect} style={{ display: 'none' }} />
              </div>
              
              {attachments.length === 0 ? (
                <div onClick={() => fileInputRef.current?.click()} style={{ padding: 20, borderRadius: 12, background: '#F0F7FF', border: '2px dashed #DBEAFE', textAlign: 'center', cursor: 'pointer' }}>
                  <Icon name="paperclip" size={24} color="#93C5FD" />
                  <p style={{ fontSize: 13, color: '#6B7684', marginTop: 8 }}>í´ë¦­í•˜ì—¬ íŒŒì¼ì„ ì²¨ë¶€í•˜ì„¸ìš”</p>
                </div>
              ) : (
                <div style={{ display: 'flex', flexDirection: 'column', gap: 8, background: '#F0F7FF', borderRadius: 12, padding: 12, border: '1px solid #DBEAFE' }}>
                  {attachments.map(file => (
                    <div key={file.id} style={{ display: 'flex', alignItems: 'center', gap: 10, padding: '10px 12px', borderRadius: 8, background: 'white', border: '1px solid #E5E8EB' }}>
                      <Icon name="fileText" size={18} color="#3182F6" />
                      {file.url ? (
                        <a href={file.url} target="_blank" rel="noopener noreferrer" style={{ flex: 1, fontSize: 13, color: '#3182F6', overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap', textDecoration: 'none' }}>{file.name}</a>
                      ) : (
                        <span style={{ flex: 1, fontSize: 13, color: '#191F28', overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap' }}>{file.name}</span>
                      )}
                      <span style={{ fontSize: 11, color: '#8B95A1' }}>{(file.size / 1024).toFixed(1)}KB</span>
                      <button onClick={() => removeAttachment(file)} style={{ width: 24, height: 24, borderRadius: 6, border: 'none', background: '#FEE4E2', display: 'flex', alignItems: 'center', justifyContent: 'center', cursor: 'pointer' }}>
                        <Icon name="x" size={14} color="#F04452" />
                      </button>
                    </div>
                  ))}
                </div>
              )}
            </div>
            
            {/* ì €ì¥ ë²„íŠ¼ (ë³€ê²½ì‚¬í•­ ìˆì„ ë•Œë§Œ í™œì„±í™”) */}
            {hasChanges && (
              <button onClick={handleSave} style={{ width: '100%', padding: 14, marginBottom: 12, borderRadius: 12, border: 'none', background: '#00C471', color: 'white', fontSize: 15, fontWeight: 600, display: 'flex', alignItems: 'center', justifyContent: 'center', gap: 8, cursor: 'pointer' }}>
                <Icon name="check" size={18} color="white" /> ë³€ê²½ì‚¬í•­ ì €ì¥
              </button>
            )}
            
            {/* ë²„íŠ¼ ì˜ì—­ */}
            <div style={{ display: 'flex', flexDirection: 'column', gap: 8 }}>
              <button onClick={onToggle} style={{ width: '100%', padding: 14, borderRadius: 12, border: 'none', background: task.completed ? '#F7F8FA' : '#3182F6', color: task.completed ? '#6B7684' : 'white', fontSize: 15, fontWeight: 600, display: 'flex', alignItems: 'center', justifyContent: 'center', gap: 8, cursor: 'pointer' }}>
                <Icon name="check" size={18} color={task.completed ? '#6B7684' : 'white'} /> {task.completed ? 'ì™„ë£Œ ì·¨ì†Œ' : 'ì™„ë£Œ ì²˜ë¦¬'}
              </button>
              
              <div style={{ display: 'flex', gap: 8 }}>
                <button onClick={onEdit} style={{ flex: 1, padding: 14, borderRadius: 12, border: '1px solid #E5E8EB', background: 'white', color: '#191F28', fontSize: 15, fontWeight: 600, display: 'flex', alignItems: 'center', justifyContent: 'center', gap: 8, cursor: 'pointer' }}>
                  <Icon name="edit" size={18} color="#6B7684" /> ìƒì„¸ ìˆ˜ì •
                </button>
                <button onClick={onDelete} style={{ flex: 1, padding: 14, borderRadius: 12, border: 'none', background: '#FEE4E2', color: '#F04452', fontSize: 15, fontWeight: 600, display: 'flex', alignItems: 'center', justifyContent: 'center', gap: 8, cursor: 'pointer' }}>
                  <Icon name="trash" size={18} color="#F04452" /> ì‚­ì œ
                </button>
              </div>
            </div>
          </div>
        </div>
      );
    }

    function SubTaskModal({ task, parentTaskId, onSave, onClose }) {
      const [form, setForm] = useState({ 
        title: task?.title || '', 
        memberId: task?.memberId || null, 
        date: task?.date || today,
        note: task?.note || '',
        attachments: task?.attachments || []
      });
      const [pendingFiles, setPendingFiles] = useState([]); // ì—…ë¡œë“œ ëŒ€ê¸° ì¤‘ì¸ íŒŒì¼ë“¤
      const [isUploading, setIsUploading] = useState(false);
      const fileInputRef = React.useRef(null);
      const isEdit = !!task;
      const isSubtask = !!parentTaskId;
      
      const handleFileSelect = (e) => {
        const files = Array.from(e.target.files);
        // íŒŒì¼ ì •ë³´ë¥¼ ì„ì‹œë¡œ ì €ì¥ (ì‹¤ì œ ì—…ë¡œë“œëŠ” ì €ì¥ ì‹œ ì§„í–‰)
        const newAttachments = files.map(f => ({
          id: Date.now() + Math.random(),
          name: f.name,
          size: f.size,
          type: f.type,
          file: f  // ì‹¤ì œ íŒŒì¼ ê°ì²´ ë³´ê´€
        }));
        setForm(prev => ({ ...prev, attachments: [...prev.attachments, ...newAttachments] }));
        setPendingFiles(prev => [...prev, ...files]);
        e.target.value = '';
      };
      
      const removeAttachment = (id) => {
        const att = form.attachments.find(a => a.id === id);
        if (att && att.file) {
          // ëŒ€ê¸° ì¤‘ì¸ íŒŒì¼ì—ì„œë„ ì œê±°
          setPendingFiles(prev => prev.filter(f => f.name !== att.name));
        }
        setForm(prev => ({ ...prev, attachments: prev.attachments.filter(a => a.id !== id) }));
      };
      
      const handleSave = async () => {
        if (!form.title.trim() || !form.memberId) return;
        
        setIsUploading(true);
        
        // ìƒˆ íŒŒì¼ë“¤ ì—…ë¡œë“œ
        const uploadedAttachments = [];
        const taskId = task?.id || Date.now();
        
        for (const att of form.attachments) {
          if (att.file) {
            // ìƒˆë¡œ ì¶”ê°€ëœ íŒŒì¼ - Firebaseì— ì—…ë¡œë“œ
            try {
              const path = `attachments/subtasks/${taskId}/${Date.now()}_${att.file.name}`;
              const result = await FirebaseService.uploadFile(att.file, path);
              if (result) {
                uploadedAttachments.push({
                  id: att.id,
                  name: result.name,
                  size: result.size,
                  type: result.type,
                  url: result.url,
                  path: path
                });
              }
            } catch (error) {
              console.error('Upload error:', error);
            }
          } else {
            // ê¸°ì¡´ íŒŒì¼ - ê·¸ëŒ€ë¡œ ìœ ì§€
            uploadedAttachments.push(att);
          }
        }
        
        setIsUploading(false);
        onSave({ ...(task || {}), ...form, title: form.title.trim(), attachments: uploadedAttachments });
      };
      
      return (
        <div onClick={onClose} style={{ position: 'fixed', inset: 0, background: 'rgba(0,0,0,0.5)', display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 1100 }}>
          <div onClick={(e) => e.stopPropagation()} style={{ background: 'white', borderRadius: 20, padding: 24, width: '100%', maxWidth: 420, maxHeight: '90vh', overflow: 'auto', position: 'relative' }}>
            {/* ì—…ë¡œë“œ ì¤‘ í‘œì‹œ */}
            {isUploading && (
              <div style={{ position: 'absolute', inset: 0, background: 'rgba(255,255,255,0.9)', display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 10, borderRadius: 20 }}>
                <div style={{ textAlign: 'center' }}>
                  <div className="loading-spinner" style={{ margin: '0 auto 12px' }}></div>
                  <p style={{ fontSize: 14, color: '#6B7684' }}>íŒŒì¼ ì—…ë¡œë“œ ì¤‘...</p>
                </div>
              </div>
            )}
            <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', marginBottom: 20 }}><h3 style={{ fontSize: 18, fontWeight: 700, color: '#191F28' }}>{isEdit ? 'í•˜ìœ„ì—…ë¬´ ìˆ˜ì •' : isSubtask ? 'ì„œë¸ŒíƒœìŠ¤í¬ ì¶”ê°€' : 'í•˜ìœ„ì—…ë¬´ ì¶”ê°€'}</h3><button onClick={onClose} style={{ width: 32, height: 32, borderRadius: 8, border: 'none', background: '#F7F8FA', display: 'flex', alignItems: 'center', justifyContent: 'center', cursor: 'pointer' }}><Icon name="x" size={18} color="#8B95A1" /></button></div>
            <div style={{ marginBottom: 16 }}><label style={{ display: 'block', fontSize: 13, fontWeight: 600, marginBottom: 8 }}>ì—…ë¬´ëª… *</label><input type="text" value={form.title} onChange={(e) => setForm({ ...form, title: e.target.value })} placeholder="ì˜ˆ: ë””ìì¸ ì‹œì•ˆ ì œì‘" style={{ width: '100%', padding: '12px 14px', borderRadius: 10, border: '1px solid #E5E8EB', fontSize: 14 }} /></div>
            <div style={{ marginBottom: 16 }}><label style={{ display: 'block', fontSize: 13, fontWeight: 600, marginBottom: 8 }}>ë‹´ë‹¹ì *</label><div style={{ display: 'flex', gap: 8, flexWrap: 'wrap' }}>{TEAM_MEMBERS.map(m => <button key={m.id} onClick={() => setForm({ ...form, memberId: m.id })} style={{ display: 'flex', alignItems: 'center', gap: 6, padding: '8px 12px', borderRadius: 8, border: form.memberId === m.id ? `2px solid ${m.color}` : '1px solid #E5E8EB', background: form.memberId === m.id ? `${m.color}15` : 'white', cursor: 'pointer' }}><div style={{ width: 22, height: 22, borderRadius: '50%', background: m.color, color: 'white', display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: 10, fontWeight: 700 }}>{m.initial}</div><span style={{ fontSize: 13, fontWeight: 500, color: form.memberId === m.id ? '#191F28' : '#6B7684' }}>{m.name}</span></button>)}</div></div>
            <div style={{ marginBottom: 16 }}><label style={{ display: 'block', fontSize: 13, fontWeight: 600, marginBottom: 8 }}>ê¸°í•œ</label><input type="date" value={form.date} onChange={(e) => setForm({ ...form, date: e.target.value })} onClick={(e) => e.target.showPicker()} style={{ width: '100%', padding: '12px 14px', borderRadius: 10, border: '1px solid #E5E8EB', fontSize: 14, cursor: 'pointer' }} /></div>
            <div style={{ marginBottom: 16 }}><label style={{ display: 'block', fontSize: 13, fontWeight: 600, marginBottom: 8 }}>ë©”ëª¨ (ì„ íƒ)</label><textarea value={form.note} onChange={(e) => setForm({ ...form, note: e.target.value })} placeholder="ë©”ëª¨ë¥¼ ì…ë ¥í•˜ì„¸ìš”" rows={3} style={{ width: '100%', padding: '12px 14px', borderRadius: 10, border: '1px solid #E5E8EB', fontSize: 14, resize: 'none' }} /></div>
            
            {/* ì²¨ë¶€íŒŒì¼ ì˜ì—­ */}
            <div style={{ marginBottom: 24 }}>
              <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', marginBottom: 8 }}>
                <label style={{ fontSize: 13, fontWeight: 600 }}>ì²¨ë¶€íŒŒì¼ (ì„ íƒ)</label>
                <button onClick={() => fileInputRef.current?.click()} style={{ display: 'flex', alignItems: 'center', gap: 4, padding: '6px 12px', borderRadius: 6, border: 'none', background: '#EBF4FF', color: '#3182F6', fontSize: 12, fontWeight: 500, cursor: 'pointer' }}>
                  <Icon name="paperclip" size={14} color="#3182F6" /> íŒŒì¼ ì¶”ê°€
                </button>
                <input ref={fileInputRef} type="file" multiple onChange={handleFileSelect} style={{ display: 'none' }} />
              </div>
              
              {form.attachments.length === 0 ? (
                <div onClick={() => fileInputRef.current?.click()} style={{ padding: 16, borderRadius: 10, background: '#F7F8FA', border: '2px dashed #E5E8EB', textAlign: 'center', cursor: 'pointer' }}>
                  <Icon name="paperclip" size={20} color="#D1D6DB" />
                  <p style={{ fontSize: 12, color: '#8B95A1', marginTop: 6 }}>í´ë¦­í•˜ì—¬ íŒŒì¼ ì²¨ë¶€</p>
                </div>
              ) : (
                <div style={{ display: 'flex', flexDirection: 'column', gap: 6 }}>
                  {form.attachments.map(file => (
                    <div key={file.id} style={{ display: 'flex', alignItems: 'center', gap: 8, padding: '8px 10px', borderRadius: 8, background: '#F0F7FF', border: '1px solid #DBEAFE' }}>
                      <Icon name="fileText" size={16} color="#3182F6" />
                      <span style={{ flex: 1, fontSize: 12, color: '#191F28', overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap' }}>{file.name}</span>
                      <span style={{ fontSize: 10, color: '#8B95A1' }}>{(file.size / 1024).toFixed(1)}KB</span>
                      <button onClick={() => removeAttachment(file.id)} style={{ width: 20, height: 20, borderRadius: 4, border: 'none', background: '#FEE4E2', display: 'flex', alignItems: 'center', justifyContent: 'center', cursor: 'pointer' }}>
                        <Icon name="x" size={12} color="#F04452" />
                      </button>
                    </div>
                  ))}
                </div>
              )}
            </div>
            
            <div style={{ display: 'flex', gap: 12 }}><button onClick={onClose} style={{ flex: 1, padding: 14, borderRadius: 10, border: '1px solid #E5E8EB', background: 'white', fontSize: 14, fontWeight: 600, color: '#6B7684', cursor: 'pointer' }}>ì·¨ì†Œ</button><button onClick={handleSave} disabled={!form.title.trim() || !form.memberId} style={{ flex: 1, padding: 14, borderRadius: 10, border: 'none', background: (form.title.trim() && form.memberId) ? '#3182F6' : '#E5E8EB', fontSize: 14, fontWeight: 600, color: (form.title.trim() && form.memberId) ? 'white' : '#8B95A1', cursor: (form.title.trim() && form.memberId) ? 'pointer' : 'not-allowed' }}>{isEdit ? 'ìˆ˜ì •í•˜ê¸°' : 'ì¶”ê°€í•˜ê¸°'}</button></div>
          </div>
        </div>
      );
    }

    function ProjectModal({ project, onSave, onClose }) {
      const descriptionTemplate = `íƒ€ê²Ÿ : 
ëª©í‘œ : 
í”„ë¡œì íŠ¸ ì„¤ëª… : `;
      const [form, setForm] = useState({ 
        brandId: project?.brandId || BRANDS[0].id, 
        title: project?.title || '', 
        memberIds: project?.memberIds || [],
        description: project?.description || (project ? '' : descriptionTemplate), 
        status: project?.status || 'progress', 
        createdDate: project?.createdDate || today 
      });
      const isEdit = !!project;
      
      const toggleMember = (id) => {
        setForm(prev => ({
          ...prev,
          memberIds: prev.memberIds.includes(id) 
            ? prev.memberIds.filter(m => m !== id) 
            : [...prev.memberIds, id]
        }));
      };
      
      return (
        <div onClick={onClose} style={{ position: 'fixed', inset: 0, background: 'rgba(0,0,0,0.5)', display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 1100 }}>
          <div onClick={(e) => e.stopPropagation()} style={{ background: 'white', borderRadius: 20, padding: 28, width: '100%', maxWidth: 520, maxHeight: '90vh', overflow: 'auto' }}>
            <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', marginBottom: 24 }}><h2 style={{ fontSize: 20, fontWeight: 700, color: '#191F28' }}>{isEdit ? 'í”„ë¡œì íŠ¸ ìˆ˜ì •' : 'ìƒˆ í”„ë¡œì íŠ¸'}</h2><button onClick={onClose} style={{ width: 36, height: 36, borderRadius: 10, border: 'none', background: '#F7F8FA', display: 'flex', alignItems: 'center', justifyContent: 'center' }}><Icon name="x" size={20} color="#8B95A1" /></button></div>
            <div style={{ marginBottom: 20 }}><label style={{ display: 'block', fontSize: 14, fontWeight: 600, marginBottom: 8 }}>ë¸Œëœë“œ *</label><div style={{ display: 'flex', gap: 8 }}>{BRANDS.map(b => <button key={b.id} onClick={() => setForm({ ...form, brandId: b.id })} style={{ padding: '10px 16px', borderRadius: 10, border: form.brandId === b.id ? `2px solid ${b.color}` : '1px solid #E5E8EB', background: form.brandId === b.id ? `${b.color}15` : 'white', color: form.brandId === b.id ? b.color : '#6B7684', fontSize: 14, fontWeight: 500 }}>{b.name}</button>)}</div></div>
            <div style={{ marginBottom: 20 }}><label style={{ display: 'block', fontSize: 14, fontWeight: 600, marginBottom: 8 }}>í”„ë¡œì íŠ¸ëª… *</label><input type="text" value={form.title} onChange={(e) => setForm({ ...form, title: e.target.value })} placeholder="ì˜ˆ: 2025 ì‹ ë…„ ìº í˜ì¸" style={{ width: '100%', padding: '14px 16px', borderRadius: 12, border: '1px solid #E5E8EB', fontSize: 15 }} /></div>
            <div style={{ marginBottom: 20 }}><label style={{ display: 'block', fontSize: 14, fontWeight: 600, marginBottom: 8 }}>ë‹´ë‹¹ì</label><div style={{ display: 'flex', gap: 8, flexWrap: 'wrap' }}>{TEAM_MEMBERS.map(m => <button key={m.id} onClick={() => toggleMember(m.id)} style={{ display: 'flex', alignItems: 'center', gap: 6, padding: '8px 12px', borderRadius: 8, border: form.memberIds.includes(m.id) ? `2px solid ${m.color}` : '1px solid #E5E8EB', background: form.memberIds.includes(m.id) ? `${m.color}15` : 'white' }}><div style={{ width: 24, height: 24, borderRadius: '50%', background: m.color, color: 'white', display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: 10, fontWeight: 700 }}>{m.initial}</div><span style={{ fontSize: 13, fontWeight: 500, color: form.memberIds.includes(m.id) ? '#191F28' : '#6B7684' }}>{m.name}</span></button>)}</div></div>
            <div style={{ marginBottom: 20 }}><label style={{ display: 'block', fontSize: 14, fontWeight: 600, marginBottom: 8 }}>ì„¤ëª…</label><textarea value={form.description} onChange={(e) => setForm({ ...form, description: e.target.value })} placeholder="í”„ë¡œì íŠ¸ì— ëŒ€í•œ ì„¤ëª…" rows={5} style={{ width: '100%', padding: '14px 16px', borderRadius: 12, border: '1px solid #E5E8EB', fontSize: 15, resize: 'none', lineHeight: 1.6 }} /></div>
            <div style={{ marginBottom: 20 }}><label style={{ display: 'block', fontSize: 14, fontWeight: 600, marginBottom: 8 }}>ìƒíƒœ</label><div style={{ display: 'flex', gap: 8 }}>{STATUS_OPTIONS.map(s => <button key={s.id} onClick={() => setForm({ ...form, status: s.id })} style={{ display: 'flex', alignItems: 'center', gap: 6, padding: '10px 16px', borderRadius: 10, border: form.status === s.id ? `2px solid ${s.color}` : '1px solid #E5E8EB', background: form.status === s.id ? s.bg : 'white', color: form.status === s.id ? s.color : '#6B7684', fontSize: 14, fontWeight: 500 }}><Icon name={s.icon} size={16} color={form.status === s.id ? s.color : '#6B7684'} /> {s.label}</button>)}</div></div>
            <div style={{ marginBottom: 24 }}><label style={{ display: 'block', fontSize: 14, fontWeight: 600, marginBottom: 8 }}>í”„ë¡œì íŠ¸ ë“±ë¡ì¼</label><input type="date" value={form.createdDate} onChange={(e) => setForm({ ...form, createdDate: e.target.value })} onClick={(e) => e.target.showPicker()} style={{ width: '100%', padding: '14px 16px', borderRadius: 12, border: '1px solid #E5E8EB', fontSize: 15, cursor: 'pointer' }} /></div>
            <div style={{ display: 'flex', gap: 12 }}><button onClick={onClose} style={{ flex: 1, padding: 16, borderRadius: 12, border: '1px solid #E5E8EB', background: 'white', fontSize: 15, fontWeight: 600, color: '#6B7684' }}>ì·¨ì†Œ</button><button onClick={() => form.title.trim() && onSave({ ...project, ...form })} disabled={!form.title.trim()} style={{ flex: 1, padding: 16, borderRadius: 12, border: 'none', background: form.title.trim() ? '#3182F6' : '#E5E8EB', fontSize: 15, fontWeight: 600, color: form.title.trim() ? 'white' : '#8B95A1' }}>{isEdit ? 'ìˆ˜ì •' : 'ë§Œë“¤ê¸°'}</button></div>
          </div>
        </div>
      );
    }

    // ============ ì „ì²´ì—…ë¬´ íƒ­ ============
    function CalendarTab({ tasks, setTasks, projects, currentUser }) {
      const [viewMode, setViewMode] = useState('list'); // 'calendar' or 'list'
      const [currentMonth, setCurrentMonth] = useState({ year: new Date().getFullYear(), month: new Date().getMonth() });
      const [selectedTask, setSelectedTask] = useState(null);
      const [editingTask, setEditingTask] = useState(null);
      const [showEditModal, setShowEditModal] = useState(false);
      
      // ë¦¬ìŠ¤íŠ¸ ë·° í•„í„° ìƒíƒœ
      const [searchQuery, setSearchQuery] = useState('');
      const [dateRange, setDateRange] = useState({ start: '', end: '' });
      const [filterProject, setFilterProject] = useState(null);
      const [filterStatus, setFilterStatus] = useState('all'); // 'all', 'completed', 'incomplete'
      
      // íŒ€ì› í•„í„° (íŒ€ì¥ë§Œ ì‚¬ìš© ê°€ëŠ¥, ê¸°ë³¸ê°’: ë‚´ ì—…ë¬´ë§Œ)
      const [selectedMembers, setSelectedMembers] = useState([currentUser.id]);
      
      // íŒ€ì› í•„í„° í† ê¸€ (íŒ€ì¥ë§Œ ì‚¬ìš©)
      const toggleMember = (memberId) => {
        if (currentUser.role !== 'íŒ€ì¥') return;
        setSelectedMembers(prev => {
          if (prev.includes(memberId)) {
            if (prev.length === 1) return prev;
            return prev.filter(id => id !== memberId);
          }
          return [...prev, memberId];
        });
      };
      
      // ì „ì²´ ì„ íƒ/í•´ì œ (íŒ€ì¥ë§Œ ì‚¬ìš©)
      const toggleAllMembers = () => {
        if (currentUser.role !== 'íŒ€ì¥') return;
        if (selectedMembers.length === TEAM_MEMBERS.length) {
          setSelectedMembers([currentUser.id]);
        } else {
          setSelectedMembers(TEAM_MEMBERS.map(m => m.id));
        }
      };
      
      // ì„ íƒëœ íŒ€ì›ì˜ ì—…ë¬´ë§Œ í•„í„°ë§ (íŒ€ì¥ì´ ì•„ë‹ˆë©´ ìê¸° ì—…ë¬´ë§Œ)
      const memberTasks = useMemo(() => {
        if (currentUser.role !== 'íŒ€ì¥') {
          return tasks.filter(t => t.memberId === currentUser.id);
        }
        return tasks.filter(t => selectedMembers.includes(t.memberId));
      }, [tasks, selectedMembers, currentUser]);

      const monthDates = useMemo(() => getMonthDates(currentMonth.year, currentMonth.month), [currentMonth]);
      const tasksByDate = useMemo(() => { const g = {}; memberTasks.forEach(t => { if (!g[t.date]) g[t.date] = []; g[t.date].push(t); }); return g; }, [memberTasks]);
      const stats = useMemo(() => { const tm = memberTasks.filter(t => { const d = new Date(t.date); return d.getFullYear() === currentMonth.year && d.getMonth() === currentMonth.month; }); return { total: tm.length, completed: tm.filter(t => t.completed).length }; }, [memberTasks, currentMonth]);
      
      // ë¦¬ìŠ¤íŠ¸ ë·°ìš© í•„í„°ë§ëœ ì—…ë¬´
      const filteredTasks = useMemo(() => {
        return memberTasks
          .filter(t => !searchQuery || t.title.toLowerCase().includes(searchQuery.toLowerCase()) || (t.note && t.note.toLowerCase().includes(searchQuery.toLowerCase())))
          .filter(t => !dateRange.start || t.date >= dateRange.start)
          .filter(t => !dateRange.end || t.date <= dateRange.end)
          .filter(t => filterProject === null || t.projectId === filterProject || (filterProject === 0 && !t.projectId))
          .filter(t => filterStatus === 'all' || (filterStatus === 'completed' && t.completed) || (filterStatus === 'incomplete' && !t.completed))
          .sort((a, b) => b.date.localeCompare(a.date));
      }, [memberTasks, searchQuery, dateRange, filterProject, filterStatus]);

      const moveMonth = (dir) => setCurrentMonth(prev => { let m = prev.month + (dir === 'prev' ? -1 : 1), y = prev.year; if (m < 0) { m = 11; y--; } if (m > 11) { m = 0; y++; } return { year: y, month: m }; });
      const toggleTaskComplete = (id) => { setTasks(prev => prev.map(t => t.id === id ? { ...t, completed: !t.completed } : t)); if (selectedTask?.id === id) setSelectedTask(prev => ({ ...prev, completed: !prev.completed })); };
      const deleteTask = (id) => { setTasks(prev => prev.filter(t => t.id !== id)); setSelectedTask(null); };
      const updateTask = (task) => { setTasks(prev => prev.map(t => t.id === task.id ? { ...t, ...task } : t)); };

      return (
        <div style={{ minHeight: '100vh' }}>
          <header style={{ background: 'white', borderBottom: '1px solid #E5E8EB', padding: '20px 32px' }}>
            <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', marginBottom: 20 }}>
              <div style={{ display: 'flex', alignItems: 'center', gap: 20 }}>
                <h1 style={{ fontSize: 24, fontWeight: 700, color: '#191F28' }}>{currentUser.role === 'íŒ€ì¥' ? 'ì „ì²´ ì—…ë¬´' : 'ë‚´ ì—…ë¬´'}</h1>
                {/* ë·° ëª¨ë“œ í† ê¸€ */}
                <div style={{ display: 'flex', gap: 8 }}>
                  <button onClick={() => setViewMode('list')} style={{ display: 'flex', alignItems: 'center', gap: 6, padding: '10px 20px', borderRadius: 10, border: viewMode === 'list' ? '2px solid #3182F6' : '1px solid #E5E8EB', background: viewMode === 'list' ? '#EBF4FF' : 'white', fontSize: 15, fontWeight: 600, color: viewMode === 'list' ? '#3182F6' : '#6B7684', cursor: 'pointer' }}>
                    <Icon name="clipboard" size={18} color={viewMode === 'list' ? '#3182F6' : '#6B7684'} /> ë¦¬ìŠ¤íŠ¸
                  </button>
                  <button onClick={() => setViewMode('calendar')} style={{ display: 'flex', alignItems: 'center', gap: 6, padding: '10px 20px', borderRadius: 10, border: viewMode === 'calendar' ? '2px solid #3182F6' : '1px solid #E5E8EB', background: viewMode === 'calendar' ? '#EBF4FF' : 'white', fontSize: 15, fontWeight: 600, color: viewMode === 'calendar' ? '#3182F6' : '#6B7684', cursor: 'pointer' }}>
                    <Icon name="calendar" size={18} color={viewMode === 'calendar' ? '#3182F6' : '#6B7684'} /> ìº˜ë¦°ë”
                  </button>
                </div>
              </div>
              
              {/* íŒ€ì› í•„í„° - íŒ€ì¥ë§Œ í‘œì‹œ */}
              {currentUser.role === 'íŒ€ì¥' && (
                <div style={{ display: 'flex', alignItems: 'center', gap: 8 }}>
                  <span style={{ fontSize: 13, color: '#6B7684', marginRight: 4 }}>íŒ€ì›</span>
                  <button 
                    onClick={toggleAllMembers}
                    style={{ 
                      padding: '6px 12px', borderRadius: 8, 
                      border: selectedMembers.length === TEAM_MEMBERS.length ? '2px solid #3182F6' : '1px solid #E5E8EB', 
                      background: selectedMembers.length === TEAM_MEMBERS.length ? '#EBF4FF' : 'white',
                      fontSize: 12, fontWeight: 600, 
                      color: selectedMembers.length === TEAM_MEMBERS.length ? '#3182F6' : '#6B7684',
                      cursor: 'pointer'
                    }}
                  >
                    ì „ì²´
                  </button>
                  {TEAM_MEMBERS.map(m => (
                    <button 
                      key={m.id}
                      onClick={() => toggleMember(m.id)}
                      style={{ 
                        display: 'flex', alignItems: 'center', gap: 6, 
                        padding: '6px 12px', borderRadius: 8,
                        border: selectedMembers.includes(m.id) ? `2px solid ${m.color}` : '1px solid #E5E8EB',
                        background: selectedMembers.includes(m.id) ? `${m.color}15` : 'white',
                        cursor: 'pointer'
                      }}
                    >
                      <div style={{ 
                        width: 22, height: 22, borderRadius: '50%', 
                        background: m.color, color: 'white', 
                        display: 'flex', alignItems: 'center', justifyContent: 'center', 
                        fontSize: 10, fontWeight: 700 
                      }}>{m.initial}</div>
                      <span style={{ fontSize: 12, fontWeight: 500, color: selectedMembers.includes(m.id) ? '#191F28' : '#6B7684' }}>{m.name}</span>
                    </button>
                  ))}
                </div>
              )}
            </div>
            
            {viewMode === 'list' ? (
              /* ë¦¬ìŠ¤íŠ¸ ë·° í•„í„° */
              <div style={{ display: 'flex', flexDirection: 'column', gap: 16 }}>
                {/* ê²€ìƒ‰ + ë‚ ì§œ ë²”ìœ„ */}
                <div style={{ display: 'flex', gap: 12, alignItems: 'center' }}>
                  <div style={{ display: 'flex', alignItems: 'center', gap: 8, background: '#F7F8FA', borderRadius: 10, padding: '0 14px', flex: 1, maxWidth: 400 }}>
                    <Icon name="search" size={18} color="#8B95A1" />
                    <input 
                      type="text" 
                      value={searchQuery} 
                      onChange={(e) => setSearchQuery(e.target.value)} 
                      placeholder="ì—…ë¬´ëª… ë˜ëŠ” ë©”ëª¨ ê²€ìƒ‰..." 
                      style={{ flex: 1, border: 'none', background: 'transparent', padding: '12px 0', fontSize: 14, color: '#191F28', outline: 'none' }} 
                    />
                    {searchQuery && (
                      <button onClick={() => setSearchQuery('')} style={{ background: 'none', border: 'none', cursor: 'pointer' }}>
                        <Icon name="x" size={16} color="#8B95A1" />
                      </button>
                    )}
                  </div>
                  
                  <div style={{ display: 'flex', alignItems: 'center', gap: 8 }}>
                    <span style={{ fontSize: 13, color: '#6B7684' }}>ê¸°ê°„</span>
                    <input 
                      type="date" 
                      value={dateRange.start} 
                      onChange={(e) => setDateRange(prev => ({ ...prev, start: e.target.value }))}
                      onClick={(e) => e.target.showPicker()}
                      style={{ padding: '10px 12px', borderRadius: 8, border: '1px solid #E5E8EB', fontSize: 13, cursor: 'pointer' }}
                    />
                    <span style={{ color: '#8B95A1' }}>~</span>
                    <input 
                      type="date" 
                      value={dateRange.end} 
                      onChange={(e) => setDateRange(prev => ({ ...prev, end: e.target.value }))}
                      onClick={(e) => e.target.showPicker()}
                      style={{ padding: '10px 12px', borderRadius: 8, border: '1px solid #E5E8EB', fontSize: 13, cursor: 'pointer' }}
                    />
                    {(dateRange.start || dateRange.end) && (
                      <button onClick={() => setDateRange({ start: '', end: '' })} style={{ padding: '8px 12px', borderRadius: 8, border: '1px solid #E5E8EB', background: 'white', fontSize: 12, color: '#8B95A1', cursor: 'pointer' }}>ì´ˆê¸°í™”</button>
                    )}
                  </div>
                </div>
                
                {/* í”„ë¡œì íŠ¸ + ìƒíƒœ í•„í„° */}
                <div style={{ display: 'flex', gap: 12, alignItems: 'center', flexWrap: 'wrap' }}>
                  <div style={{ display: 'flex', alignItems: 'center', gap: 8 }}>
                    <span style={{ fontSize: 13, color: '#6B7684' }}>í”„ë¡œì íŠ¸</span>
                    <button onClick={() => setFilterProject(null)} style={{ padding: '6px 14px', borderRadius: 8, border: filterProject === null ? '1.5px solid #3182F6' : '1px solid #E5E8EB', background: filterProject === null ? '#EBF4FF' : 'white', fontSize: 13, fontWeight: 500, color: filterProject === null ? '#3182F6' : '#6B7684', cursor: 'pointer' }}>ì „ì²´</button>
                    {BRANDS.map(b => (
                      <button key={b.id} onClick={() => setFilterProject(b.id)} style={{ padding: '6px 14px', borderRadius: 8, border: filterProject === b.id ? `1.5px solid ${b.color}` : '1px solid #E5E8EB', background: filterProject === b.id ? `${b.color}15` : 'white', fontSize: 13, fontWeight: 500, color: filterProject === b.id ? b.color : '#6B7684', cursor: 'pointer' }}>{b.name}</button>
                    ))}
                    <button onClick={() => setFilterProject(0)} style={{ padding: '6px 14px', borderRadius: 8, border: filterProject === 0 ? '1.5px solid #8B95A1' : '1px solid #E5E8EB', background: filterProject === 0 ? '#8B95A115' : 'white', fontSize: 13, fontWeight: 500, color: filterProject === 0 ? '#8B95A1' : '#6B7684', cursor: 'pointer' }}>ê¸°íƒ€ ì—…ë¬´</button>
                  </div>
                  
                  <div style={{ marginLeft: 'auto', display: 'flex', alignItems: 'center', gap: 8 }}>
                    <span style={{ fontSize: 13, color: '#6B7684' }}>ìƒíƒœ</span>
                    <button onClick={() => setFilterStatus('all')} style={{ padding: '6px 14px', borderRadius: 8, border: filterStatus === 'all' ? '1.5px solid #3182F6' : '1px solid #E5E8EB', background: filterStatus === 'all' ? '#EBF4FF' : 'white', fontSize: 13, fontWeight: 500, color: filterStatus === 'all' ? '#3182F6' : '#6B7684', cursor: 'pointer' }}>ì „ì²´</button>
                    <button onClick={() => setFilterStatus('incomplete')} style={{ padding: '6px 14px', borderRadius: 8, border: filterStatus === 'incomplete' ? '1.5px solid #F59E0B' : '1px solid #E5E8EB', background: filterStatus === 'incomplete' ? '#FEF3C7' : 'white', fontSize: 13, fontWeight: 500, color: filterStatus === 'incomplete' ? '#F59E0B' : '#6B7684', cursor: 'pointer' }}>ë¯¸ì™„ë£Œ</button>
                    <button onClick={() => setFilterStatus('completed')} style={{ padding: '6px 14px', borderRadius: 8, border: filterStatus === 'completed' ? '1.5px solid #00C471' : '1px solid #E5E8EB', background: filterStatus === 'completed' ? '#DCFCE7' : 'white', fontSize: 13, fontWeight: 500, color: filterStatus === 'completed' ? '#00C471' : '#6B7684', cursor: 'pointer' }}>ì™„ë£Œ</button>
                  </div>
                </div>
                
                {/* ê²€ìƒ‰ ê²°ê³¼ ì¹´ìš´íŠ¸ */}
                <div style={{ fontSize: 14, color: '#6B7684' }}>
                  ì´ <strong style={{ color: '#191F28' }}>{filteredTasks.length}</strong>ê°œì˜ ì—…ë¬´
                </div>
              </div>
            ) : (
              /* ìº˜ë¦°ë” ë·° í—¤ë” */
              <>
                <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between' }}>
                  <div style={{ display: 'flex', alignItems: 'center', gap: 12 }}>
                    <button onClick={() => moveMonth('prev')} style={{ width: 36, height: 36, borderRadius: 10, border: '1px solid #E5E8EB', background: 'white', display: 'flex', alignItems: 'center', justifyContent: 'center', cursor: 'pointer' }}><Icon name="chevronLeft" size={20} color="#6B7684" /></button>
                    <h2 style={{ fontSize: 24, fontWeight: 700, color: '#191F28', minWidth: 160, textAlign: 'center' }}>{currentMonth.year}ë…„ {currentMonth.month + 1}ì›”</h2>
                    <button onClick={() => moveMonth('next')} style={{ width: 36, height: 36, borderRadius: 10, border: '1px solid #E5E8EB', background: 'white', display: 'flex', alignItems: 'center', justifyContent: 'center', cursor: 'pointer' }}><Icon name="chevronRight" size={20} color="#6B7684" /></button>
                    <button onClick={() => setCurrentMonth({ year: new Date().getFullYear(), month: new Date().getMonth() })} style={{ padding: '8px 16px', borderRadius: 8, border: '1px solid #E5E8EB', background: 'white', fontSize: 14, fontWeight: 500, color: '#3182F6', cursor: 'pointer' }}>ì˜¤ëŠ˜</button>
                  </div>
                  <div style={{ textAlign: 'right' }}><p style={{ fontSize: 12, color: '#8B95A1' }}>{currentMonth.month + 1}ì›” ì—…ë¬´</p><p style={{ fontSize: 18, fontWeight: 700 }}><span style={{ color: '#00C471' }}>{stats.completed}</span><span style={{ color: '#8B95A1', fontWeight: 400 }}> / {stats.total}</span></p></div>
                </div>
              </>
            )}
          </header>

          {viewMode === 'list' ? (
            /* ë¦¬ìŠ¤íŠ¸ ë·° */
            <div style={{ padding: 32 }}>
              <div style={{ background: 'white', borderRadius: 16, border: '1px solid #E5E8EB', overflow: 'hidden' }}>
                {/* í…Œì´ë¸” í—¤ë” */}
                <div style={{ display: 'grid', gridTemplateColumns: '44px 100px 1fr 80px 120px 44px', alignItems: 'center', padding: '12px 20px', borderBottom: '1px solid #E5E8EB', background: '#FAFBFC' }}>
                  <div></div>
                  <div style={{ fontSize: 13, fontWeight: 600, color: '#6B7684' }}>ë‚ ì§œ</div>
                  <div style={{ fontSize: 13, fontWeight: 600, color: '#6B7684' }}>ì—…ë¬´</div>
                  <div style={{ fontSize: 13, fontWeight: 600, color: '#6B7684', textAlign: 'center' }}>ë‹´ë‹¹ì</div>
                  <div style={{ fontSize: 13, fontWeight: 600, color: '#6B7684', textAlign: 'center' }}>í”„ë¡œì íŠ¸</div>
                  <div></div>
                </div>
                
                {filteredTasks.length === 0 ? (
                  <div style={{ padding: '60px 20px', textAlign: 'center' }}>
                    <Icon name="search" size={48} color="#D1D6DB" />
                    <p style={{ fontSize: 16, color: '#8B95A1', marginTop: 16 }}>ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</p>
                  </div>
                ) : (
                  filteredTasks.map(task => {
                    const project = projects.find(p => p.id === task.projectId);
                    const proj = project ? BRANDS.find(b => b.id === project.brandId) : BRANDS.find(p => p.id === task.projectId);
                    const member = TEAM_MEMBERS.find(m => m.id === task.memberId);
                    return (
                      <div 
                        key={task.id} 
                        onClick={() => setSelectedTask(task)}
                        style={{ display: 'grid', gridTemplateColumns: '44px 100px 1fr 80px 120px 44px', alignItems: 'center', padding: '14px 20px', borderBottom: '1px solid #F2F3F5', cursor: 'pointer', transition: 'background 0.15s' }}
                        onMouseEnter={(e) => e.currentTarget.style.background = '#F7F8FA'}
                        onMouseLeave={(e) => e.currentTarget.style.background = 'white'}
                      >
                        <button 
                          onClick={(e) => { e.stopPropagation(); toggleTaskComplete(task.id); }} 
                          style={{ width: 28, height: 28, borderRadius: 8, border: task.completed ? 'none' : '2px solid #D1D6DB', background: task.completed ? '#3182F6' : 'white', display: 'flex', alignItems: 'center', justifyContent: 'center', cursor: 'pointer' }}
                        >
                          {task.completed && <Icon name="check" size={16} color="white" />}
                        </button>
                        
                        <span style={{ fontSize: 13, color: '#6B7684' }}>{task.date.slice(5).replace('-', '/')}</span>
                        
                        <div>
                          <div style={{ display: 'flex', alignItems: 'center', gap: 8 }}>
                            <span style={{ fontSize: 14, fontWeight: 500, color: task.completed ? '#8B95A1' : '#191F28', textDecoration: task.completed ? 'line-through' : 'none' }}>{task.title}</span>
                            {task.bookmark && <Icon name="bookmarkFill" size={14} color="#F59E0B" />}
                            {task.note && <Icon name="fileText" size={14} color="#3182F6" />}
                          </div>
                          {task.note && <p style={{ fontSize: 12, color: '#8B95A1', marginTop: 2, overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap', maxWidth: 400 }}>{task.note.split('\n')[0]}</p>}
                        </div>
                        
                        <div style={{ display: 'flex', justifyContent: 'center' }}>
                          {member && (
                            <div style={{ display: 'flex', alignItems: 'center', gap: 6 }}>
                              <div style={{ width: 24, height: 24, borderRadius: '50%', background: member.color, color: 'white', display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: 10, fontWeight: 700 }}>{member.initial}</div>
                            </div>
                          )}
                        </div>
                        
                        <div style={{ display: 'flex', justifyContent: 'center' }}>
                          {proj ? <span style={{ padding: '4px 10px', borderRadius: 6, background: `${proj.color}15`, color: proj.color, fontSize: 12, fontWeight: 600 }}>{proj.name}</span> : <span style={{ padding: '4px 10px', borderRadius: 6, background: '#8B95A115', color: '#8B95A1', fontSize: 12, fontWeight: 600 }}>ê¸°íƒ€ ì—…ë¬´</span>}
                        </div>
                        
                        <button 
                          onClick={(e) => { e.stopPropagation(); setTasks(prev => prev.filter(t => t.id !== task.id)); }} 
                          style={{ width: 32, height: 32, borderRadius: 6, border: 'none', background: '#FEE4E2', display: 'flex', alignItems: 'center', justifyContent: 'center', cursor: 'pointer' }}
                        >
                          <Icon name="trash" size={16} color="#F04452" />
                        </button>
                      </div>
                    );
                  })
                )}
              </div>
            </div>
          ) : (
            /* ìº˜ë¦°ë” ë·° */
            <div style={{ padding: 32 }}>
              <div style={{ background: 'white', borderRadius: 20, overflow: 'hidden', border: '1px solid #E5E8EB' }}>
                <div style={{ display: 'grid', gridTemplateColumns: 'repeat(7, 1fr)', borderBottom: '1px solid #E5E8EB', background: '#FAFBFC' }}>{['ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† ', 'ì¼'].map((d, i) => <div key={d} style={{ padding: '14px 8px', textAlign: 'center', fontSize: 14, fontWeight: 600, color: i >= 5 ? '#F04452' : '#6B7684' }}>{d}</div>)}</div>
                <div style={{ display: 'grid', gridTemplateColumns: 'repeat(7, 1fr)' }}>
                  {monthDates.map(({ date, isCurrentMonth, day }, idx) => {
                    const isToday = date === today, dt = tasksByDate[date] || [], dow = idx % 7;
                    return (
                      <div key={date} style={{ minHeight: 140, padding: 8, borderRight: dow < 6 ? '1px solid #F2F3F5' : 'none', borderBottom: idx < 35 ? '1px solid #F2F3F5' : 'none', background: isToday ? '#EBF4FF' : 'white', opacity: isCurrentMonth ? 1 : 0.4, display: 'flex', flexDirection: 'column' }}>
                        <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', marginBottom: 8, flexShrink: 0 }}>
                          <span style={{ width: 28, height: 28, borderRadius: '50%', display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: 14, fontWeight: isToday ? 700 : 500, color: isToday ? 'white' : dow >= 5 ? '#F04452' : '#191F28', background: isToday ? '#3182F6' : 'transparent' }}>{day}</span>
                          {dt.length > 0 && <span style={{ fontSize: 11, color: '#8B95A1' }}>{dt.length}ê±´</span>}
                        </div>
                        {/* ìŠ¤í¬ë¡¤ ê°€ëŠ¥í•œ ì—…ë¬´ ë¦¬ìŠ¤íŠ¸ */}
                        <div style={{ flex: 1, overflow: 'auto', display: 'flex', flexDirection: 'column', gap: 4 }}>
                          {dt.map(t => { 
                            const project = projects.find(p => p.id === t.projectId);
                            const proj = project ? BRANDS.find(b => b.id === project.brandId) : BRANDS.find(p => p.id === t.projectId);
                            const member = TEAM_MEMBERS.find(m => m.id === t.memberId);
                            return (
                              <div key={t.id} onClick={() => setSelectedTask(t)} style={{ display: 'flex', alignItems: 'center', gap: 6, padding: '4px 8px', borderRadius: 6, background: proj ? `${proj.color}15` : '#F7F8FA', borderLeft: `3px solid ${proj ? proj.color : '#8B95A1'}`, cursor: 'pointer', flexShrink: 0 }}>
                                <span style={{ fontSize: 11, fontWeight: 500, color: t.completed ? '#8B95A1' : '#191F28', textDecoration: t.completed ? 'line-through' : 'none', overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap', flex: 1 }}>{t.title}</span>
                                {member && <div style={{ width: 18, height: 18, borderRadius: '50%', background: member.color, color: 'white', display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: 8, fontWeight: 700, flexShrink: 0 }}>{member.initial}</div>}
                              </div>
                            ); 
                          })}
                        </div>
                      </div>
                    );
                  })}
                </div>
              </div>
            </div>
          )}

          {/* ì—…ë¬´ ìƒì„¸ ëª¨ë‹¬ - ë©”ëª¨ í¬í•¨ */}
          {selectedTask && (
            <div onClick={() => setSelectedTask(null)} style={{ position: 'fixed', inset: 0, background: 'rgba(0,0,0,0.4)', display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 1000 }}>
              <div onClick={(e) => e.stopPropagation()} style={{ background: 'white', borderRadius: 20, padding: 24, width: '100%', maxWidth: 420, maxHeight: '80vh', overflow: 'auto' }}>
                {(() => { 
                  const project = projects.find(p => p.id === selectedTask.projectId);
                  const proj = project ? BRANDS.find(b => b.id === project.brandId) : BRANDS.find(x => x.id === selectedTask.projectId);
                  return <>
                    <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', marginBottom: 20 }}>
                      <h2 style={{ fontSize: 18, fontWeight: 700, color: '#191F28' }}>ğŸ“ ì—…ë¬´ ìƒì„¸</h2>
                      <button onClick={() => setSelectedTask(null)} style={{ width: 32, height: 32, borderRadius: 8, border: 'none', background: '#F7F8FA', display: 'flex', alignItems: 'center', justifyContent: 'center', cursor: 'pointer' }}><Icon name="x" size={18} color="#8B95A1" /></button>
                    </div>
                    
                    <div style={{ background: '#F7F8FA', borderRadius: 12, padding: 16, marginBottom: 16 }}>
                      <div style={{ display: 'flex', alignItems: 'center', gap: 8, marginBottom: 12 }}>
                        {proj ? <span style={{ padding: '4px 10px', borderRadius: 6, background: `${proj.color}15`, color: proj.color, fontSize: 12, fontWeight: 600 }}>{proj.name}</span> : <span style={{ padding: '4px 10px', borderRadius: 6, background: '#8B95A115', color: '#8B95A1', fontSize: 12, fontWeight: 600 }}>ê¸°íƒ€ ì—…ë¬´</span>}
                        {selectedTask.bookmark && <Icon name="bookmarkFill" size={16} color="#F59E0B" />}
                      </div>
                      <h3 style={{ fontSize: 18, fontWeight: 700, color: '#191F28', marginBottom: 8, textDecoration: selectedTask.completed ? 'line-through' : 'none' }}>{selectedTask.title}</h3>
                      <p style={{ fontSize: 14, color: '#6B7684' }}>ğŸ“… {formatShortDate(selectedTask.date)}</p>
                    </div>
                    
                    {/* ë©”ëª¨ ì˜ì—­ */}
                    {selectedTask.note && (
                      <div style={{ background: '#FFFBEB', borderRadius: 12, padding: 16, marginBottom: 16, border: '1px solid #FEF3C7' }}>
                        <div style={{ display: 'flex', alignItems: 'center', gap: 6, marginBottom: 8 }}>
                          <Icon name="fileText" size={16} color="#F59E0B" />
                          <span style={{ fontSize: 13, fontWeight: 600, color: '#92400E' }}>ë©”ëª¨</span>
                        </div>
                        <p style={{ fontSize: 14, color: '#191F28', lineHeight: 1.6, whiteSpace: 'pre-wrap' }}>{selectedTask.note}</p>
                      </div>
                    )}
                    
                    {/* ì²¨ë¶€íŒŒì¼ ì˜ì—­ */}
                    {selectedTask.attachments && selectedTask.attachments.length > 0 && (
                      <div style={{ background: '#F0F7FF', borderRadius: 12, padding: 16, marginBottom: 16, border: '1px solid #DBEAFE' }}>
                        <div style={{ display: 'flex', alignItems: 'center', gap: 6, marginBottom: 12 }}>
                          <Icon name="paperclip" size={16} color="#3182F6" />
                          <span style={{ fontSize: 13, fontWeight: 600, color: '#1E40AF' }}>ì²¨ë¶€íŒŒì¼ ({selectedTask.attachments.length})</span>
                        </div>
                        <div style={{ display: 'flex', flexDirection: 'column', gap: 8 }}>
                          {selectedTask.attachments.map(file => (
                            <div key={file.id} style={{ display: 'flex', alignItems: 'center', gap: 10, padding: '10px 12px', borderRadius: 8, background: 'white', border: '1px solid #E5E8EB' }}>
                              <Icon name="fileText" size={18} color="#3182F6" />
                              <span style={{ flex: 1, fontSize: 13, color: '#191F28', overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap' }}>{file.name}</span>
                              <span style={{ fontSize: 11, color: '#8B95A1' }}>{(file.size / 1024).toFixed(1)}KB</span>
                            </div>
                          ))}
                        </div>
                      </div>
                    )}
                    
                    {/* ë²„íŠ¼ ì˜ì—­ */}
                    <div style={{ display: 'flex', flexDirection: 'column', gap: 8 }}>
                      <button onClick={() => toggleTaskComplete(selectedTask.id)} style={{ width: '100%', padding: 14, borderRadius: 12, border: 'none', background: selectedTask.completed ? '#F7F8FA' : '#3182F6', color: selectedTask.completed ? '#6B7684' : 'white', fontSize: 15, fontWeight: 600, display: 'flex', alignItems: 'center', justifyContent: 'center', gap: 8, cursor: 'pointer' }}>
                        <Icon name="check" size={18} color={selectedTask.completed ? '#6B7684' : 'white'} /> {selectedTask.completed ? 'ì™„ë£Œ ì·¨ì†Œ' : 'ì™„ë£Œ ì²˜ë¦¬'}
                      </button>
                      
                      <div style={{ display: 'flex', gap: 8 }}>
                        <button onClick={() => { setEditingTask(selectedTask); setShowEditModal(true); setSelectedTask(null); }} style={{ flex: 1, padding: 14, borderRadius: 12, border: '1px solid #E5E8EB', background: 'white', color: '#191F28', fontSize: 15, fontWeight: 600, display: 'flex', alignItems: 'center', justifyContent: 'center', gap: 8, cursor: 'pointer' }}>
                          <Icon name="edit" size={18} color="#6B7684" /> ìˆ˜ì •
                        </button>
                        <button onClick={() => { if(confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) deleteTask(selectedTask.id); }} style={{ flex: 1, padding: 14, borderRadius: 12, border: 'none', background: '#FEE4E2', color: '#F04452', fontSize: 15, fontWeight: 600, display: 'flex', alignItems: 'center', justifyContent: 'center', gap: 8, cursor: 'pointer' }}>
                          <Icon name="trash" size={18} color="#F04452" /> ì‚­ì œ
                        </button>
                      </div>
                    </div>
                  </>;
                })()}
              </div>
            </div>
          )}
          
          {/* ì—…ë¬´ ìˆ˜ì • ëª¨ë‹¬ */}
          {showEditModal && (
            <TaskModal 
              task={editingTask} 
              date={editingTask?.date || today} 
              onSave={(task) => { updateTask(task); setShowEditModal(false); setEditingTask(null); }} 
              onClose={() => { setShowEditModal(false); setEditingTask(null); }} 
            />
          )}
        </div>
      );
    }

    // ============ ê·¸ë¡œìŠ¤ë³´ë“œ íƒ­ ============
    function GrowthBoardTab({ tasks, projects, currentUser }) {
      // ì£¼ì°¨ ê³„ì‚° í—¬í¼
      const getWeekNumber = (date) => {
        const d = new Date(date);
        const firstDay = new Date(d.getFullYear(), 0, 1);
        const pastDays = (d - firstDay) / 86400000;
        return Math.ceil((pastDays + firstDay.getDay() + 1) / 7);
      };
      
      const getWeekRange = (year, week) => {
        const firstDay = new Date(year, 0, 1);
        const days = (week - 1) * 7;
        const startDate = new Date(firstDay.setDate(firstDay.getDate() + days - firstDay.getDay() + 1));
        const endDate = new Date(startDate);
        endDate.setDate(startDate.getDate() + 6);
        return { start: formatDate(startDate), end: formatDate(endDate) };
      };
      
      const currentYear = new Date().getFullYear();
      const currentWeek = getWeekNumber(new Date());
      
      // ìƒíƒœ
      const [selectedYear, setSelectedYear] = useState(currentYear);
      const [selectedWeek, setSelectedWeek] = useState(currentWeek);
      const [selectedBrand, setSelectedBrand] = useState(1);
      const [nodes, setNodes] = useState([]);
      const [connections, setConnections] = useState([]);
      const [selectedNode, setSelectedNode] = useState(null);
      const [showAddBranch, setShowAddBranch] = useState(false);
      const [newBranchName, setNewBranchName] = useState('');
      const [editingNode, setEditingNode] = useState(null);
      const [boards, setBoards] = useState({});
      
      // ì¤Œ & íŒ¨ë‹ ìƒíƒœ (transform ê¸°ë°˜ ë¬´í•œ ìº”ë²„ìŠ¤)
      const [zoom, setZoom] = useState(1);
      const [offset, setOffset] = useState({ x: 100, y: 50 }); // ì´ˆê¸° ìœ„ì¹˜
      const [isPanning, setIsPanning] = useState(false);
      const [spacePressed, setSpacePressed] = useState(false);
      const panStart = React.useRef({ x: 0, y: 0, offsetX: 0, offsetY: 0 });
      const canvasRef = React.useRef(null);
      
      // ìŠ¤í˜ì´ìŠ¤ë°” ì „ì—­ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
      useEffect(() => {
        const handleKeyDown = (e) => {
          if (e.code === 'Space' && e.target.tagName !== 'INPUT' && e.target.tagName !== 'TEXTAREA') {
            e.preventDefault();
            setSpacePressed(true);
          }
        };
        const handleKeyUp = (e) => {
          if (e.code === 'Space') {
            e.preventDefault();
            setSpacePressed(false);
            setIsPanning(false);
          }
        };
        
        document.addEventListener('keydown', handleKeyDown);
        document.addEventListener('keyup', handleKeyUp);
        
        return () => {
          document.removeEventListener('keydown', handleKeyDown);
          document.removeEventListener('keyup', handleKeyUp);
        };
      }, []);
      
      // í˜„ì¬ ë³´ë“œ í‚¤ (ë¸Œëœë“œ í†µí•©)
      const boardKey = `${currentUser.id}-${selectedYear}-W${selectedWeek}`;
      
      // Firebaseì—ì„œ ë³´ë“œ ë°ì´í„° ë¡œë“œ
      useEffect(() => {
        const loadBoard = async () => {
          const data = await FirebaseService.getDoc('growthboards', boardKey);
          if (data) {
            setNodes(data.nodes || []);
            setConnections(data.connections || []);
          } else {
            // ìƒˆ ë³´ë“œ ì´ˆê¸°í™” - ì¤‘ì‹¬ ë…¸ë“œë§Œ ìƒì„±
            const centerNode = {
              id: 'center',
              type: 'center',
              text: `${selectedYear}ë…„ ${selectedWeek}ì£¼ì°¨`,
              x: 200,
              y: 300,
              color: '#3182F6'
            };
            setNodes([centerNode]);
            setConnections([]);
          }
        };
        loadBoard();
      }, [boardKey, selectedYear, selectedWeek]);
      
      // ë³´ë“œ ì €ì¥
      const saveBoard = async (newNodes, newConnections) => {
        await FirebaseService.saveDoc('growthboards', boardKey, {
          nodes: newNodes,
          connections: newConnections,
          updatedAt: new Date().toISOString()
        });
      };
      
      // ë‚´ í”„ë¡œì íŠ¸ë§Œ í•„í„°ë§ (ë‚´ê°€ ë§Œë“  í”„ë¡œì íŠ¸ + ë‚´ê°€ ì°¸ì—¬í•œ í”„ë¡œì íŠ¸)
      const myProjects = useMemo(() => {
        // ë‚´ê°€ ë‹´ë‹¹ìì¸ ì—…ë¬´ê°€ ìˆëŠ” í”„ë¡œì íŠ¸ ID
        const myTaskProjectIds = [...new Set(
          tasks.filter(t => t.memberId === currentUser.id).map(t => t.projectId)
        )];
        
        return projects.filter(p => 
          p.creatorId === currentUser.id || myTaskProjectIds.includes(p.id)
        );
      }, [projects, tasks, currentUser.id]);
      
      // í”„ë¡œì íŠ¸ë³„ í•˜ìœ„ì—…ë¬´
      const getProjectTasks = (projectId) => {
        return tasks.filter(t => t.projectId === projectId);
      };
      
      // í”„ë¡œì íŠ¸ì˜ ë¸Œëœë“œ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
      const getProjectBrand = (project) => {
        return BRANDS.find(b => b.id === project.brandId);
      };
      
      // ì´ë¯¸ ë³´ë“œì— ì¶”ê°€ëœ í”„ë¡œì íŠ¸ ID
      const addedProjectIds = useMemo(() => {
        return nodes.filter(n => n.projectId).map(n => n.projectId);
      }, [nodes]);
      
      // ìˆ˜ë™ ë™ê¸°í™” í•¨ìˆ˜ - í”„ë¡œì íŠ¸/ì—…ë¬´ ë³€ê²½ì‚¬í•­ ë°˜ì˜
      const syncWithProjects = () => {
        if (nodes.length === 0) return;
        
        let updatedNodes = [...nodes];
        let updatedConnections = [...connections];
        let hasChanges = false;
        
        // 1. í”„ë¡œì íŠ¸/ì—…ë¬´ ì´ë¦„ ë³€ê²½ ë™ê¸°í™”
        updatedNodes = updatedNodes.map(node => {
          // í”„ë¡œì íŠ¸ ë…¸ë“œ ë™ê¸°í™”
          if (node.projectId) {
            const project = projects.find(p => p.id === node.projectId);
            if (project && node.text !== project.title) {
              hasChanges = true;
              return { ...node, text: project.title };
            }
          }
          // ì—…ë¬´ ë…¸ë“œ ë™ê¸°í™”
          if (node.taskId) {
            const task = tasks.find(t => t.id === node.taskId);
            if (task && node.text !== task.title) {
              hasChanges = true;
              return { ...node, text: task.title };
            }
          }
          return node;
        });
        
        // 2. ìƒˆë¡œ ì¶”ê°€ëœ ì™„ë£Œ ì—…ë¬´ ë™ê¸°í™” (ë‚´ê°€ ë‹´ë‹¹í•œ ì—…ë¬´ë§Œ)
        updatedNodes.forEach(node => {
          if (node.projectId && node.type === 'branch') {
            const projectTasks = tasks.filter(t => 
              t.projectId === node.projectId && 
              t.completed && 
              !t.parentTaskId &&
              t.memberId === currentUser.id
            );
            
            // ì´ë¯¸ ì¶”ê°€ëœ ì—…ë¬´ ID
            const existingTaskIds = updatedNodes
              .filter(n => n.taskId && connections.some(c => c.from === node.id && c.to === n.id))
              .map(n => n.taskId);
            
            // ìƒˆë¡œ ì¶”ê°€í•  ì—…ë¬´
            projectTasks.forEach(task => {
              if (!existingTaskIds.includes(task.id)) {
                hasChanges = true;
                const taskNodeId = `task-${task.id}-${Date.now()}-${Math.random().toString(36).substr(2, 5)}`;
                updatedNodes.push({
                  id: taskNodeId,
                  type: 'task',
                  taskId: task.id,
                  text: task.title,
                  x: 0,
                  y: 0,
                  completed: task.completed,
                  color: '#00C471'
                });
                updatedConnections.push({
                  id: `conn-task-${taskNodeId}`,
                  from: node.id,
                  to: taskNodeId
                });
                
                // ì„œë¸ŒíƒœìŠ¤í¬ë„ ì¶”ê°€ (ë‚´ê°€ ë‹´ë‹¹í•œ ê²ƒë§Œ)
                const subtasks = tasks.filter(st => 
                  st.parentTaskId === task.id && st.completed && st.memberId === currentUser.id
                );
                subtasks.forEach(st => {
                  const subtaskNodeId = `subtask-${st.id}-${Date.now()}-${Math.random().toString(36).substr(2, 5)}`;
                  updatedNodes.push({
                    id: subtaskNodeId,
                    type: 'task',
                    taskId: st.id,
                    text: st.title,
                    x: 0,
                    y: 0,
                    completed: st.completed,
                    color: '#10B981',
                    isSubtask: true
                  });
                  updatedConnections.push({
                    id: `conn-subtask-${subtaskNodeId}`,
                    from: taskNodeId,
                    to: subtaskNodeId
                  });
                });
              }
            });
          }
        });
        
        if (hasChanges) {
          // ìë™ ì •ë ¬ ì ìš©
          const layoutedNodes = autoLayoutTree(updatedNodes, updatedConnections);
          setNodes(layoutedNodes);
          setConnections(updatedConnections);
          saveBoard(layoutedNodes, updatedConnections);
          alert('âœ… ë™ê¸°í™” ì™„ë£Œ!\ní”„ë¡œì íŠ¸/ì—…ë¬´ ë³€ê²½ì‚¬í•­ì´ ë°˜ì˜ë˜ì—ˆìŠµë‹ˆë‹¤.');
        } else {
          alert('â„¹ï¸ ë³€ê²½ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤.');
        }
      };
      
      // ë ˆì´ì•„ì›ƒ ìƒìˆ˜ - EdrawMind ìŠ¤íƒ€ì¼
      const LAYOUT = {
        centerX: 200,
        centerY: 300,
        level1X: 330,   // ë¸Œëœë“œ ë…¸ë“œ
        level2X: 490,   // í”„ë¡œì íŠ¸ ë…¸ë“œ
        level3X: 660,   // í•˜ìœ„ì—…ë¬´ ë…¸ë“œ
        level4X: 820,   // ì„œë¸ŒíƒœìŠ¤í¬ ë…¸ë“œ
        nodeGapY: 70,
        taskGapY: 50,
        subtaskGapY: 38
      };
      
      // íŠ¸ë¦¬ ìë™ ì •ë ¬ í•¨ìˆ˜ - ë ˆë²¨ë³„ ê³ ì • Xì¢Œí‘œ
      const autoLayoutTree = (nodeList, connList) => {
        const centerNode = nodeList.find(n => n.id === 'center');
        if (!centerNode) return nodeList;
        
        // ë ˆë²¨ë³„ X ì¢Œí‘œ
        const levelX = {
          0: LAYOUT.centerX,
          1: LAYOUT.level1X,
          2: LAYOUT.level2X,
          3: LAYOUT.level3X,
          4: LAYOUT.level4X,
          5: LAYOUT.level4X + 150
        };
        
        // ìì‹ ë…¸ë“œ ê°€ì ¸ì˜¤ê¸°
        const getChildren = (parentId) => {
          return connList.filter(c => c.from === parentId).map(c => nodeList.find(n => n.id === c.to)).filter(Boolean);
        };
        
        // ì„œë¸ŒíŠ¸ë¦¬ ë†’ì´ ê³„ì‚° (ì´ í•„ìš” ì„¸ë¡œ ê³µê°„)
        const getSubtreeHeight = (nodeId, level, visited = new Set()) => {
          if (visited.has(nodeId)) return 0;
          visited.add(nodeId);
          
          const children = getChildren(nodeId);
          const gap = level === 1 ? LAYOUT.nodeGapY : level === 2 ? LAYOUT.taskGapY : LAYOUT.subtaskGapY;
          
          if (children.length === 0) return gap;
          
          let totalHeight = 0;
          children.forEach(child => {
            totalHeight += getSubtreeHeight(child.id, level + 1, new Set(visited));
          });
          return totalHeight;
        };
        
        // ë…¸ë“œ ë°°ì¹˜ (ì¬ê·€)
        const positionNode = (nodeId, level, startY) => {
          const node = nodeList.find(n => n.id === nodeId);
          if (!node) return startY;
          
          node.x = levelX[level] || (levelX[4] + (level - 4) * 160);
          
          const children = getChildren(nodeId);
          const gap = level === 1 ? LAYOUT.nodeGapY : level === 2 ? LAYOUT.taskGapY : LAYOUT.subtaskGapY;
          
          if (children.length === 0) {
            node.y = startY;
            return startY + gap;
          }
          
          // ìì‹ë“¤ ë¨¼ì € ë°°ì¹˜
          let currentY = startY;
          const childYs = [];
          
          children.forEach(child => {
            const childStartY = currentY;
            currentY = positionNode(child.id, level + 1, currentY);
            childYs.push(nodeList.find(n => n.id === child.id)?.y || childStartY);
          });
          
          // ë¶€ëª¨ëŠ” ìì‹ë“¤ì˜ ì¤‘ì•™ì— ë°°ì¹˜
          if (childYs.length > 0) {
            node.y = (Math.min(...childYs) + Math.max(...childYs)) / 2;
          } else {
            node.y = startY;
          }
          
          return currentY;
        };
        
        // ì¤‘ì‹¬ ë…¸ë“œë¶€í„° ì‹œì‘
        const level1Children = getChildren('center');
        let currentY = 100;
        
        level1Children.forEach(child => {
          currentY = positionNode(child.id, 1, currentY);
        });
        
        // ì¤‘ì‹¬ ë…¸ë“œ ìœ„ì¹˜ ì„¤ì •
        centerNode.x = LAYOUT.centerX;
        if (level1Children.length > 0) {
          const ys = level1Children.map(c => c.y);
          centerNode.y = (Math.min(...ys) + Math.max(...ys)) / 2;
        } else {
          centerNode.y = LAYOUT.centerY;
        }
        
        return nodeList;
      };
      
      // í”„ë¡œì íŠ¸ ë“œë¡­ í•¸ë“¤ëŸ¬ - í”„ë¡œì íŠ¸ + í•˜ìœ„ì—…ë¬´ ì¶”ê°€
      const handleDropProject = (project) => {
        const centerNode = nodes.find(n => n.id === 'center');
        if (!centerNode) return;
        
        const projectBrand = getProjectBrand(project);
        if (!projectBrand) return;
        
        // í•´ë‹¹ ë¸Œëœë“œì˜ ë…¸ë“œê°€ ì´ë¯¸ ìˆëŠ”ì§€ í™•ì¸
        const brandNodeId = `brand-${projectBrand.id}`;
        let existingBrandNode = nodes.find(n => n.id === brandNodeId);
        
        let updatedNodes = [...nodes];
        let updatedConnections = [...connections];
        
        // ë¸Œëœë“œ ë…¸ë“œê°€ ì—†ìœ¼ë©´ ìƒì„±
        if (!existingBrandNode) {
          const brandNode = {
            id: brandNodeId,
            type: 'brand',
            text: projectBrand.name,
            x: 0,
            y: 0,
            color: projectBrand.color,
            brandId: projectBrand.id
          };
          
          updatedNodes.push(brandNode);
          updatedConnections.push({
            id: `conn-brand-${brandNodeId}`,
            from: 'center',
            to: brandNodeId
          });
        }
        
        // ì™„ë£Œëœ í•˜ìœ„ì—…ë¬´ ì¤‘ ë‚´ê°€ ë‹´ë‹¹í•œ ì—…ë¬´ë§Œ í•„í„°ë§ (ë¶€ëª¨ ì—…ë¬´ë§Œ)
        const allProjectTasks = getProjectTasks(project.id);
        const projectTasks = allProjectTasks.filter(t => 
          t.completed && !t.parentTaskId && t.memberId === currentUser.id
        );
        
        // í”„ë¡œì íŠ¸ ë…¸ë“œ (ë¸Œëœì¹˜ë¡œ ìƒì„±)
        const projectNodeId = `project-${project.id}-${Date.now()}`;
        
        const projectNode = {
          id: projectNodeId,
          type: 'branch',
          projectId: project.id,
          text: project.title,
          x: 0,
          y: 0,
          color: projectBrand?.color || '#6B7684',
          brandId: project.brandId,
          kpiLabel: '',
          kpiValue: ''
        };
        
        // í”„ë¡œì íŠ¸-ë¸Œëœë“œ ì—°ê²° (ë¸Œëœë“œ ë…¸ë“œ ì•„ë˜ì—)
        const projectConnection = {
          id: `conn-project-${Date.now()}`,
          from: brandNodeId,
          to: projectNodeId
        };
        
        // ì™„ë£Œëœ í•˜ìœ„ì—…ë¬´ ë…¸ë“œë“¤
        const taskNodes = [];
        const taskConnections = [];
        const subtaskNodes = [];
        const subtaskConnections = [];
        
        projectTasks.forEach((task) => {
          const taskNodeId = `task-${task.id}-${Date.now()}`;
          
          taskNodes.push({
            id: taskNodeId,
            type: 'task',
            taskId: task.id,
            text: task.title,
            x: 0,
            y: 0,
            completed: task.completed,
            color: '#00C471'
          });
          
          taskConnections.push({
            id: `conn-task-${taskNodeId}`,
            from: projectNodeId,
            to: taskNodeId
          });
          
          // ì„œë¸ŒíƒœìŠ¤í¬ ì¶”ê°€
          const subtasks = allProjectTasks.filter(st => st.parentTaskId === task.id && st.completed && st.memberId === currentUser.id);
          subtasks.forEach((st) => {
            const subtaskNodeId = `subtask-${st.id}-${Date.now()}`;
            subtaskNodes.push({
              id: subtaskNodeId,
              type: 'task',
              taskId: st.id,
              text: st.title,
              x: 0,
              y: 0,
              completed: st.completed,
              color: '#10B981',
              isSubtask: true
            });
            
            subtaskConnections.push({
              id: `conn-subtask-${subtaskNodeId}`,
              from: taskNodeId,
              to: subtaskNodeId
            });
          });
        });
        
        updatedNodes = [...updatedNodes, projectNode, ...taskNodes, ...subtaskNodes];
        updatedConnections = [...updatedConnections, projectConnection, ...taskConnections, ...subtaskConnections];
        
        // ìë™ ë ˆì´ì•„ì›ƒ ì ìš©
        updatedNodes = autoLayoutTree(updatedNodes, updatedConnections);
        
        setNodes(updatedNodes);
        setConnections(updatedConnections);
        saveBoard(updatedNodes, updatedConnections);
      };
      
      // ê°€ì§€(ë¸Œëœì¹˜) ì¶”ê°€
      const addBranch = () => {
        if (!newBranchName.trim()) return;
        
        const newNode = {
          id: `branch-${Date.now()}`,
          type: 'branch',
          text: newBranchName.trim(),
          x: 0,
          y: 0,
          color: '#6B7684',
          kpiLabel: '',
          kpiValue: ''
        };
        
        const newConnection = {
          id: `conn-${Date.now()}`,
          from: 'center',
          to: newNode.id
        };
        
        let updatedNodes = [...nodes, newNode];
        const updatedConnections = [...connections, newConnection];
        
        // ìë™ ë ˆì´ì•„ì›ƒ ì ìš©
        updatedNodes = autoLayoutTree(updatedNodes, updatedConnections);
        
        setNodes(updatedNodes);
        setConnections(updatedConnections);
        saveBoard(updatedNodes, updatedConnections);
        
        setNewBranchName('');
        setShowAddBranch(false);
      };
      
      // ì—…ë¬´ë¥¼ ë¸Œëœì¹˜ì— ì¶”ê°€ (ë“œë¡­)
      const handleDropOnBranch = (branchId, task) => {
        const branchNode = nodes.find(n => n.id === branchId);
        if (!branchNode) return;
        
        const childCount = connections.filter(c => c.from === branchId).length;
        const offsetY = childCount * 50;
        
        const newNode = {
          id: `task-${Date.now()}`,
          type: 'task',
          taskId: task.id,
          text: task.title,
          x: branchNode.x + 180,
          y: branchNode.y - 50 + offsetY,
          completed: task.completed,
          color: task.completed ? '#00C471' : '#3182F6'
        };
        
        const newConnection = {
          id: `conn-${Date.now()}`,
          from: branchId,
          to: newNode.id
        };
        
        const updatedNodes = [...nodes, newNode];
        const updatedConnections = [...connections, newConnection];
        
        setNodes(updatedNodes);
        setConnections(updatedConnections);
        saveBoard(updatedNodes, updatedConnections);
      };
      
      // ë…¸ë“œ ë“œë˜ê·¸ ì¤‘ì¸ ë…¸ë“œ IDì™€ ê²¹ì¹˜ëŠ” ëŒ€ìƒ ë…¸ë“œ
      const [draggingNodeId, setDraggingNodeId] = useState(null);
      const [dropTargetNodeId, setDropTargetNodeId] = useState(null);
      const dropTargetRef = React.useRef(null); // refë¡œ ì‹¤ì‹œê°„ ì¶”ì 
      
      // ë…¸ë“œì˜ ëª¨ë“  ìì† ID ê°€ì ¸ì˜¤ê¸°
      const getAllDescendantIds = (nodeId, connList) => {
        const descendants = [];
        const childConns = connList.filter(c => c.from === nodeId);
        childConns.forEach(conn => {
          descendants.push(conn.to);
          descendants.push(...getAllDescendantIds(conn.to, connList));
        });
        return descendants;
      };
      
      // ë…¸ë“œ ë“œë˜ê·¸ (ìì‹ë“¤ë„ í•¨ê»˜ ì´ë™)
      const handleNodeDrag = (nodeId, dx, dy) => {
        setDraggingNodeId(nodeId);
        
        // ì´ë™í•  ë…¸ë“œë“¤ (ìì‹  + ëª¨ë“  ìì†)
        const descendantIds = getAllDescendantIds(nodeId, connections);
        const moveIds = [nodeId, ...descendantIds];
        
        // ë“œë˜ê·¸ ë…¸ë“œì˜ ë¶€ëª¨ ì°¾ê¸°
        const dragParentConn = connections.find(c => c.to === nodeId);
        const dragParentId = dragParentConn?.from;
        
        setNodes(prev => {
          const updated = prev.map(n => 
            moveIds.includes(n.id) ? { ...n, x: n.x + dx, y: n.y + dy } : n
          );
          
          // ë…¸ë“œ ë„ˆë¹„ ê³„ì‚°
          const getNodeWidth = (n) => {
            if (n.type === 'center') return 120;
            if (n.type === 'brand') return 130;
            if (n.type === 'branch') return 140;
            return n.isSubtask ? 110 : 130;
          };
          
          // ë…¸ë“œ ì¤‘ì‹¬ì  ê³„ì‚° (ì™¼ìª½ ì •ë ¬ ë…¸ë“œëŠ” x + width/2)
          const getNodeCenter = (n) => {
            if (n.type === 'center') return { x: n.x, y: n.y };
            return { x: n.x + getNodeWidth(n) / 2, y: n.y };
          };
          
          // ë“œë˜ê·¸ ì¤‘ì¸ ë…¸ë“œì™€ ê²¹ì¹˜ëŠ” ë…¸ë“œ ì°¾ê¸° (ìì† ì œì™¸)
          const draggingNode = updated.find(n => n.id === nodeId);
          if (draggingNode) {
            const dragCenter = getNodeCenter(draggingNode);
            let foundTarget = null;
            let minDist = Infinity;
            
            for (const otherNode of updated) {
              if (otherNode.id === nodeId) continue;
              if (moveIds.includes(otherNode.id)) continue; // ìì†ì€ ë“œë¡­ ëŒ€ìƒì—ì„œ ì œì™¸
              
              // íƒ€ê²Ÿ ë…¸ë“œì˜ ë¶€ëª¨ ì°¾ê¸°
              const otherParentConn = connections.find(c => c.to === otherNode.id);
              const otherParentId = otherParentConn?.from;
              
              // ê°™ì€ ë¶€ëª¨ì˜ í˜•ì œê°€ ì•„ë‹Œ taskëŠ” ë“œë¡­ ëŒ€ìƒì—ì„œ ì œì™¸ (ë¶€ëª¨ê°€ ë  ìˆ˜ ì—†ìŒ)
              const isSibling = dragParentId && dragParentId === otherParentId;
              if (otherNode.type === 'task' && !isSibling) continue;
              
              const otherCenter = getNodeCenter(otherNode);
              
              // ê²¹ì¹¨ íŒì • (ë…¸ë“œ ì¤‘ì‹¬ ê°„ ê±°ë¦¬)
              const dist = Math.sqrt(
                Math.pow(dragCenter.x - otherCenter.x, 2) + 
                Math.pow(dragCenter.y - otherCenter.y, 2)
              );
              
              if (dist < 100 && dist < minDist) { // 100px ì´ë‚´ ì¤‘ ê°€ì¥ ê°€ê¹Œìš´ ë…¸ë“œ
                foundTarget = otherNode.id;
                minDist = dist;
              }
            }
            dropTargetRef.current = foundTarget; // refë„ ì—…ë°ì´íŠ¸
            setDropTargetNodeId(foundTarget);
          }
          
          return updated;
        });
      };
      
      const handleNodeDragEnd = (nodeId) => {
        // ë“œë¡­ ëŒ€ìƒì´ ìˆìœ¼ë©´ ì´ë™ (ref ì‚¬ìš©ìœ¼ë¡œ ìµœì‹  ê°’ ë³´ì¥)
        const targetId = dropTargetRef.current;
        if (targetId && nodeId) {
          handleMoveNodeToParent(nodeId, targetId);
        } else {
          saveBoard(nodes, connections);
        }
        setDraggingNodeId(null);
        setDropTargetNodeId(null);
        dropTargetRef.current = null;
      };
      
      // ë…¸ë“œë¥¼ ë‹¤ë¥¸ ë…¸ë“œì˜ í•˜ìœ„ë¡œ ì´ë™ ë˜ëŠ” ìˆœì„œ ë³€ê²½
      const handleMoveNodeToParent = (childNodeId, targetNodeId) => {
        if (childNodeId === targetNodeId) return;
        if (childNodeId === 'center') return;
        
        const childNode = nodes.find(n => n.id === childNodeId);
        const targetNode = nodes.find(n => n.id === targetNodeId);
        if (!childNode || !targetNode) return;
        
        // ë“œë˜ê·¸ ë…¸ë“œì˜ í˜„ì¬ ë¶€ëª¨ ì°¾ê¸°
        const childParentConn = connections.find(c => c.to === childNodeId);
        const childParentId = childParentConn?.from;
        
        // íƒ€ê²Ÿ ë…¸ë“œì˜ ë¶€ëª¨ ì°¾ê¸°
        const targetParentConn = connections.find(c => c.to === targetNodeId);
        const targetParentId = targetParentConn?.from;
        
        // ìê¸° ìì‹ ì˜ ìì‹ì—ê²Œ ì´ë™í•˜ëŠ” ê²ƒ ë°©ì§€
        const isChildOfDragging = (nodeId) => {
          const childConns = connections.filter(c => c.from === childNodeId);
          for (const conn of childConns) {
            if (conn.to === nodeId) return true;
            if (isChildOfDragging(conn.to)) return true;
          }
          return false;
        };
        if (isChildOfDragging(targetNodeId)) return;
        
        let updatedConnections = [...connections];
        
        // ê°™ì€ ë¶€ëª¨ë¥¼ ê°€ì§„ í˜•ì œ ë…¸ë“œì¸ ê²½ìš° â†’ ìˆœì„œë§Œ ë³€ê²½ (ì—°ê²°ì€ ê·¸ëŒ€ë¡œ)
        if (childParentId === targetParentId && childParentId) {
          // ì—°ê²°ì€ ë³€ê²½í•˜ì§€ ì•Šê³ , ìˆœì„œë§Œ ë°”ê¾¸ê¸° ìœ„í•´ connections ë°°ì—´ ìˆœì„œ ì¡°ì •
          const parentConns = updatedConnections.filter(c => c.from === childParentId);
          const otherConns = updatedConnections.filter(c => c.from !== childParentId);
          
          // íƒ€ê²Ÿ ë…¸ë“œ ìœ„ì¹˜ ì°¾ê¸°
          const targetIdx = parentConns.findIndex(c => c.to === targetNodeId);
          const childIdx = parentConns.findIndex(c => c.to === childNodeId);
          
          if (targetIdx !== -1 && childIdx !== -1) {
            // childë¥¼ target ìœ„ì¹˜ë¡œ ì´ë™
            const [childConn] = parentConns.splice(childIdx, 1);
            const newTargetIdx = parentConns.findIndex(c => c.to === targetNodeId);
            parentConns.splice(newTargetIdx, 0, childConn);
            updatedConnections = [...otherConns, ...parentConns];
          }
        } else {
          // ë‹¤ë¥¸ ë¶€ëª¨ì˜ ë…¸ë“œ â†’ í•˜ìœ„ë¡œ ì´ë™
          // ê¸°ì¡´ ì—°ê²° ì œê±°
          updatedConnections = connections.filter(c => c.to !== childNodeId);
          
          // ìƒˆ ì—°ê²° ì¶”ê°€ (íƒ€ê²Ÿ ë…¸ë“œì˜ í•˜ìœ„ë¡œ)
          updatedConnections.push({
            id: `conn-move-${Date.now()}`,
            from: targetNodeId,
            to: childNodeId
          });
        }
        
        // ìë™ ë ˆì´ì•„ì›ƒ ì ìš©
        let updatedNodes = autoLayoutTree([...nodes], updatedConnections);
        
        setNodes(updatedNodes);
        setConnections(updatedConnections);
        saveBoard(updatedNodes, updatedConnections);
        setDraggingNodeId(null);
        setDropTargetNodeId(null);
        dropTargetRef.current = null;
      };
      
      // ë…¸ë“œ ì‚­ì œ
      const deleteNode = (nodeId) => {
        if (nodeId === 'center') return;
        
        // ì—°ê²°ëœ ìì‹ ë…¸ë“œë„ í•¨ê»˜ ì‚­ì œ
        const childIds = connections.filter(c => c.from === nodeId).map(c => c.to);
        const allDeleteIds = [nodeId, ...childIds];
        
        const updatedNodes = nodes.filter(n => !allDeleteIds.includes(n.id));
        const updatedConnections = connections.filter(c => 
          !allDeleteIds.includes(c.from) && !allDeleteIds.includes(c.to)
        );
        
        setNodes(updatedNodes);
        setConnections(updatedConnections);
        saveBoard(updatedNodes, updatedConnections);
        setSelectedNode(null);
      };
      
      // KPI ì—…ë°ì´íŠ¸
      const updateNodeKpi = (nodeId, kpiLabel, kpiValue) => {
        const updatedNodes = nodes.map(n => 
          n.id === nodeId ? { ...n, kpiLabel, kpiValue } : n
        );
        setNodes(updatedNodes);
        saveBoard(updatedNodes, connections);
      };
      
      // ë…¸ë“œ í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
      const updateNodeText = (nodeId, text) => {
        const updatedNodes = nodes.map(n => 
          n.id === nodeId ? { ...n, text } : n
        );
        setNodes(updatedNodes);
        saveBoard(updatedNodes, connections);
        setEditingNode(null);
      };
      
      // ë¸Œëœë“œ ì •ë³´
      const brand = BRANDS.find(b => b.id === selectedBrand);
      
      // ë“œë˜ê·¸ ì¤‘ì¸ í”„ë¡œì íŠ¸
      const [draggedProject, setDraggedProject] = useState(null);
      const [dragOverNodeId, setDragOverNodeId] = useState(null);
      
      // ì¹´í…Œê³ ë¦¬ì— í”„ë¡œì íŠ¸ ë“œë¡­ í•¸ë“¤ëŸ¬
      const handleDropOnCategory = (categoryNodeId, project) => {
        const categoryNode = nodes.find(n => n.id === categoryNodeId);
        if (!categoryNode || categoryNode.projectId) return; // ì´ë¯¸ í”„ë¡œì íŠ¸ê°€ ì—°ê²°ëœ ë…¸ë“œë©´ ë¬´ì‹œ
        
        const projectBrand = getProjectBrand(project);
        
        // ì™„ë£Œëœ í•˜ìœ„ì—…ë¬´ ì¤‘ ë‚´ê°€ ë‹´ë‹¹í•œ ì—…ë¬´ë§Œ í•„í„°ë§ (ë¶€ëª¨ ì—…ë¬´ë§Œ)
        const allProjectTasks = getProjectTasks(project.id);
        const projectTasks = allProjectTasks.filter(t => 
          t.completed && !t.parentTaskId && t.memberId === currentUser.id
        );
        
        // í”„ë¡œì íŠ¸ ë…¸ë“œ ìƒì„± (ì¹´í…Œê³ ë¦¬ í•˜ìœ„ì—)
        const projectNodeId = `project-${project.id}-${Date.now()}`;
        const projectNode = {
          id: projectNodeId,
          type: 'branch',
          projectId: project.id,
          text: project.title,
          x: 0,
          y: 0,
          color: projectBrand?.color || '#6B7684',
          brandId: project.brandId,
          kpiLabel: '',
          kpiValue: ''
        };
        
        // í”„ë¡œì íŠ¸-ì¹´í…Œê³ ë¦¬ ì—°ê²°
        const projectConnection = {
          id: `conn-project-${Date.now()}`,
          from: categoryNodeId,
          to: projectNodeId
        };
        
        // ì™„ë£Œëœ í•˜ìœ„ì—…ë¬´ ë…¸ë“œë“¤ + ì„œë¸ŒíƒœìŠ¤í¬
        const taskNodes = [];
        const taskConnections = [];
        const subtaskNodes = [];
        const subtaskConnections = [];
        
        projectTasks.forEach((task) => {
          const taskNodeId = `task-${task.id}-${Date.now()}`;
          
          taskNodes.push({
            id: taskNodeId,
            type: 'task',
            taskId: task.id,
            text: task.title,
            x: 0,
            y: 0,
            completed: task.completed,
            color: '#00C471'
          });
          
          taskConnections.push({
            id: `conn-task-${taskNodeId}`,
            from: projectNodeId,
            to: taskNodeId
          });
          
          // ì„œë¸ŒíƒœìŠ¤í¬ ì¶”ê°€
          const subtasks = allProjectTasks.filter(st => st.parentTaskId === task.id && st.completed && st.memberId === currentUser.id);
          subtasks.forEach((st) => {
            const subtaskNodeId = `subtask-${st.id}-${Date.now()}`;
            subtaskNodes.push({
              id: subtaskNodeId,
              type: 'task',
              taskId: st.id,
              text: st.title,
              x: 0,
              y: 0,
              completed: st.completed,
              color: '#10B981',
              isSubtask: true
            });
            
            subtaskConnections.push({
              id: `conn-subtask-${subtaskNodeId}`,
              from: taskNodeId,
              to: subtaskNodeId
            });
          });
        });
        
        let updatedNodes = [...nodes, projectNode, ...taskNodes, ...subtaskNodes];
        const updatedConnections = [...connections, projectConnection, ...taskConnections, ...subtaskConnections];
        
        // ìë™ ë ˆì´ì•„ì›ƒ ì ìš©
        updatedNodes = autoLayoutTree(updatedNodes, updatedConnections);
        
        setNodes(updatedNodes);
        setConnections(updatedConnections);
        saveBoard(updatedNodes, updatedConnections);
      };
      
      // ì „ì²´ ë ˆì´ì•„ì›ƒ ì¬ì •ë ¬ í•¨ìˆ˜
      const reLayoutAll = () => {
        const updatedNodes = autoLayoutTree([...nodes], connections);
        setNodes(updatedNodes);
        saveBoard(updatedNodes, connections);
      };

      return (
        <div style={{ display: 'flex', height: '100vh', background: '#F7F8FA' }}>
          {/* ì™¼ìª½: í”„ë¡œì íŠ¸ ëª©ë¡ (ë¸Œëœë“œë³„ ê·¸ë£¹í™”) */}
          <div style={{ width: 320, background: 'white', borderRight: '1px solid #E5E8EB', display: 'flex', flexDirection: 'column' }}>
            <div style={{ padding: 20, borderBottom: '1px solid #E5E8EB' }}>
              <h2 style={{ fontSize: 16, fontWeight: 700, color: '#191F28', marginBottom: 16 }}>ğŸ“ í”„ë¡œì íŠ¸</h2>
              
              {/* ê¸°ê°„ ì„ íƒ */}
              <div style={{ display: 'flex', gap: 8 }}>
                <select 
                  value={selectedYear} 
                  onChange={(e) => setSelectedYear(Number(e.target.value))}
                  style={{ flex: 1, padding: '8px 12px', borderRadius: 8, border: '1px solid #E5E8EB', fontSize: 13 }}
                >
                  {[2024, 2025, 2026].map(y => <option key={y} value={y}>{y}ë…„</option>)}
                </select>
                <select 
                  value={selectedWeek} 
                  onChange={(e) => setSelectedWeek(Number(e.target.value))}
                  style={{ flex: 1, padding: '8px 12px', borderRadius: 8, border: '1px solid #E5E8EB', fontSize: 13 }}
                >
                  {Array.from({ length: 52 }, (_, i) => i + 1).map(w => 
                    <option key={w} value={w}>{w}ì£¼ì°¨</option>
                  )}
                </select>
              </div>
            </div>
            
            {/* ë¸Œëœë“œë³„ í”„ë¡œì íŠ¸ ëª©ë¡ */}
            <div style={{ flex: 1, overflow: 'auto', padding: 12 }}>
              {BRANDS.map(brand => {
                const brandProjects = myProjects.filter(p => p.brandId === brand.id);
                if (brandProjects.length === 0) return null;
                
                return (
                  <div key={brand.id} style={{ marginBottom: 20 }}>
                    {/* ë¸Œëœë“œ í—¤ë” */}
                    <div style={{ 
                      display: 'flex', alignItems: 'center', gap: 8, 
                      padding: '8px 12px', marginBottom: 8,
                      background: `${brand.color}10`, borderRadius: 8,
                      borderLeft: `3px solid ${brand.color}`
                    }}>
                      <span style={{ fontSize: 13, fontWeight: 700, color: brand.color }}>{brand.name}</span>
                      <span style={{ fontSize: 11, color: '#8B95A1' }}>({brandProjects.length})</span>
                    </div>
                    
                    {/* í”„ë¡œì íŠ¸ ì¹´ë“œë“¤ */}
                    <div style={{ display: 'flex', flexDirection: 'column', gap: 6 }}>
                      {brandProjects.map(project => {
                        const isAdded = addedProjectIds.includes(project.id);
                        const projectTasks = getProjectTasks(project.id);
                        const completedCount = projectTasks.filter(t => t.completed).length;
                        const statusColors = { progress: '#3182F6', hold: '#F59E0B', complete: '#00C471' };
                        const statusLabels = { progress: 'ì§„í–‰ì¤‘', hold: 'ë³´ë¥˜', complete: 'ì™„ë£Œ' };
                        
                        return (
                          <div
                            key={project.id}
                            draggable={!isAdded}
                            onDragStart={(e) => {
                              if (isAdded) return;
                              setDraggedProject(project);
                              e.dataTransfer.effectAllowed = 'copy';
                            }}
                            onDragEnd={() => setDraggedProject(null)}
                            style={{
                              padding: '12px 14px', borderRadius: 10,
                              background: isAdded ? '#F7F8FA' : 'white',
                              border: `1px solid ${isAdded ? '#E5E8EB' : '#E5E8EB'}`,
                              opacity: isAdded ? 0.5 : 1,
                              cursor: isAdded ? 'default' : 'grab',
                              borderLeft: `3px solid ${brand.color}`
                            }}
                          >
                            <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', marginBottom: 6 }}>
                              <span style={{ 
                                fontSize: 13, fontWeight: 600, 
                                color: '#191F28',
                                flex: 1
                              }}>{project.title}</span>
                              {isAdded && <span style={{ fontSize: 10, color: '#00C471', fontWeight: 600 }}>âœ“ ì¶”ê°€ë¨</span>}
                            </div>
                            <div style={{ display: 'flex', alignItems: 'center', gap: 6 }}>
                              <span style={{ 
                                fontSize: 10, padding: '2px 6px', borderRadius: 4, 
                                background: `${statusColors[project.status]}15`, 
                                color: statusColors[project.status],
                                fontWeight: 600
                              }}>{statusLabels[project.status]}</span>
                              <span style={{ fontSize: 10, color: '#8B95A1' }}>
                                ì™„ë£Œ {completedCount} / ì „ì²´ {projectTasks.length}
                              </span>
                            </div>
                          </div>
                        );
                      })}
                    </div>
                  </div>
                );
              })}
              
              {myProjects.length === 0 && (
                <div style={{ padding: 20, textAlign: 'center', color: '#8B95A1' }}>
                  <Icon name="folder" size={32} color="#D1D6DB" />
                  <p style={{ fontSize: 13, marginTop: 8 }}>ë‚´ í”„ë¡œì íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤</p>
                </div>
              )}
            </div>
          </div>
          
          {/* ì˜¤ë¥¸ìª½: ë§ˆì¸ë“œë§µ ìº”ë²„ìŠ¤ */}
          <div style={{ flex: 1, display: 'flex', flexDirection: 'column' }}>
            {/* ìƒë‹¨ íˆ´ë°” */}
            <div style={{ padding: '16px 24px', background: 'white', borderBottom: '1px solid #E5E8EB', display: 'flex', alignItems: 'center', justifyContent: 'space-between' }}>
              <div style={{ display: 'flex', alignItems: 'center', gap: 12 }}>
                <h1 style={{ fontSize: 20, fontWeight: 700, color: '#191F28' }}>
                  ğŸ¯ ê·¸ë¡œìŠ¤ë³´ë“œ
                </h1>
                <span style={{ fontSize: 14, color: '#6B7684', background: '#F7F8FA', padding: '4px 12px', borderRadius: 6 }}>
                  {selectedYear}ë…„ {selectedWeek}ì£¼ì°¨
                </span>
              </div>
              
              <div style={{ display: 'flex', gap: 8 }}>
                <button
                  onClick={syncWithProjects}
                  style={{
                    display: 'flex', alignItems: 'center', gap: 6,
                    padding: '10px 16px', borderRadius: 8,
                    border: '1px solid #00C471', background: '#F0FDF4', color: '#00C471',
                    fontSize: 13, fontWeight: 600, cursor: 'pointer'
                  }}
                  title="í”„ë¡œì íŠ¸/ì—…ë¬´ ë³€ê²½ì‚¬í•­ ë™ê¸°í™” + ì •ë ¬"
                >
                  <Icon name="refresh" size={16} color="#00C471" /> ë™ê¸°í™”
                </button>
                <button
                  onClick={() => setShowAddBranch(true)}
                  style={{
                    display: 'flex', alignItems: 'center', gap: 6,
                    padding: '10px 16px', borderRadius: 8,
                    border: 'none', background: '#3182F6', color: 'white',
                    fontSize: 13, fontWeight: 600, cursor: 'pointer'
                  }}
                >
                  <Icon name="plus" size={16} color="white" /> ì¹´í…Œê³ ë¦¬ ì¶”ê°€
                </button>
              </div>
            </div>
            
            {/* ìº”ë²„ìŠ¤ ì»¨í…Œì´ë„ˆ - ë¬´í•œ ìº”ë²„ìŠ¤ */}
            <div 
              ref={canvasRef}
              style={{ 
                flex: 1, 
                position: 'relative', 
                overflow: 'hidden',
                background: draggedProject ? '#F0F7FF' : '#FAFBFC',
                cursor: spacePressed ? (isPanning ? 'grabbing' : 'grab') : 'default',
                outline: 'none'
              }}
              onDragOver={(e) => { e.preventDefault(); e.dataTransfer.dropEffect = 'copy'; }}
              onDrop={(e) => {
                e.preventDefault();
                if (!draggedProject) return;
                handleDropProject(draggedProject);
                setDraggedProject(null);
              }}
              onWheel={(e) => {
                e.preventDefault();
                if (e.ctrlKey || e.metaKey) {
                  // ì¤Œ (ë§ˆìš°ìŠ¤ ìœ„ì¹˜ ê¸°ì¤€)
                  const rect = canvasRef.current.getBoundingClientRect();
                  const mouseX = e.clientX - rect.left;
                  const mouseY = e.clientY - rect.top;
                  
                  const delta = e.deltaY > 0 ? 0.9 : 1.1;
                  const newZoom = Math.min(3, Math.max(0.2, zoom * delta));
                  
                  // ë§ˆìš°ìŠ¤ ìœ„ì¹˜ ê¸°ì¤€ ì¤Œ
                  const zoomRatio = newZoom / zoom;
                  setOffset(prev => ({
                    x: mouseX - (mouseX - prev.x) * zoomRatio,
                    y: mouseY - (mouseY - prev.y) * zoomRatio
                  }));
                  setZoom(newZoom);
                } else {
                  // ì¼ë°˜ ìŠ¤í¬ë¡¤ = íŒ¨ë‹
                  setOffset(prev => ({
                    x: prev.x - e.deltaX,
                    y: prev.y - e.deltaY
                  }));
                }
              }}
              onMouseDown={(e) => {
                // ìŠ¤í˜ì´ìŠ¤ë°” + ì™¼ìª½ ë§ˆìš°ìŠ¤ ë²„íŠ¼ìœ¼ë¡œ íŒ¨ë‹
                if (e.button === 0 && spacePressed) {
                  e.preventDefault();
                  setIsPanning(true);
                  panStart.current = { 
                    x: e.clientX, 
                    y: e.clientY,
                    offsetX: offset.x,
                    offsetY: offset.y
                  };
                }
              }}
              onMouseMove={(e) => {
                if (isPanning) {
                  e.preventDefault();
                  const dx = e.clientX - panStart.current.x;
                  const dy = e.clientY - panStart.current.y;
                  setOffset({
                    x: panStart.current.offsetX + dx,
                    y: panStart.current.offsetY + dy
                  });
                }
              }}
              onMouseUp={() => setIsPanning(false)}
              onMouseLeave={() => setIsPanning(false)}
            >
              {/* ì¤Œ ì»¨íŠ¸ë¡¤ */}
              <div style={{
                position: 'absolute', bottom: 20, right: 20, zIndex: 100,
                display: 'flex', alignItems: 'center', gap: 8,
                background: 'white', padding: '8px 12px', borderRadius: 8,
                boxShadow: '0 2px 8px rgba(0,0,0,0.1)', border: '1px solid #E5E8EB'
              }}>
                <button
                  onClick={() => setZoom(z => Math.max(0.2, z * 0.9))}
                  style={{ width: 28, height: 28, border: '1px solid #E5E8EB', borderRadius: 4, background: 'white', cursor: 'pointer', fontSize: 16 }}
                >âˆ’</button>
                <span style={{ fontSize: 12, color: '#6B7684', minWidth: 45, textAlign: 'center' }}>{Math.round(zoom * 100)}%</span>
                <button
                  onClick={() => setZoom(z => Math.min(3, z * 1.1))}
                  style={{ width: 28, height: 28, border: '1px solid #E5E8EB', borderRadius: 4, background: 'white', cursor: 'pointer', fontSize: 16 }}
                >+</button>
                <button
                  onClick={() => { setZoom(1); setOffset({ x: 0, y: 0 }); }}
                  style={{ padding: '4px 8px', border: '1px solid #E5E8EB', borderRadius: 4, background: 'white', cursor: 'pointer', fontSize: 11, color: '#6B7684' }}
                >ë¦¬ì…‹</button>
              </div>
              
              {/* ë„ì›€ë§ */}
              <div style={{
                position: 'absolute', bottom: 20, left: 20, zIndex: 100,
                fontSize: 11, color: '#8B95A1', background: 'rgba(255,255,255,0.9)', 
                padding: '6px 10px', borderRadius: 6
              }}>
                ìŠ¤í˜ì´ìŠ¤+ë“œë˜ê·¸: ì´ë™ | Ctrl+íœ : ì¤Œ | íœ : ìŠ¤í¬ë¡¤
              </div>
              
              {/* ë“œë˜ê·¸ ì¤‘ ì•ˆë‚´ */}
              {draggedProject && (
                <div style={{
                  position: 'absolute', top: '50%', left: '50%', transform: 'translate(-50%, -50%)',
                  background: 'white', padding: '20px 32px', borderRadius: 16,
                  boxShadow: '0 8px 32px rgba(0,0,0,0.15)', textAlign: 'center',
                  border: '2px dashed #3182F6', zIndex: 10
                }}>
                  <p style={{ fontSize: 16, fontWeight: 600, color: '#3182F6', marginBottom: 4 }}>
                    ğŸ¯ ì—¬ê¸°ì— ë†“ìœ¼ì„¸ìš”!
                  </p>
                  <p style={{ fontSize: 13, color: '#6B7684' }}>
                    í”„ë¡œì íŠ¸ + í•˜ìœ„ì—…ë¬´ê°€ ìë™ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤
                  </p>
                </div>
              )}
              
              {/* ë¬´í•œ ìº”ë²„ìŠ¤ - transformìœ¼ë¡œ ì¤Œ/íŒ¨ë‹ */}
              <div 
                data-canvas="true"
                style={{
                  position: 'absolute',
                  left: 0,
                  top: 0,
                  transform: `translate(${offset.x}px, ${offset.y}px) scale(${zoom})`,
                  transformOrigin: '0 0'
                }}
              >
              
              {/* SVG ì—°ê²°ì„  - EdrawMind ìŠ¤íƒ€ì¼ ì§ê° */}
              <svg style={{ position: 'absolute', left: 0, top: 0, width: 3000, height: 2000, pointerEvents: 'none', overflow: 'visible' }}>
                {connections.map(conn => {
                  const fromNode = nodes.find(n => n.id === conn.from);
                  const toNode = nodes.find(n => n.id === conn.to);
                  if (!fromNode || !toNode) return null;
                  
                  // ë…¸ë“œ ë„ˆë¹„
                  const getWidth = (n) => {
                    if (n.type === 'center') return 120;
                    if (n.type === 'brand') return 130;
                    if (n.type === 'branch') return 140;
                    return n.isSubtask ? 110 : 130;
                  };
                  
                  // from ë…¸ë“œ ì˜¤ë¥¸ìª½ ë (centerëŠ” ì¤‘ì•™ ì •ë ¬, ë‚˜ë¨¸ì§€ëŠ” ì™¼ìª½ ì •ë ¬)
                  const fromX = fromNode.type === 'center' 
                    ? fromNode.x + getWidth(fromNode) / 2
                    : fromNode.x + getWidth(fromNode);
                  const fromY = fromNode.y;
                  
                  // to ë…¸ë“œ ì™¼ìª½ ë
                  const toX = toNode.x;
                  const toY = toNode.y;
                  
                  // ì§ê° ì—°ê²°ì„ : ì˜¤ë¥¸ìª½ â†’ ìˆ˜ì§ â†’ ì˜¤ë¥¸ìª½
                  const midX = fromX + 25;
                  const pathD = `M ${fromX} ${fromY} H ${midX} V ${toY} H ${toX}`;
                  
                  // ìƒ‰ìƒ
                  const lineColor = toNode.color || '#94A3B8';
                  
                  return (
                    <path
                      key={conn.id}
                      d={pathD}
                      stroke={lineColor}
                      strokeWidth={2}
                      fill="none"
                      opacity={0.6}
                    />
                  );
                })}
              </svg>
              
              {/* ë…¸ë“œë“¤ */}
              {nodes.map(node => (
                <MindMapNode
                  key={node.id}
                  node={node}
                  isSelected={selectedNode === node.id}
                  isEditing={editingNode === node.id}
                  isDragOver={(dragOverNodeId === node.id && draggedProject) || (dropTargetNodeId === node.id)}
                  onClick={() => setSelectedNode(node.id === selectedNode ? null : node.id)}
                  onDoubleClick={() => node.type !== 'center' && setEditingNode(node.id)}
                  onDrag={handleNodeDrag}
                  onDragEnd={() => handleNodeDragEnd(node.id)}
                  onDelete={() => deleteNode(node.id)}
                  onUpdateText={(text) => updateNodeText(node.id, text)}
                  onUpdateKpi={(label, value) => updateNodeKpi(node.id, label, value)}
                  onCancelEdit={() => setEditingNode(null)}
                  onDragOver={() => setDragOverNodeId(node.id)}
                  onDragLeave={() => setDragOverNodeId(null)}
                  onDrop={() => {
                    if (draggedProject && node.type === 'branch' && !node.projectId) {
                      handleDropOnCategory(node.id, draggedProject);
                      setDraggedProject(null);
                      setDragOverNodeId(null);
                    }
                  }}
                  draggingNodeId={draggingNodeId}
                />
              ))}
              
              {/* ë¹ˆ ìƒíƒœ ì•ˆë‚´ */}
              {nodes.length <= 1 && (
                <div style={{ 
                  position: 'absolute', bottom: 40, left: '50%', transform: 'translateX(-50%)',
                  background: 'white', padding: '16px 24px', borderRadius: 12,
                  boxShadow: '0 4px 20px rgba(0,0,0,0.1)', textAlign: 'center'
                }}>
                  <p style={{ fontSize: 14, color: '#6B7684', marginBottom: 8 }}>
                    ğŸ’¡ <strong>ì¹´í…Œê³ ë¦¬ ì¶”ê°€</strong> ë²„íŠ¼ìœ¼ë¡œ ê°€ì§€ë¥¼ ë§Œë“¤ê³ 
                  </p>
                  <p style={{ fontSize: 14, color: '#6B7684' }}>
                    ì™¼ìª½ í”„ë¡œì íŠ¸ë¥¼ <strong>ë“œë˜ê·¸</strong>í•´ì„œ ê°€ì§€ì— ë†“ì•„ë³´ì„¸ìš”!
                  </p>
                </div>
              )}
              </div> {/* ì¤Œ/íŒ¨ë‹ ë‚´ë¶€ ì»¨í…Œì´ë„ˆ ë‹«ê¸° */}
            </div>
          </div>
          
          {/* ì¹´í…Œê³ ë¦¬ ì¶”ê°€ ëª¨ë‹¬ */}
          {showAddBranch && (
            <div onClick={() => setShowAddBranch(false)} style={{ position: 'fixed', inset: 0, background: 'rgba(0,0,0,0.4)', display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 1000 }}>
              <div onClick={(e) => e.stopPropagation()} style={{ background: 'white', borderRadius: 16, padding: 24, width: 360 }}>
                <h3 style={{ fontSize: 18, fontWeight: 700, color: '#191F28', marginBottom: 20 }}>ì¹´í…Œê³ ë¦¬ ì¶”ê°€</h3>
                <input
                  type="text"
                  value={newBranchName}
                  onChange={(e) => setNewBranchName(e.target.value)}
                  placeholder="ì˜ˆ: í™ˆí˜ì´ì§€ ë¦¬ë‰´ì–¼, ë¸”ë¡œê·¸ ì „ëµ..."
                  style={{ width: '100%', padding: '12px 14px', borderRadius: 10, border: '1px solid #E5E8EB', fontSize: 14, marginBottom: 16 }}
                  autoFocus
                  onKeyDown={(e) => e.key === 'Enter' && addBranch()}
                />
                <div style={{ display: 'flex', gap: 12 }}>
                  <button onClick={() => setShowAddBranch(false)} style={{ flex: 1, padding: 12, borderRadius: 10, border: '1px solid #E5E8EB', background: 'white', fontSize: 14, fontWeight: 600, color: '#6B7684', cursor: 'pointer' }}>ì·¨ì†Œ</button>
                  <button onClick={addBranch} style={{ flex: 1, padding: 12, borderRadius: 10, border: 'none', background: '#3182F6', fontSize: 14, fontWeight: 600, color: 'white', cursor: 'pointer' }}>ì¶”ê°€</button>
                </div>
              </div>
            </div>
          )}
        </div>
      );
    }
    
    // ë§ˆì¸ë“œë§µ ë…¸ë“œ ì»´í¬ë„ŒíŠ¸
    function MindMapNode({ node, isSelected, isEditing, isDragOver, onClick, onDoubleClick, onDrag, onDragEnd, onDelete, onUpdateText, onUpdateKpi, onCancelEdit, onDragOver, onDragLeave, onDrop, draggingNodeId }) {
      const [isDragging, setIsDragging] = useState(false);
      const [editText, setEditText] = useState(node.text);
      const [editKpiLabel, setEditKpiLabel] = useState(node.kpiLabel || '');
      const [editKpiValue, setEditKpiValue] = useState(node.kpiValue || '');
      const dragStart = React.useRef({ x: 0, y: 0 });
      
      const handleMouseDown = (e) => {
        if (isEditing || node.type === 'center') return;
        e.preventDefault();
        setIsDragging(true);
        dragStart.current = { x: e.clientX, y: e.clientY };
        
        const handleMouseMove = (e) => {
          const dx = e.clientX - dragStart.current.x;
          const dy = e.clientY - dragStart.current.y;
          dragStart.current = { x: e.clientX, y: e.clientY };
          onDrag(node.id, dx, dy);
        };
        
        const handleMouseUp = (e) => {
          setIsDragging(false);
          onDragEnd();
          window.removeEventListener('mousemove', handleMouseMove);
          window.removeEventListener('mouseup', handleMouseUp);
        };
        
        window.addEventListener('mousemove', handleMouseMove);
        window.addEventListener('mouseup', handleMouseUp);
      };
      
      const handleSave = () => {
        onUpdateText(editText);
        if (node.type === 'branch') {
          onUpdateKpi(editKpiLabel, editKpiValue);
        }
      };
      
      // ë…¸ë“œ ìŠ¤íƒ€ì¼ - EdrawMind ìŠ¤íƒ€ì¼ ê°ì§„ ë„¤ëª¨
      const getNodeStyle = () => {
        const base = {
          position: 'absolute',
          left: node.x,
          top: node.y,
          transform: 'translateY(-50%)', // ì™¼ìª½ ì •ë ¬, Yë§Œ ì¤‘ì•™
          cursor: isDragging ? 'grabbing' : (node.type === 'center' ? 'default' : 'grab'),
          transition: isDragging ? 'none' : 'box-shadow 0.2s',
          zIndex: isDragging ? 100 : 1,
        };
        
        if (node.type === 'center') {
          return {
            ...base,
            transform: 'translate(-50%, -50%)', // ì„¼í„°ë§Œ ì¤‘ì•™ ì •ë ¬
            background: `linear-gradient(135deg, ${node.color}, ${node.color}dd)`,
            color: 'white',
            padding: '14px 24px',
            borderRadius: 8,
            fontSize: 14,
            fontWeight: 700,
            textAlign: 'center',
            boxShadow: isSelected ? `0 0 0 3px ${node.color}50, 0 6px 20px rgba(0,0,0,0.15)` : '0 4px 12px rgba(0,0,0,0.1)',
            whiteSpace: 'nowrap',
          };
        }
        
        if (node.type === 'branch') {
          const brandColor = node.color || '#6B7684';
          return {
            ...base,
            background: isDragOver ? '#EBF4FF' : 'white',
            border: isDragOver ? '2px dashed #3182F6' : `1.5px solid ${isSelected ? brandColor : '#E5E8EB'}`,
            borderLeft: `4px solid ${brandColor}`,
            padding: '10px 14px',
            borderRadius: 4,
            fontSize: 13,
            fontWeight: 600,
            boxShadow: isSelected ? '0 4px 12px rgba(0,0,0,0.1)' : '0 1px 3px rgba(0,0,0,0.05)',
            width: 140,
            whiteSpace: 'nowrap',
            overflow: 'hidden',
            textOverflow: 'ellipsis',
          };
        }
        
        // brand - ë¸Œëœë“œ ë…¸ë“œ ìŠ¤íƒ€ì¼
        if (node.type === 'brand') {
          const brandColor = node.color || '#6B7684';
          return {
            ...base,
            background: `linear-gradient(135deg, ${brandColor}15, ${brandColor}08)`,
            border: `2px solid ${brandColor}`,
            padding: '10px 16px',
            borderRadius: 6,
            fontSize: 13,
            fontWeight: 700,
            color: brandColor,
            boxShadow: isSelected ? `0 0 0 3px ${brandColor}30, 0 4px 12px rgba(0,0,0,0.1)` : '0 2px 6px rgba(0,0,0,0.08)',
            width: 130,
            whiteSpace: 'nowrap',
            overflow: 'hidden',
            textOverflow: 'ellipsis',
          };
        }
        
        // task - ê°ì§„ ìŠ¤íƒ€ì¼
        const isSubtask = node.isSubtask;
        return {
          ...base,
          background: isSubtask ? '#F8FAFC' : '#F0FDF4',
          border: `1px solid ${isSubtask ? '#E2E8F0' : '#BBF7D0'}`,
          borderLeft: `3px solid ${isSubtask ? '#94A3B8' : '#22C55E'}`,
          padding: '7px 12px',
          borderRadius: 3,
          fontSize: isSubtask ? 11 : 12,
          fontWeight: 500,
          color: isSubtask ? '#475569' : '#166534',
          width: isSubtask ? 110 : 130,
          whiteSpace: 'nowrap',
          overflow: 'hidden',
          textOverflow: 'ellipsis',
          boxShadow: isSelected ? '0 2px 8px rgba(0,0,0,0.1)' : 'none',
        };
      };
      
      return (
        <div
          style={getNodeStyle()}
          onMouseDown={handleMouseDown}
          onClick={onClick}
          onDoubleClick={onDoubleClick}
          onDragOver={(e) => { if (node.type === 'branch' && !node.projectId) { e.preventDefault(); onDragOver && onDragOver(); } }}
          onDragLeave={() => onDragLeave && onDragLeave()}
          onDrop={(e) => { e.preventDefault(); onDrop && onDrop(); }}
        >
          {isEditing ? (
            <div onClick={(e) => e.stopPropagation()}>
              <input
                type="text"
                value={editText}
                onChange={(e) => setEditText(e.target.value)}
                style={{ width: '100%', padding: 8, borderRadius: 6, border: '1px solid #3182F6', fontSize: 13, marginBottom: 8 }}
                autoFocus
              />
              {node.type === 'branch' && (
                <div style={{ display: 'flex', gap: 6, marginBottom: 8 }}>
                  <input
                    placeholder="KPI ë¼ë²¨"
                    value={editKpiLabel}
                    onChange={(e) => setEditKpiLabel(e.target.value)}
                    style={{ flex: 1, padding: 6, borderRadius: 6, border: '1px solid #E5E8EB', fontSize: 11 }}
                  />
                  <input
                    placeholder="ëª©í‘œê°’"
                    value={editKpiValue}
                    onChange={(e) => setEditKpiValue(e.target.value)}
                    style={{ width: 60, padding: 6, borderRadius: 6, border: '1px solid #E5E8EB', fontSize: 11 }}
                  />
                </div>
              )}
              <div style={{ display: 'flex', gap: 6 }}>
                <button onClick={onCancelEdit} style={{ flex: 1, padding: 6, borderRadius: 6, border: '1px solid #E5E8EB', background: 'white', fontSize: 11, cursor: 'pointer' }}>ì·¨ì†Œ</button>
                <button onClick={handleSave} style={{ flex: 1, padding: 6, borderRadius: 6, border: 'none', background: '#3182F6', color: 'white', fontSize: 11, cursor: 'pointer' }}>ì €ì¥</button>
              </div>
            </div>
          ) : (
            <>
              <div>{node.text}</div>
              {node.type === 'branch' && node.kpiLabel && (
                <div style={{ marginTop: 8, padding: '6px 10px', background: '#F0FDF4', borderRadius: 6, fontSize: 11, color: '#059669' }}>
                  ğŸ“Š {node.kpiLabel}: {node.kpiValue}
                </div>
              )}
              {isDragOver && node.type !== 'task' && (
                <div style={{ marginTop: 8, fontSize: 11, color: '#3182F6', fontWeight: 600 }}>
                  ğŸ”— ì—¬ê¸°ì— ë†“ìœ¼ì„¸ìš”!
                </div>
              )}
            </>
          )}
          
          {/* ì‚­ì œ ë²„íŠ¼ */}
          {isSelected && node.type !== 'center' && !isEditing && (
            <button
              onClick={(e) => { e.stopPropagation(); onDelete(); }}
              style={{
                position: 'absolute', top: -8, right: -8,
                width: 22, height: 22, borderRadius: '50%',
                background: '#F04452', border: 'none',
                display: 'flex', alignItems: 'center', justifyContent: 'center',
                cursor: 'pointer', boxShadow: '0 2px 6px rgba(0,0,0,0.2)'
              }}
            >
              <Icon name="x" size={12} color="white" />
            </button>
          )}
        </div>
      );
    }

    // ë Œë”ë§
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<TeamWorkApp />);
  </script>
</body>
</html>
